// Generated by CoffeeScript 1.6.3
/*
Mondrian vector editor
http://mondrian.io

This software is available under the MIT License. Have fun with it.
Contact: me@artur.co
*//*

  Built-in prototype extensions
*/(function(){var e,t,n,r,i,s,o,u,f,l,c,h,p,d,v,g,y,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U,z,W,X,V,J,K,Q,G,Y,Z,et,tt,nt,rt,it,st,ot,ut,at,ft,lt,ct,ht,pt,dt,vt,mt,gt,yt,bt,wt,Et,St,xt,Tt,Nt,Ct,kt,Lt,At,Ot,Mt,_t,Dt,Pt,Ht,Bt,jt,Ft,It,qt,Rt,Ut,zt,Wt,Xt,Vt,$t,Jt,Kt,Qt,Gt,Yt,Zt,en,tn,nn,rn,sn,on,un,an,fn,ln={}.hasOwnProperty,cn=function(e,t){function r(){this.constructor=e}for(var n in t)ln.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Math.lerp=function(e,t,n){return t+e*(n-t)},Math.KAPPA=.5522847498307936,String.prototype.toFloat=function(){return parseFloat(this.valueOf().match(/[\d\.]/g).join(""))},String.prototype.mentions=function(e){var t,n,r;if(typeof e=="string")return this.indexOf(e)>-1;if(e instanceof Array){for(n=0,r=e.length;n<r;n++){t=e[n];if(this.mentions(t))return!0}return!1}},SVGAnimatedString.prototype.mentions=function(e){return this.baseVal.mentions(e)},String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},String.prototype.camelCase=function(){return this.split(/[^a-z]/gi).map(function(e,t){return t===0?e:e.capitalize()}).join("")},String.prototype.strip=function(){return this.replace(/(^\s*)|(\s+$)|\n/g,"")},Number.prototype.px=function(){return""+this.toPrecision()+"px"},Number.prototype.invert=function(){return this*-1},Number.prototype.within=function(e,t){var n;return n=this-t,n<e&&n>-e},Number.prototype.roundIfWithin=function(e){return Math.ceil(this)-this<e?Math.ceil(this):this-Math.floor(this)<e?Math.floor(this):this.valueOf()},Number.prototype.ensureRealNumber=function(){var e,t;return t=this.valueOf(),e=t===Infinity||t===-Infinity||isNaN(t),e?1:t},Number.prototype.toNearest=function(e,t){var n,r,i,s;return n=!1,s=this.valueOf(),s<0&&(r=!0,s*=-1),i=s%e,i>e/2&&(i=e-i,n=!0),t!=null&&i>t?s:(i<e/2?n?s+=i:s-=i:n?s-=e-i:s+=e-i,r&&(s*=-1),s)},Array.prototype.remove=function(e){return e instanceof RegExp?this.filter(function(t){return!e.test(t)}):e instanceof Array?this.filter(function(t){return!e.has(t)}):this.filter(function(t){return e!==t})},Array.prototype.has=function(e){return e instanceof Function?this.filter(e).length>0:this.indexOf(e)>-1},Array.prototype.find=function(e){var t,n,r;for(t=n=0,r=this.length;0<=r?n<=r:n>=r;t=0<=r?++n:--n)if(e(this[t]))return this[t]},Array.prototype.ensure=function(e){if(this.indexOf(e)===-1)return this.push(e)},Array.prototype.first=function(){return this[0]},Array.prototype.last=function(){return this[this.length-1]},Array.prototype.sortByZIndex=function(){return this.sort(function(e,t){return e.zIndex()<t.zIndex()?-1:1})},Array.prototype.replace=function(e,t){var n;return n=this.indexOf(e),n===-1?this:this.slice(0,n).concat(t instanceof Array?t:[t]).concat(this.slice(n+1))},Array.prototype.cannibalize=function(){return this.push(this[0]),this.slice(1)},Array.prototype.cannibalizeUntil=function(e){var t,n;return n=this.indexOf(e),t=this.splice(n),t.concat(this)},Array.prototype.without=function(e){return this.filter(function(t){return t!==e})},Element.prototype.remove=function(){if(this.parentElement!==null)return this.parentElement.removeChild(this)},Element.prototype.removeChildren=function(){var e;e=[];while(this.childNodes.length>0)e.push(this.childNodes[0].remove());return e},Element.prototype.toString=function(){return new XMLSerializer.serializeToString(this)},Number.prototype.places=function(e){return parseFloat(this.toFixed(e))},rt=function(e){function t(e){var n,r,i;for(r=0,i=e.length;r<i;r++)n=e[r],this.has(n)||this.push(n);t.__super__.constructor.apply(this,arguments)}return cn(t,e),t.prototype.push=function(e){if(this.has(e))return;return t.__super__.push.call(this,e)},t}(Array),window.Set=rt,Z={},Z.PRODUCTION=/mondrian/.test(document.location.host),Z.MEOWSET={AVAILABLE:!0,ENDPOINT:Z.PRODUCTION?"http://meowset.mondrian.io":"http://localhost:8000"},Z.BONITA={ENDPOINT:Z.PRODUCTION?"http://bonita.mondrian.io":"http://localhost:8080"},Z.EMBED={AVAILABLE:!0,ENDPOINT:Z.PRODUCTION?"http://embed.mondrian.io":"http://localhost:8000"},Z.MATH={POINT_DECIMAL_PLACES:5,POINT_ROUND_DGAF:1e-5},Z.DOUBLE_CLICK_THRESHOLD=600,s={MATCHERS:{POINT:/[MLCSHV][\-\de\.\,\-\s]+/gi},SVG_NAMESPACE:"http://www.w3.org/2000/svg"},Et=!1,nn=[],tn=[],$(document).ajaxSend(function(){return ui.logo.animate()}),$(document).ajaxComplete(function(){return ui.logo.stopAnimating()}),$(document).ready(function(){var e,t,n,r,i;for(t=0,r=nn.length;t<r;t++)e=nn[t],e();Et=!0;for(n=0,i=tn.length;n<i;n++)e=tn[n],e();return setTimeout(function(){return window.scrollTo(0,0)},500)}),Qt=function(){return console.log.apply(console,arguments)},St=function(e){return setTimeout(e,1)},Gt=function(e){return document.querySelector.call(document,e)},Yt=function(e){return document.querySelectorAll.call(document,e)},window.uuid=function(e){var t,n,r,i;e==null&&(e=20),r="",t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890".split("");for(n=i=1;1<=e?i<=e:i>=e;n=1<=e?++i:--i)r+=t[parseInt(Math.random()*62,10)];return r},Ft=function(e){return e.namespaceURI==="http://www.w3.org/2000/svg"},It=function(e){return e.namespaceURI==="http://www.w3.org/2000/svg"&&$(e).closest("#main").length>0&&e.id!=="main"},jt=function(e){return e.className==="transform handle point"},_t=function(e){return e.className==="transform handle point bz-ctrl"},Ut=function(e){return e.className.mentions("transform handle")},Ht=function(e){var t;return((t=e.parentNode)!=null?t.id:void 0)==="hover-targets"},Pt=function(e){return e.nodeName.toLowerCase()==="div"?e.className.mentions("handle"):!1},Rt=function(e){return e.nodeName.toLowerCase()==="input"&&e.getAttribute("type")==="text"},zt=function(e){return e.className.mentions("utility-window")||$(e).closest(".utility-window").length>0},qt=function(e){return e.className.mentions("swatch")},Bt=function(e){var t;if(typeof e.className=="string"){t=e.className.split(" ");if(t.has("disabled"))return!1;if(t.has("tool-button"))return"tb";if(t.has("menu"))return"menu";if(t.has("menu-item"))return"menu-item";if(t.has("menu-dropdown"))return"dui"}return e.hasAttribute("buttontext")?!0:e.nodeName.toLowerCase()==="a"?!0:e.id==="hd-file-loader"?"file-loader":Rt(e)?"text-input":zt(e)?"utility-window":qt(e)?"swatch":!1},bt=function(e){return $(e).closest("[h]").length>0},Dt=function(e){return e.hasAttribute("quarantine")?!0:$(e).closest("[quarantine]").length>0?!0:!1},Zt=function(e){return ui.queryElement(Gt('#main [uuid="'+e+'"]'))},en=function(e){return ui.queryElement(Ct.$main.children()[e])},xt=function(e){return e=e.roundIfWithin(Z.MATH.POINT_ROUND_DGAF),e=e.places(Z.MATH.POINT_DECIMAL_PLACES),e},Ot=function(e){return parseInt(e,10)},kt=function(e){return parseFloat(e)},Jt=Object.prototype.toString,Object.prototype.toString=function(){var e;if(this instanceof $)return"$('"+this.selector+"') object";try{return JSON.stringify(this)}catch(t){return e=t,Jt.call(this)}},$t=function(e){var t,n,r;r=[];for(t in e){if(!ln.call(e,t))continue;n=e[t],r.push(n)}return r},Tt=function(e){var t,n,r;n=new Object;for(t in e){if(!ln.call(e,t))continue;r=e[t],n[t]=r}return n},rn=function(e,t){if(e<t)return-1;if(e>t)return 1;if(e===t)return 0},$.fn.hotkeys=function(e){var t;return t=this,$(this).attr("h","").focus(function(){return ui.hotkeys.enable(),ui.hotkeys.using={context:t,ignoreAllOthers:!1,down:e.down,up:e.up,always:e.always}}).blur(function(){})},$.fn.nudge=function(e,t,n,r){var i,s,o,u;return n==null&&(n={x:-1/0,y:-1/0}),r==null&&(r={x:1/0,y:1/0}),i=$(this),s=i.css("left"),u=i.css("top"),i.attr("drag-x")&&(o=i.attr("drag-x").split(" ").map(function(e){return parseInt(e,10)}),n.x=o[0],r.x=o[1]),i.attr("drag-y")&&(o=i.attr("drag-y").split(" ").map(function(e){return parseInt(e,10)}),n.y=o[0],r.y=o[1]),i.css({left:Math.max(n.x,Math.min(r.x,parseFloat(s)+e)).px(),top:Math.max(n.y,Math.min(r.y,parseFloat(u)+t)).px()}),i.trigger("nudge")},$.fn.fitToVal=function(e){var t,n;return e==null&&(e=0),t=$(this),n=function(n){var r,i;return i=t.val(),r=$('<div id="ghost">'+i+"</div>").appendTo(Ct.$body),t.css({width:""+(r.width()+e)+"px"}),r.remove()},t.unbind("keyup.fitToVal").on("keyup.fitToVal",n),n()},$.fn.disable=function(){var e;return e=$(this),e.attr("disabled","")},$.fn.enable=function(){var e;return e=$(this),e.removeAttr("disabled")},$.fn.error=function(e){var t,n;return n=$(this),t=n.siblings(".error-display").show(),t.find(".lifespan").removeClass("empty"),t.find(".msg").text(e),St(function(){return t.find(".lifespan").addClass("empty")}),setTimeout(function(){return t.hide()},5e3)},$.fn.pending=function(e){var t,n;return t=$(this),n=t.html(),t.addClass("pending"),t.html(e),function(){return t.html(n),t.removeClass("pending")}},sn=function(e,t,n){var r;r=""+ui.account,n!=null&&(r+=": "+n);if(Z.PRODUCTION)return _gaq.push(["_trackEvent",e,t,r])},Xt={},Xt.events={_handlers:{},on:function(e,t){var n;return(n=this._handlers)[e]==null&&(n[e]=[]),this._handlers[e].push(t)},off:function(e){return delete this._handlers[e]},trigger:function(){var e;return(e=this._handlers[arguments[0]])!=null?e.forEach(function(e){var t;return t=Array.prototype.slice.call(arguments,1),e.apply(this,t)}):void 0}},Mt={parse:function(e,t){var n,r,s,o,u;return t==null&&(t=!0),n=this.findSVGRoot(e),o=n[0],r=this.getBounds(n),r.width==null&&(r.width=1e3),r.height==null&&(r.height=1e3),t&&ui["new"](r.width,r.height),s=this.recParse(n),u=o.getAttribute("viewBox"),u&&(u=u.split(" "),u=new i(u[0],u[1],u[2],u[3])),s},getBounds:function(e){var t,n,r,s,o;return t=this.findSVGRoot(e),r=t[0],o=r.getAttribute("width"),n=r.getAttribute("height"),s=r.getAttribute("viewBox"),o==null&&(s!=null?o=s.split(" ")[2]:(console.warn("No width, defaulting to 1000"),o=1e3)),n==null&&(s!=null?n=s.split(" ")[3]:(console.warn("No height, defaulting to 1000"),n=1e3)),o=parseFloat(o),n=parseFloat(n),isNaN(o)&&(console.warn("Width is NaN, defaulting to 1000"),o=1e3),isNaN(n)&&(console.warn("Width is NaN, defaulting to 1000"),n=1e3),new i(0,0,parseFloat(o),parseFloat(n))},recParse:function(e){var t,n,r,i,s,o,u,a,f;o=[],f=e.children();for(u=0,a=f.length;u<a;u++){t=f[u];if(t.nodeName==="defs")continue;if(t.nodeName==="g")s=this.recParse($(t)),o=o.concat(s),console.warn("Group element not implemented yet. Ungrouping "+s.length+" elements.");else{i=this.parseElement(t);if(i===!1)continue;i instanceof P?o.push(i):i instanceof Object&&i["xlink:href"]!=null&&(i.reference=!0,o.push(i))}}return r=o.filter(function(e){return e instanceof P}),o},findSVGRoot:function(e){var t;if(e instanceof Array)return e[0].$rep.closest("svg");if(e instanceof $){e=e.filter("svg");if(e.is("svg"))return e;t=e.find("svg");if(t.length===0)throw new Error("io: No svg node found.");return t[0]}return this.findSVGRoot($(e))},parseElement:function(e){var t,n,r,i,s,o,u,a,f,l,c;i={path:F,text:at},c={rect:G,ellipse:y,polygon:W,polyline:X},e instanceof $&&(t=e,e=e[0]),r=e.attributes,a=null;for(o in r){if(!ln.call(r,o))continue;n=r[o],n.name==="transform"&&(a=n.value)}return s=this.makeData(e),f=e.nodeName.toLowerCase(),i[f]!=null||c[f]!=null?(u=null,i[f]!=null?(u=new(i[e.nodeName.toLowerCase()])(s),f==="text"&&u.setContent(e.textContent)):c[f]!=null&&(l=new(c[e.nodeName.toLowerCase()])(s),u=l.convertToPath(),u.virgin=l),a&&e.nodeName.toLowerCase()!=="text"&&(u.carryOutTransformations(a),delete u.data.transform,u.rep.removeAttribute("transform"),u.commit()),u):f==="use"?!1:null},makeData:function(e){var t,n,r,i,s,o;n=["inkscape","sodipodi","uuid"],r=function(e){var t,r,i;for(r=0,i=n.length;r<i;r++){t=n[r];if(e.indexOf(t)>-1)return!1}return!0},t=e.attributes,i={};for(s in t){o=t[s],s=o.name,o=o.value;if(s==="")continue;s==="style"&&e.nodeName!=="text"?i=this.applyStyles(i,o):o!=null&&r(s)&&(/^\d+$/.test(o)&&(o=kt(o)),i[s]=o)}return i},applyStyles:function(e,t){var n,r,i,s,o,u;n=["display","transform"],t=t.split(";");for(o=0,u=t.length;o<u;o++){i=t[o],i=i.split(":"),r=i[0],s=i[1];if(n.has(r))continue;e[r]=s}return e},parseAndAppend:function(e,t){var n;return n=this.parse(e,t),n.map(function(e){return e.appendTo("#main")}),ui.refreshAfterZoom(),n},prepareForExport:function(){var e,t,n,r,i;r=ui.elements,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],e.type==="path"&&e.virgin!=null&&e.virginMode(),i.push(typeof e.cleanUpPoints=="function"?e.cleanUpPoints():void 0);return i},cleanUpAfterExport:function(){var e,t,n,r,i;r=ui.elements,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],e.type==="path"?e.virgin!=null?i.push(e.editMode()):i.push(void 0):i.push(void 0);return i},makeFile:function(){var e,t,n,r,i;this.prepareForExport(),n=(new XMLSerializer).serializeToString(Ct.main),this.cleanUpAfterExport(),n=n.replace(/>/gi,">\n"),t=["uuid"];for(r=0,i=t.length;r<i;r++)e=t[r],n=n.replace(new RegExp(e+'\\=\\"[\\d\\w]*\\"',"gi"),"");return"<!-- Made in Mondrian.io -->\n"+n},makeBase64:function(){return btoa(this.makeFile())},makeBase64URI:function(){return"data:image/svg+xml;charset=utf-8;base64,"+this.makeBase64()},makePNGURI:function(e,t){var n,r,i,s,o,u,a;e==null&&(e=ui.elements),t==null&&(t=void 0),o=Ct.pngSandbox,r=o.getContext("2d"),e.length?n=this.getBounds(e):n=this.getBounds(Ct.main),o.setAttribute("width",n.width),o.setAttribute("height",n.height),t!=null&&(s=Math.max(r.canvas.width,r.canvas.height)/t,r.canvas.width/=s,r.canvas.height/=s,r.scale(1/s,1/s)),typeof e=="string"&&(e=this.parse(e,!1));for(u=0,a=e.length;u<a;u++)i=e[u],i.drawToCanvas(r);return o.toDataURL("png")}},window.io=Mt,et=function(){function e(e){this._ensureDoc(e),this._svgRoot==null&&(this._svgRoot=this.doc.querySelector("svg"));if(this._svgRoot==null)throw new Error("No svg element found");this._buildMetadata(),this.elements==null&&this._buildElements(),this._assignMondrianNamespace()}return e.prototype._ensureDoc=function(e){var t=this;if(typeof e=="string")return this.doc=(new DOMParser).parseFromString(e,this.MIMETYPE);if(e.documentURI!=null)return this.doc=e;if(e instanceof Array)return this.elements=e,this.doc=document.implementation.createDocument(s.SVG_NAMESPACE,"svg"),this.doc.removeChild(this.doc.childNodes[0]),this._svgRoot=this.doc.createElementNS(s.SVG_NAMESPACE,"svg"),this.doc.appendChild(this._svgRoot),this.elements.forEach(function(e){return t._svgRoot.appendChild(e.rep)}),this._deriveBoundsFromElements();throw new Error("Bad input")},e.prototype._buildMetadata=function(){this.metadata={},this.metadata.width=parseInt(this._svgAttr("width",10)),this.metadata.height=parseInt(this._svgAttr("height",10));if(this._bounds==null)return this._bounds=new i(0,0,this.metadata.width,this.metadata.height)},e.prototype._buildElements=function(){return this.elements=Mt.parse(this.toString(),!1)},e.prototype._assignMondrianNamespace=function(){return this._svgRoot.setAttribute("xmlns:mondrian","http://mondrian.io/xml")},e.prototype._deriveBoundsFromElements=function(){var e,t;return this._bounds=this._elementsBounds(),t=this._bounds.width+this._bounds.x,e=this._bounds.height+this._bounds.y,this._applyBounds()},e.prototype._applyBounds=function(){return this._svgRoot.setAttribute("width",this._bounds.width),this._svgRoot.setAttribute("height",this._bounds.height)},e.prototype._elementsBounds=function(){return new i(this.elements.map(function(e){return e.bounds()}))},e.prototype.trim=function(){var e;return this._normalizeRotations(),e=this._elementsBounds(),this.elements.forEach(function(t){return t.nudge(e.x.invert(),e.y)}),this._bounds.width=e.width,this._bounds.height=e.height,this._applyBounds()},e.prototype._normalizeRotations=function(){var e,t=this;return e=ui.transformer.angle,this.elements.forEach(function(n){return n.rotate(360-e,t.center())})},e.prototype._svgAttr=function(e){return this._svgRoot.getAttribute(e)},e.prototype.toString=function(){return(new XMLSerializer).serializeToString(this.doc)},e.prototype.toBase64=function(){return"data:"+this.MIMETYPE+";charset="+this.CHARSET+";base64,"+this.toString()},e.prototype.appendTo=function(e){return Gt(e).appendChild(this._svgRoot)},e.prototype.center=function(){return new J(this.metadata.width/2,this.metadata.height/2)},e.prototype.MIMETYPE="image/svg+xml",e.prototype.CHARSET="utf-8",e}(),j=function(){function e(e){this._parseInput(e),this._buildRep()}return e.prototype.maxDimension=function(e){var t,n,r,i;return r=this.context(),i=Math.max(this.width,this.height)/e,this.setDimensions(this.width/i,this.height/i),t=this.svg._bounds,n=Math.max(t.width,t.height)/e,r.scale(1/n,1/n),this},e.prototype["export"]=function(){return atob(this.exportAsBase64())},e.prototype.exportAsBase64=function(){return this.exportAsDataURI().replace(/^.*\,/,"")},e.prototype.exportAsDataURI=function(){return this._draw(),this.rep.toDataURL("png")},e.prototype.destroy=function(){return this.elements=null,this.rep.remove(),this.rep=null,this},e.prototype.clear=function(){return this.context().clearRect(0,0,this.width,this.height)},e._setScale=function(e,t){return this.context().scale(e/this._contextScaleX,t/this._contextScaleY),this._contextScaleX=e,this._contextScaleY=t},e.prototype._draw=function(){var e,t=this;return this.clear(),e=this.context(),this.elements.forEach(function(t){return t.drawToCanvas(e)})},e.prototype._parseInput=function(e){if(typeof e=="string")return this.svg=new et(e),this.elements=this.svg.elements;if(e instanceof et)return this.svg=e,this.elements=this.svg.elements;if(e instanceof Array)return this.elements=e,this.svg=new et(this.elements)},e.prototype._buildRep=function(){return this.rep=document.createElement("canvas"),this.rep.classList.add("offscreen-throwaway"),this.setDimensions(this.svg.metadata.width,this.svg.metadata.height),this._contextScaleX=1,this._contextScaleY=1,Gt("body").appendChild(this.rep)},e.prototype.attr=function(e,t){return this.rep.setAttribute(e,t)},e.prototype.setDimensions=function(e,t){return this.width=e,this.height=t,this.attr("width",this.width),this.attr("height",this.height)},e.prototype.context=function(){return this._context!=null?this._context:this._context=this.rep.getContext("2d")},e}(),x=function(){function e(e){this.name=e}return e.prototype.toListItem=function(){return $('<div class="dropdown-item" style="font-family: \''+this.name+"'\">\n  "+this.name+"\n</div>")},e}(),u=function(){function e(t,n,r,i){var s,o;this.r=t,this.g=n,this.b=r,this.a=i!=null?i:1;if(this.r instanceof e)return this.r;this.r===null?this.hex="none":this.r==="none"?(this.hex="none",this.r=null,this.g=null,this.b=null):(typeof this.r=="string"?this.r.charAt(0)==="#"||this.r.length===6?(this.hex=this.r.toUpperCase().replace("#",""),s=this.hexToRGB(this.hex),this.r=s.r,this.g=s.g,this.b=s.b):this.r.match(/rgba?\(.*\)/gi)!=null&&(o=this.r.match(/[\d\.]+/gi),this.r=o[0],this.g=o[1],this.b=o[2],o[3]!=null&&(this.a=parseFloat(o[3])),this.hex=this.rgbToHex(this.r,this.g,this.b)):(this.g==null&&this.b==null&&(this.g=this.r,this.b=this.r),this.hex=this.rgbToHex(this.r,this.g,this.b)),this.r=Math.min(this.r,255),this.g=Math.min(this.g,255),this.b=Math.min(this.b,255),this.r=Math.max(this.r,0),this.g=Math.max(this.g,0),this.b=Math.max(this.b,0));if(isNaN(this.r||isNaN(this.g||isNaN(this.b)))){isNaN(this.r)&&(this.r=0),isNaN(this.g)&&(this.g=0),isNaN(this.b)&&(this.b=0);debugger;this.updateHex()}}return e.prototype.clone=function(){return new e(this.r,this.g,this.b)},e.prototype.absorb=function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this.hex=e.hex,typeof this.refresh=="function"&&this.refresh(),this},e.prototype.min=function(){return[this.r,this.g,this.b].sort(function(e,t){return e-t})[0]},e.prototype.mid=function(){return[this.r,this.g,this.b].sort(function(e,t){return e-t})[1]},e.prototype.max=function(){return[this.r,this.g,this.b].sort(function(e,t){return e-t})[2]},e.prototype.midpoint=function(){return this.max()/2},e.prototype.valToHex=function(e){var t;return t="0123456789ABCDEF",t.charAt((e-e%16)/16)+t.charAt(e%16)},e.prototype.hexToVal=function(e){var t;return t="0123456789ABCDEF",t.indexOf(e.charAt(0))*16+t.indexOf(e.charAt(1))},e.prototype.rgbToHex=function(e,t,n){return""+this.valToHex(e)+this.valToHex(t)+this.valToHex(n)},e.prototype.hexToRGB=function(e){var t,n,r;return r=this.hexToVal(e.substring(0,2)),n=this.hexToVal(e.substring(2,4)),t=this.hexToVal(e.substring(4,6)),{r:r,g:n,b:t}},e.prototype.recalculateHex=function(){return this.hex=this.rgbToHex(this.r,this.g,this.b)},e.prototype.darken=function(t){var n;return n=function(e){return e/t},new e(n(this.r),n(this.g),n(this.b))},e.prototype.lightness=function(){return(this.min()+this.max())/2/255},e.prototype.saturation=function(){var e,t,n,r;return t=this.max(),n=this.min(),e=t-n,r=this.lightness()>=.5?e/(510-t-n):e/(t+n),isNaN(r)&&(r=1),r},e.prototype.desaturate=function(e){var t;return e==null&&(e=1),t=this.midpoint(),this.r-=(this.r-t)*e,this.g-=(this.g-t)*e,this.b-=(this.b-t)*e,this.hex=this.rgbToHex(this.r,this.g,this.b),this},e.prototype.lighten=function(e){return e==null&&(e=.5),e*=255,this.r=Math.min(255,this.r+e),this.g=Math.min(255,this.g+e),this.b=Math.min(255,this.b+e),this.hex=this.rgbToHex(this.r,this.g,this.b),this},e.prototype.toRGBString=function(){return this.r===null?"none":"rgba("+this.r+", "+this.g+", "+this.b+", "+this.a+")"},e.prototype.toHexString=function(){return"#"+this.hex},e.prototype.toString=function(){return this.removeNaNs(),this.toRGBString()},e.prototype.removeNaNs=function(){isNaN(this.r)&&(this.r=0),isNaN(this.g)&&(this.g=0);if(isNaN(this.b))return this.b=0},e.prototype.equal=function(e){return this.toHexString()===e.toHexString()},e.prototype.updateHex=function(){return this.hex=this.rgbToHex(this.r,this.g,this.b)},e}(),window.Color=u,Wt={},Wt.analysis={intersections:function(e,t){return e.lineSegmentIntersections(t)}},Wt.conversions={pathSegment:function(e,t){t==null&&(t=e.succ);if(t instanceof A||t instanceof H||t instanceof N||t instanceof gt)return new L(new J(e.x,e.y),new J(t.x,t.y),t);if(t instanceof h)return new l(new J(e.x,e.y),new J(t.x2,t.y2),new J(t.x3,t.y3),new J(t.x,t.y),t);if(t instanceof st)return new l(new J(e.x,e.y),new J(t.x2,t.y2),new J(t.x3,t.y3),new J(t.x,t.y),t)},nextSubstantialPathSegment:function(e){while(e.within(1e-6,e.succ))e=e.succ;return this.pathSegment(e,e.succ)},previousSubstantialPathSegment:function(e){while(e.within(1e-6,e.prec))e=e.prec;return this.pathSegment(e,e.prec)},stringToAlop:function(e,t){var n,r,i,o,u,a,f;u=[],o=void 0,n=e.match(s.MATCHERS.POINT);for(a=0,f=n.length;a<f;a++)i=n[a],r=new q(i,t,o),r instanceof q?(o!=null&&r.setPrec(o),o=r,r instanceof st&&t instanceof q&&r.setPrec(t),u.push(r)):r instanceof Array&&(o!=null&&(r[0].setPrec(o),r.reduce(function(e,t){return t.setPrec(e)})),u=u.concat(r));return u}},ht=function(){function e(e,t){var n,r=this;this.owner=e,this.transformations=t,n=this.owner.rep.getAttribute("transform"),this.transformations.map(function(e){return e.family=r}),n!=null&&this.parseExisting(n)}return e.prototype.commit=function(){return this.owner.data.transform=this.toAttr()},e.prototype.toAttr=function(){return this.transformations.map(function(e){return e.toAttr()}).join(" ")},e.prototype.toCSS=function(){return this.transformations.map(function(e){return e.toCSS()}).join(" ")},e.prototype.get=function(e){var t;t=this.transformations.filter(function(t){return t.key===e});if(t.length>0)return t[0]},e.prototype.parseExisting=function(e){var t,n,r,i,s,o,u,a,f;s=e.match(/\w+\([^\)]*\)/g),f=[];for(u=0,a=s.length;u<a;u++)i=s[u],n=i.match(/^\w+/g)[0],t=this.get(n),t!=null?f.push(t.parse(i)):(o={rotate:Y,scale:tt}[n],o!=null?(r=(new o).parse(i),r.family=this,f.push(this.transformations.push(r))):f.push(void 0));return f},e.prototype.applyAsCSS=function(e){var t,n;return t="-"+this.owner.origin.x+" -"+this.owner.origin.y,n=this.toCSS(),e.style.transformOrigin=t,e.style.webkitTransformOrigin=t,e.style.mozTransformOrigin=t,e.style.transform=n,e.style.webkitTransformOrigin=t,e.style.webkitTransform=n,e.style.mozTransformOrigin=t,e.style.mozTransform=n},e}(),Y=function(){function e(e,t){this.deg=e,this.family=t}return e.prototype.key="rotate",e.prototype.toAttr=function(){return"rotate("+this.deg.places(3)+" "+this.family.owner.center().x.places(3)+" "+this.family.owner.center().y.places(3)+")"},e.prototype.toCSS=function(){return"rotate("+this.deg.places(3)+"deg)"},e.prototype.rotate=function(e){return this.deg+=e,this.deg%=360,this},e.prototype.parse=function(e){var t,n,r;return r=e.match(/[\d\.]+/g).map(parseFloat),this.deg=r[0],t=r[1],n=r[2],r},e}(),tt=function(){function e(e,t){this.x=e!=null?e:1,this.y=t!=null?t:1}return e.prototype.key="scale",e.prototype.toAttr=function(){return"scale("+this.x+" "+this.y+")"},e.prototype.toCSS=function(){return"scale("+this.x+", "+this.y+")"},e.prototype.parse=function(e){var t;return t=e.match(/[\d\.]+/g).map(parseFloat),this.x=t[0],this.y=t[1],t},e.prototype.scale=function(e,t){return e==null&&(e=1),t==null&&(t=1),this.x*=e,this.y*=t},e}(),pt=function(){function e(e,t){this.x=e!=null?e:0,this.y=t!=null?t:1}return e.prototype.key="translate",e.prototype.toAttr=function(){return"translate("+this.x+" "+this.y+")"},e.prototype.toCSS=function(){return"translate("+this.x+"px, "+this.y+"px)"},e.prototype.parse=function(e){var t;return t=e.match(/[\-\d\.]+/g).map(parseFloat),this.x=t[0],this.y=t[1],t},e.prototype.nudge=function(e,t){return console.log(e,t),this.x+=e,this.y-=t},e}(),J=function(){function e(e,t,n){var r;this.x=e,this.y=t,this.zoomLevel=n!=null?n:1,this.x instanceof Object?this.x.clientX!=null&&this.x.clientY!=null?(this.y=this.x.clientY,this.x=this.x.clientX):this.x.left!=null&&this.x.top!=null?(this.y=this.x.top,this.x=this.x.left):this.x.x!=null&&this.x.y!=null&&(this.y=this.x.y,this.x=this.x.x):typeof this.x=="string"&&this.x.mentions(",")&&(r=this.x.split(",").map(parseFloat),e=r[0],t=r[1],this.x=e,this.y=t),this}return e.prototype.cleanUp=function(){return},e.prototype.zoomed=function(e){return e==null&&(e=ui.canvas.zoom),this.zoomLevel===e?this:(this.unzoomed(),this.alterValues(function(t){return t*=e}),this.zoomLevel=e,this)},e.prototype.unzoomed=function(){var e=this;if(this.zoomLevel===1)return;return this.alterValues(function(t){return t/=e.zoomLevel}),this.zoomLevel=1,this},e.prototype.setZoom=function(e){return this.zoomLevel=e,this.x/=this.zoomLevel,this.y/=this.zoomLevel,this},e.prototype.zoomedc=function(){return this.clone().zoomed()},e.prototype.unzoomedc=function(){return this.clone.unzoomed()},e.prototype.alterValues=function(e){var t,n,r,i;i=["x","y","x2","y2","x3","y3"];for(n=0,r=i.length;n<r;n++)t=i[n],this[t]=this[t]!=null?e(this[t]):this[t];return this},e.prototype.toString=function(){return""+this.x+","+this.y},e.prototype.toJSON=function(){return{x:this.x,y:this.y}},e.prototype.toConstructorString=function(){return"new Posn("+this.x+","+this.y+")"},e.prototype.nudge=function(e,t){return this.x+=e,this.y-=t,this},e.prototype.lerp=function(t,n){return new e(this.x+(t.x-this.x)*n,this.y+(t.y-this.y)*n)},e.prototype.gte=function(e){return this.x>=e.x&&this.y>=e.y},e.prototype.lte=function(e){return this.x<=e.x&&this.y<=e.y},e.prototype.directionRelativeTo=function(e){return""+(this.y<e.y?"t":this.y>e.y?"b":"")+(this.x<e.x?"l":this.x>e.x?"r":"")},e.prototype.squareUpAgainst=function(e){var t,n,r;n=Math.abs(this.x-e.x),r=Math.abs(this.y-e.y),t=this.directionRelativeTo(e);if(n===0&&r===0)return e;switch(t){case"tl":n<r?this.nudge(n-r,0):r<n&&this.nudge(0,n-r,0);break;case"tr":n<r?this.nudge(r-n,0):r<n&&this.nudge(0,n-r);break;case"br":n<r?this.nudge(r-n,0):r<n&&this.nudge(0,r-n);break;case"bl":n<r?this.nudge(n-r,0):r<n&&this.nudge(0,r-n);break;case"t":case"b":this.nudge(r,0);break;case"r":case"l":this.nudge(0,n)}return this},e.prototype.equal=function(e){return this.x===e.x&&this.y===e.y},e.prototype.min=function(t){return new e(Math.min(this.x,t.x),Math.min(this.y,t.y))},e.prototype.max=function(t){return new e(Math.max(this.x,t.x),Math.max(this.y,t.y))},e.prototype.angle360=function(e){var t;return t=90-(new L(e,this)).angle,t+(this.x<e.x?180:0)},e.prototype.rotate=function(t,n){var r,i;return n==null&&(n=new e(0,0)),n.equal(this)?this:(t*=Math.PI/180,this.x-=n.x,this.y-=n.y,r=this.x*Math.cos(t)-this.y*Math.sin(t),i=this.x*Math.sin(t)+this.y*Math.cos(t),this.x=r+n.x,this.y=i+n.y,this)},e.prototype.scale=function(t,n,r){return r==null&&(r=new e(0,0)),this.x+=(this.x-r.x)*(t-1),this.y+=(this.y-r.y)*(n-1),this},e.prototype.copy=function(e){return this.x=e.x,this.y=e.y},e.prototype.clone=function(){return new e(this.x,this.y,this.zoomLevel)},e.prototype.snap=function(e,t){var n;return t==null&&(t=Math.INFINITY),n=this.verti(1e4),n.rotate(e.angle360()+90,this),n.intersection(e)},e.prototype.reflect=function(t){var n,r;return n=t.x,r=t.y,new e(n+(n-this.x),r+(r-this.y))},e.prototype.distanceFrom=function(e){return(new L(this,e)).length},e.prototype.perpendicularDistanceFrom=function(e){var t,n,r;return r=this.verti(1e5),r.rotate(e.angle360()+90,this),t=r.intersection(e),t!=null?(e=new L(this,t),n=e.length,[n,t,e]):null},e.prototype.multiplyBy=function(e){var t;switch(typeof e){case"number":return t=this.clone(),t.x*=e,t.y*=e,t;case"object":return t=this.clone(),t.x*=e.x,t.y*=e.y,t}},e.prototype.multiplyByMutable=function(e){this.x*=e,this.y*=e,this.x2!=null&&(this.x2*=e,this.y2*=e);if(this.x3!=null)return this.x3*=e,this.y3*=e},e.prototype.add=function(t){switch(typeof t){case"number":return new e(this.x+t,this.y+t);case"object":return new e(this.x+t.x,this.y+t.y)}},e.prototype.subtract=function(t){switch(typeof t){case"number":return new e(this.x-t,this.y-t);case"object":return new e(this.x-t.x,this.y-t.y)}},e.prototype.setPrec=function(e){this.prec=e},e.prototype.setSucc=function(e){this.succ=e},e.prototype.inRanges=function(e,t){return e.contains(this.x&&t.contains(this.y))},e.prototype.inRangesInclusive=function(e,t){return e.containsInclusive(this.x)&&t.containsInclusive(this.y)},e.prototype.verti=function(e){return new L(this.clone().nudge(0,-e),this.clone().nudge(0,e))},e.prototype.insideOf=function(t){var n,r;if(t instanceof W||t instanceof F)return r=new L(this,new e(this.x+1e20,this.y)),n=0,t.lineSegments().map(function(t){var i;i=t.intersection(r);if(i instanceof e)return++n;if(i instanceof Array)return n+=i.length}),n%2===1;if(t instanceof G)return t.contains(this)},e.prototype.dot=function(e){return this.x*e.x+this.y*e.y},e.prototype.within=function(e,t){return Math.abs(this.x-t.x)<e&&Math.abs(this.y-t.y)<e},e.prototype.parseInt=function(){return this.x=parseInt(this.x,10),this.y=parseInt(this.y,10)},e}(),J.fromJSON=function(e){return new J(e.x,e.y)},q=function(n){function r(e,t,n){var i,s;this.x=e,this.y=t,this.owner=n,this.constructArgs=arguments;if(this.x==null&&this.y==null)return;if(this.x instanceof J)this.owner=this.y,this.y=this.x.y,this.x=this.x.x;else if(this.x instanceof Object)this.owner=this.y,this.x.clientX!=null?(this.y=this.x.clientY,this.x=this.x.clientX):this.x.x!=null&&this.x.y!=null&&(this.y=this.x.y,this.x=this.x.x);else if(typeof this.x=="string")return this.owner!=null&&(s=this.owner),this.y!=null&&(this.owner=this.y),i=this.fromString(this.x,s),i;isNaN(this.x)&&console.warn("NaN x"),isNaN(this.y)&&console.warn("NaN y"),this._flags=[],this.makeAntlers(),r.__super__.constructor.call(this,this.x,this.y)}return cn(r,n),r.prototype.fromString=function(e,t){var n,r,i,s,o,u,a,f,l,c,p,d,v,m,g,y,b,w,E;p={moveTo:/M[^A-Za-z]+/gi,lineTo:/L[^A-Za-z]+/gi,curveTo:/C[^A-Za-z]+/gi,smoothTo:/S[^A-Za-z]+/gi,horizTo:/H[^A-Za-z]+/gi,vertiTo:/V[^A-Za-z]+/gi},n={moveTo:H,lineTo:A,curveTo:h,smoothTo:st,horizTo:N,vertiTo:gt},f={moveTo:2,lineTo:2,curveTo:6,smoothTo:4,horizTo:1,vertiTo:1},c=/[-+]?\d*\.?\d*(e\-)?\d*/g,d=[];for(a in p){y=p[a],l=e.match(y);if(l!==null){s=e.match(c).filter(function(e){return e.length>0}).map(parseFloat),v=e.substring(0,1).match(/[mlcshv]/)!==null,r=s.length,o=f[a];if(r%o!==0)throw new Error("Wrong amount of coordinates: "+e+". Expected "+o+" and got "+r+".");g=0;for(u=w=0,E=r/o-1;0<=E?w<=E:w>=E;u=0<=E?++w:--w){m=s.slice(g,g+o),u>0&&a==="moveTo"&&(a="lineTo"),b=[null].concat(m),b.push(this.owner),b.push(t),b.push(v);if(b.join(" ").mentions("NaN"))debugger;i=new(Function.prototype.bind.apply(n[a],b)),d.push(i),g+=o}break}}if(d.length===0)throw new Error("Unreadable path value: "+e);return d.length===1?d[0]:d},r.prototype.select=function(){return this.show(),this.showHandles(),this.antlers.refresh(),this.baseHandle.setAttribute("selected",""),this},r.prototype.deselect=function(){return this.baseHandle.removeAttribute("selected"),typeof this.hideHandles=="function"&&this.hideHandles(),this.hide(),this},r.prototype.draw=function(){var t;this
.$baseHandle=$('<div class="transform handle point"></div>'),this.baseHandle=this.$baseHandle[0];if(this.at===void 0&&!(this instanceof e))debugger;return this.baseHandle.setAttribute("at",this.at),this.owner!=null&&this.baseHandle.setAttribute("owner",this.owner.metadata.uuid),this.updateHandle(this.baseHandle,this.x,this.y),(t=Ct.ui)!=null&&t.appendChild(this.baseHandle),this},r.prototype.makeAntlers=function(){var e,n;return this.succ!=null?e=this.succ.p2!=null?this.succ.p2():void 0:e=null,n=this.p3!=null?this.p3():null,this.antlers=new t(this,n,e),this},r.prototype.showHandles=function(){return this.antlers.show()},r.prototype.hideHandles=function(){return this.antlers.hide()},r.prototype.absoluteCached=void 0,r.prototype.prec=null,r.prototype.succ=null,r.prototype.actionHint=function(){return this.baseHandle.setAttribute("action","")},r.prototype.hideActionHint=function(){return this.baseHandle.removeAttribute("action")},r.prototype.updateHandle=function(e,t,n){e==null&&(e=this.baseHandle),t==null&&(t=this.x),n==null&&(n=this.y);if(e===void 0)return;return e.style.left=t*ui.canvas.zoom,e.style.top=n*ui.canvas.zoom,this},r.prototype.inheritPosition=function(e){return this.at=e.at,this.prec=e.prec,this.succ=e.succ,this.prec.succ=this,this.succ.prec=this,this.owner=e.owner,e.baseHandle!=null&&(this.baseHandle=e.baseHandle),this},r.prototype.nudge=function(e,t,n){var i,s;n==null&&(n=!0),i=this.clone(),r.__super__.nudge.call(this,e,t),(s=this.antlers)!=null&&s.nudge(e,t),this.updateHandle();if(this.owner.type==="path"&&n&&this.owner.points.closed){if(this===this.owner.points.first&&this.owner.points.last.equal(i))return this.owner.points.last.nudge(e,t,!1);if(this===this.owner.points.last&&this.owner.points.first.equal(i))return this.owner.points.first.nudge(e,t,!1)}},r.prototype.rotate=function(e,t){var n;return r.__super__.rotate.call(this,e,t),(n=this.antlers)!=null&&n.rotate(e,t),this.updateHandle()},r.prototype.scale=function(e,t,n,i){var s;return r.__super__.scale.call(this,e,t,n,i),(s=this.antlers)!=null&&s.scale(e,t,n,i),this.updateHandle(),this},r.prototype.replaceWith=function(e){return this.owner.points.replace(this,e)},r.prototype.toPosn=function(){return new J(this.x,this.y)},r.prototype.toLineSegment=function(){return new L(this.prec,this)},r.prototype.setSucc=function(e){return this.succ=e,e.prec=this},r.prototype.setPrec=function(e){return e.setSucc(this)},r.prototype.show=function(){if(this.baseHandle==null)return;return this.baseHandle||this.draw(),this.baseHandle.style.display="block",this.baseHandle.style.opacity=1},r.prototype.hide=function(e){e==null&&(e=!1);if(this.baseHandle==null)return;if(!this.baseHandle.hasAttribute("selected")||e)return this.baseHandle.style.opacity=0,this.baseHandle.removeAttribute("action"),this.hideHandles(),this.unhover()},r.prototype.hover=function(){var e;(e=this.baseHandle)!=null&&e.setAttribute("hover",""),this.baseHandle==null&&console.log("base handle missing");if(this.at===0)return this.owner.points.last.baseHandle.setAttribute("hover","");if(this===this.owner.points.last)return this.owner.points.first.baseHandle.setAttribute("hover","")},r.prototype.unhover=function(){var e;return(e=this.baseHandle)!=null?e.removeAttribute("hover"):void 0},r.prototype.clear=function(){return this.baseHandle.style.display="none",this},r.prototype.unclear=function(){return this.baseHandle.style.display="block",this},r.prototype.remove=function(){var e,t;return(e=this.antlers)!=null&&e.hide(),(t=this.baseHandle)!=null?t.remove():void 0},r.prototype.toStringWithZoom=function(){var e;return this.multiplyByMutable(ui.canvas.zoom),e=this.toString(),this.multiplyByMutable(1/ui.canvas.zoom),e},r.prototype.flag=function(e){return this._flags.ensure(e)},r.prototype.unflag=function(e){return this._flags.remove(e)},r.prototype.flagged=function(e){return this._flags.has(e)},r.prototype.annotate=function(e,t){return ui.annotations.drawDot(this,e,t)},r}(J),V=function(){function e(e){var t,n,r,i;this.coefs=e,n=this.coefs.length,i=this.coefs;for(t in i){if(!ln.call(i,t))continue;r=i[t],this["p"+(n-t-1)]=r}this.coefs=this.coefs.reverse(),this}return e.prototype.tolerance=1e-6,e.prototype.accuracy=6,e.prototype.degrees=function(){return this.coefs.length-1},e.prototype.interpolate=function(e,t,n,r,i){var s,o,u,a,f,l,c,h,p,d,v,g,y,b,w,E,S,x,T;y=0,l=0,d=0,s=[n],o=[n],a=Math.abs(i-e[r]);for(p=b=0,S=n+1;0<=S?b<=S:b>=S;p=0<=S?++b:--b)f=Math.abs(i-e[r+p]),f<a&&(d=p,a=f),s[p]=o[p]=ys[r+p];y=ys[r+d],d-=1;for(p=w=1,x=m+1;1<=x?w<=x:w>=x;p=1<=x?++w:--w){for(p=E=0,T=n-m+1;0<=T?E<=T:E>=T;p=0<=T?++E:--E){c=e[r+p]-i,h=e[r+p+m]-i,g=s[p+1]-o[p],u=c-h;if(u===0){v={y:0,dy:0};break}u=g/u,o[p]=h*u,s[p]=c*u}l=2*(d+1)<n-m?s[d+1]:o[d-=1],y+=l}return{y:y,dy:l}},e.prototype.eval=function(e){var t,n,r,i;n=0;for(t=r=i=this.coefs.length-1;i<=0?r<=0:r>=0;t=i<=0?++r:--r)n=n*e+this.coefs[t];return n},e.prototype.add=function(t){var n,r,i,s,o,u,a,f;o=[],n=this.degrees(),r=t.degrees(),i=Math.max(n,r);for(s=f=0;0<=i?f<=i:f>=i;s=0<=i?++f:--f)u=s<=n?this.coefs[s]:0,a=s<=r?t.coefs[s]:0,o[s]=u+a;return o=o.reverse(),new e(o)},e.prototype.roots=function(){switch(this.coefs.length-1){case 0:return[];case 1:return this.linearRoot();case 2:return this.quadraticRoots();case 3:return this.cubicRoots();case 4:return this.quarticRoots();default:return[]}},e.prototype.derivative=function(){var t,n,r,i;n=[];for(t=r=1,i=this.degrees();1<=i?r<=i:r>=i;t=1<=i?++r:--r)n.push(t*this.coefs[t]);return new e(n.reverse())},e.prototype.bisection=function(e,t){var n,r,i,s,o,u,a,f,l,c;s=this.eval(e),i=this.eval(t);if(Math.abs(s)<=this.tolerance)return e;if(Math.abs(i)<=this.tolerance)return t;if(s*i<=0){u=Math.log(t-e),a=Math.LN10*this.accuracy,r=Math.ceil((u+a)/Math.LN2);for(n=l=0,c=r-1;0<=c?l<=c:l>=c;n=0<=c?++l:--l){o=.5*(e+t),f=this.eval(o);if(Math.abs(f)<=this.tolerance)break;f*s<0?(t=o,i=f):(e=o,s=f)}}return o},e.prototype.rootsInterval=function(e,t){var n,r,i,s,o,u,a,f,l;u=[];if(this.degrees()===1)a=this.bisection(e,t),a!=null&&u.push(a);else{n=this.derivative(),i=n.rootsInterval(e,t),r=i.length;if(r>0){a=this.bisection(e,i[0]),a!=null&&u.push(a);for(s=f=0,l=r-2;0<=l?f<=l:f>=l;s=0<=l?++f:--f)o=i[s],a=this.bisection(o,i[s+1]),a!=null&&u.push(a);a=this.bisection(i[r-1],t),a!=null&&u.push(a)}else a=this.bisection(e,t),a!=null&&u.push(a)}return u},e.prototype.linearRoot=function(){var e;return e=[],this.p1!==0&&e.push(-this.p0/this.p1),e},e.prototype.quadraticRoots=function(){var e,t,n,r,i,s;return s=[],e=this.p2,t=this.p1/e,n=this.p0/e,r=t*t-4*n,r>0?(i=Math.sqrt(r),s.push(.5*(-t+i)),s.push(.5*(-t-i))):r===0&&s.push(.5*-t),s},e.prototype.cubicRoots=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g;return p=[],o=this.p3,s=this.p2/o,i=this.p1/o,r=this.p0/o,e=(3*i-s*s)/3,n=(2*s*s*s-9*i*s+27*r)/27,h=s/3,a=n*n/4+e*e*e/27,c=n/2,Math.abs(a)<=1e-6&&(a=0),a>0?(l=Math.sqrt(a),g=-c+l,d=g>=0?Math.pow(g,1/3):-Math.pow(-g,1/3),g=-c-l,d+=g>=0?Math.pow(g,1/3):-Math.pow(-g,1/3),p.push(d-h)):a<0?(f=Math.sqrt(-e/3),t=Math.atan2(Math.sqrt(-a),-c)/3,u=Math.cos(t),v=Math.sin(t),m=Math.sqrt(3),p.push(2*f*u-h),p.push(-f*(u+m*v)-h),p.push(-f*(u-m*v)-h)):(c>=0?g=-Math.pow(c,1/3):g=Math.pow(-c,1/3),p.push(2*g-h),p.push(-g-h)),p},e}(),K=function(){function e(e,t){this.min=e,this.max=t}return e.prototype.length=function(){return this.max-this.min},e.prototype.contains=function(e){return e>this.min&&e<this.max},e.prototype.containsInclusive=function(e,t){return t==null&&(t=0),e>=this.min-t&&e<=this.max+t},e.prototype.intersects=function(e){return e===this.min||e===this.max},e.prototype.fromList=function(e){return this.min=Math.min.apply(this,e),this.max=Math.max.apply(this,e),this},e.prototype.fromRangeList=function(e){var t,n;return n=e.map(function(e){return e.min}),t=e.map(function(e){return e.max}),this.min=Math.min.apply(this,n),this.max=Math.max.apply(this,t),this},e.prototype.nudge=function(e){return this.min+=e,this.max+=e},e.prototype.scale=function(e,t){return this.min+=(this.min-t)*(e-1),this.max+=(this.max-t)*(e-1)},e.prototype.toString=function(){return"["+this.min.places(4)+","+this.max.places(4)+"]"},e.prototype.percentageOfValue=function(e){return(e-this.min)/this.length()},e}(),i=function(){function e(e,t,n,r){var i;this.x=e,this.y=t,this.width=n,this.height=r,this.x instanceof Array?(i=Math.min.apply(this,this.x.map(function(e){return e.x})),this.y=Math.min.apply(this,this.x.map(function(e){return e.y})),this.x2=Math.max.apply(this,this.x.map(function(e){return e.x2})),this.y2=Math.max.apply(this,this.x.map(function(e){return e.y2})),this.x=i,this.width=this.x2-this.x,this.height=this.y2-this.y):this.x instanceof J&&this.y instanceof J?(e=Math.min(this.x.x,this.y.x),t=Math.min(this.x.y,this.y.y),this.x2=Math.max(this.x.x,this.y.x),this.y2=Math.max(this.x.y,this.y.y),this.x=e,this.y=t,this.width=this.x2-this.x,this.height=this.y2-this.y):(this.x2=this.x+this.width,this.y2=this.y+this.height),this.xr=new K(this.x,this.x+this.width),this.yr=new K(this.y,this.y+this.height)}return e.prototype.tl=function(){return new J(this.x,this.y)},e.prototype.tr=function(){return new J(this.x2,this.y)},e.prototype.br=function(){return new J(this.x2,this.y2)},e.prototype.bl=function(){return new J(this.x,this.y2)},e.prototype.clone=function(){return new e(this.x,this.y,this.width,this.height)},e.prototype.toRect=function(){return new G({x:this.x,y:this.y,width:this.width,height:this.height})},e.prototype.center=function(){return new J(this.x+this.width/2,this.y+this.height/2)},e.prototype.points=function(){return[new J(this.x,this.y),new J(this.x2,this.y),new J(this.x2,this.y2),new J(this.x,this.y2)]},e.prototype.contains=function(e,t){return this.xr.containsInclusive(e.x,t)&&this.yr.containsInclusive(e.y,t)},e.prototype.overlapsBounds=function(e,t){return t==null&&(t=!0),this.toRect().overlaps(e.toRect())},e.prototype.nudge=function(e,t){return this.x+=e,this.x2+=e,this.y+=t,this.y2+=t,this.xr.nudge(e),this.yr.nudge(t)},e.prototype.scale=function(e,t,n){var r,i;return i=new J(this.x,this.y),r=new J(this.x2,this.y2),i.scale(e,t,n),r.scale(e,t,n),this.x=i.x,this.y=i.y,this.x2=r.x,this.y2=r.y,this.width*=e,this.height*=t,this.xr.scale(e,n),this.yr.scale(t,n),this},e.prototype.squareSmaller=function(e){return this.width<this.height?this.height=this.width:this.width=this.height},e.prototype.centerOn=function(e){var t;return t=e.subtract(this.center()),this.nudge(t.x,t.y)},e.prototype.fitTo=function(t){var n,r,i;return i=this.width/t.width,n=this.height/t.height,r=Math.max(i,n),new e(0,0,this.width/r,this.height/r)},e.prototype.adjustElemsTo=function(e){var t,n,r;return t=this.tl().subtract(e.tl()),r=this.width/e.width,n=this.height/e.height,function(i){return i.scale(1/r,1/n,e.tl()),i.nudge(-t.x,t.y)}},e.prototype.annotateCorners=function(){return ui.annotations.drawDot(this.tl()),ui.annotations.drawDot(this.tr()),ui.annotations.drawDot(this.bl()),ui.annotations.drawDot(this.br())},e}(),t=function(){function t(e,t,n){var r;this.base=e,this.basep3=t,this.succp2=n,this.basep3!=null&&this.succp2!=null?(r=Math.abs(this.basep3.angle360(this.base)-this.succp2.angle360(this.base)),this.lockAngle=r.within(this.angleLockThreshold,180)):this.lockAngle=!1,this}return t.prototype.angleLockThreshold=.5,t.prototype.commit=function(){return this.basep3!=null&&(this.base.x3=this.basep3.x,this.base.y3=this.basep3.y),this.succp2!=null&&this.succ()&&(this.succ().x2=this.succp2.x,this.succ().y2=this.succp2.y),this},t.prototype.importNewSuccp2=function(e){return this.succp2=e,this.succp2!=null&&(this.basep3=this.succp2.reflect(this.base)),this.commit().refresh()},t.prototype.killSuccp2=function(){return this.succp2=new J(this.base.x,this.base.y),this.commit().refresh()},t.prototype.succ=function(){return this.base.succ},t.prototype.refresh=function(){if(!this.visible)return;return this.hide().show()},t.prototype.visible=!1,t.prototype.show=function(){var t=this;return this.hide(),this.visible=!0,this.basep3!=null&&(this.basep=new e(this.basep3.x,this.basep3.y,this.base.owner,this,-1)),this.succp2!=null&&(this.succp=new e(this.succp2.x,this.succp2.y,this.base.owner,this,1)),function(){return t.hide()}},t.prototype.hide=function(){var e,t,n;return this.visible=!1,(e=this.basep)!=null&&e.remove(),(t=this.succp)!=null&&t.remove(),(n=this.base.owner.antlerPoints)!=null&&n.remove([this.basep,this.succp]),this},t.prototype.redraw=function(){return this.hide(),this.show(),this},t.prototype.hideTemp=function(e){var t;return(t=e===2?this.succp:this.basep)!=null?t.hideTemp():void 0},t.prototype.nudge=function(e,t){var n,r;return(n=this.basep3)!=null&&n.nudge(e,t),(r=this.succp2)!=null&&r.nudge(e,t),this.succ()instanceof c&&(this.succ().x2+=e,this.succ().y2-=t),this.commit()},t.prototype.scale=function(e,t,n){var r,i;return(r=this.basep3)!=null&&r.scale(e,t,n),(i=this.succp2)!=null?i.scale(e,t,n):void 0},t.prototype.rotate=function(e,t){var n,r;return(n=this.basep3)!=null&&n.rotate(e,t),(r=this.succp2)!=null&&r.rotate(e,t),this},t.prototype.other=function(e){return e===this.succp?this.basep:this.succp},t.prototype.angleDiff=function(e,t){var n;return n=e-t,n<0&&(n+=360),n},t.prototype.flatten=function(){var e,t,n,r,i,s;if(this.succp2==null||this.basep3==null)return;n=this.succp2.angle360(this.base),t=this.basep3.angle360(this.base),i=this.angleDiff(n,t),s=this.angleDiff(t,n),i<s?e="p2":e="p3";if(e==="p2"){if(i<180)return r=(180-i)/2,this.succp2=this.succp2.rotate(r,this.base),this.basep3=this.basep3.rotate(-r,this.base)}else if(s<180)return r=(180-s)/2,this.succp2=this.succp2.rotate(-r,this.base),this.basep3=this.basep3.rotate(r,this.base)},t}(),e=function(e){function t(e,n,r,i,s){var o;this.x=e,this.y=n,this.owner=r,this.family=i,this.role=s,t.__super__.constructor.call(this,this.x,this.y,this.owner),this.draw(),this.baseHandle.className+=" bz-ctrl",this.line=ui.annotations.drawLine(this.zoomedc(),this.family.base.zoomedc()),(o=this.owner.antlerPoints)!=null&&o.push(this)}return cn(t,e),t.prototype.succ=function(){return this.family.base.succ},t.prototype.base=function(){return this.family.base},t.prototype.hideTemp=function(){var e=this;return this.line.rep.style.display="none",this.baseHandle.style.display="none",function(){return e.line.rep.style.display="block",e.baseHandle.style.display="block"}},t.prototype.remove=function(){return this.line.remove(),t.__super__.remove.apply(this,arguments)},t.prototype.nudge=function(e,n){var r,i,s,o;this.family.lockAngle?(i=this.angle360(this.family.base),t.__super__.nudge.call(this,e,n),r=this.angle360(this.family.base),(o=this.family.other(this))!=null&&o.rotate(r-i,this.family.base),this.persist()):(t.__super__.nudge.call(this,e,n),this.persist());if(this.role===-1&&this.family.base.succ instanceof st)return s=this.family.base.succ,s.replaceWith(s.toCurveTo())},t.prototype.scale=function(e,n,r){return t.__super__.scale.call(this,e,n,r),this.persist()},t.prototype.rotate=function(e,n){return t.__super__.rotate.call(this,e,n),this.persist()},t.prototype.persist=function(){var e;return this.role===-1&&this.family.basep3.copy(this),this.role===1&&this.family.succp2.copy(this),this.family.base===this.owner.points.last&&(e=this.owner.points.first,this.family.base.equal(e)&&(e.antlers.succp2=this.family.succp2.clone(),e.antlers.basep3=this.family.basep3.clone(),e.antlers.commit())),this.line.absorbA(this.family.base.zoomedc()),this.line.absorbB(this.zoomedc()),this.line.commit(),this.family.commit()},t}(q),H=function(e){function t(e,n,r,i,s){this.x=e,this.y=n,this.owner=r,this.prec=i,this.rel=s,t.__super__.constructor.call(this,this.x,this.y,this.owner)}return cn(t,e),t.prototype.relative=function(){var e,n,r,i;return this.at===0?(this.rel=!1,this):this.rel?this:(n=this.prec.absolute(),r=n.x,i=n.y,e=new t(this.x-r,this.y-i,this.owner),e.rel=!0,e)},t.prototype.absolute=function(){var e,n,r,i,s,o,u,a,f;return this.at===0?(this.rel=!1,this):this.rel?(r=this.prec.absolute(),i=r.x,s=r.y,e=new t(this.x+i,this.y+s,this.owner),e.rel=!1,e):this},t.prototype.p2=function(){var e;return((e=this.antlers)!=null?e.succp2:void 0)!=null?new J(this.antlers.succp2.x,this.antlers.succp2.y):null},t.prototype.toString=function(){return""+(this.rel?"m":"M")+this.x+","+this.y},t.prototype.toLineSegment=function(){return this.prec.toLineSegment()},t.prototype.clone=function(){return new t(this.x,this.y,this.owner,this.prec,this.rel)},t}(q),A=function(e){function t(e,n,r,i,s){this.x=e,this.y=n,this.owner=r,this.prec=i,this.rel=s,t.__super__.constructor.call(this,this.x,this.y,this.owner)}return cn(t,e),t.prototype.relative=function(){var e,n,r,i;return this.rel?this:(n=this.prec.absolute(),r=n.x,i=n.y,e=new t(this.x-r,this.y-i,this.owner),e.rel=!0,e)},t.prototype.absolute=function(){var e,n,r,i;return this.rel?this.absoluteCached?this.absoluteCached:(n=this.prec.absolute(),r=n.x,i=n.y,e=new t(this.x+r,this.y+i,this.owner),e.rel=!1,this.absoluteCached=e,e):this},t.prototype.toString=function(){return""+(this.rel?"l":"L")+this.x+","+this.y},t.prototype.clone=function(){return new t(this.x,this.y,this.owner,this.prec,this.rel)},t}(q),N=function(e){function t(e,n,r,i){this.x=e,this.owner=n,this.prec=r,this.rel=i,this.inheritFromPrec(this.prec),t.__super__.constructor.call(this,this.x,this.y,this.owner)}return cn(t,e),t.prototype.inheritFromPrec=function(e){return this.prec=e,this.y=this.prec.absolute().y},t.prototype.toString=function(){return""+(this.rel?"h":"H")+this.x},t.prototype.convertToLineTo=function(){var e;return e=new A(this.x,this.y),this.replaceWith(e),e},t.prototype.rotate=function(e,t){return this.convertToLineTo().rotate(e,t)},t.prototype.absolute=function(){return this.rel?this.absoluteCached?this.absoluteCached:this.absoluteCached=new t(this.x+this.prec.absolute().x,this.owner,this.prec,!1):this},t.prototype.relative=function(){return this.rel?this:new t(this.x-this.prec.absolute().x,this.owner,this.prec,!0)},t.prototype.clone=function(){return new t(this.x,this.owner,this.prec,this.rel)},t}(q),gt=function(e){function t(e,n,r,i){this.y=e,this.owner=n,this.prec=r,this.rel=i,this.inheritFromPrec(this.prec),t.__super__.constructor.call(this,this.x,this.y,this.owner)}return cn(t,e),t.prototype.inheritFromPrec=function(e){return this.prec=e,this.x=this.prec.absolute().x},t.prototype.toString=function(){return""+(this.rel?"v":"V")+this.y},t.prototype.convertToLineTo=function(){var e;return e=new A(this.x,this.y),this.replaceWith(e),e},t.prototype.rotate=function(e,t){return this.convertToLineTo().rotate(e,t)},t.prototype.absolute=function(){return this.rel?this.absoluteCached?this.absoluteCached:this.absoluteCached=new t(this.y+this.prec.absolute().y,this.owner,this.prec,!1):this},t.prototype.relative=function(){return this.rel?this:new t(this.y-this.prec.absolute().y,this.owner,this.prec,!0)},t.prototype.clone=function(){return new t(this.y,this.owner,this.prec,this.rel)},t}(q),c=function(e){function t(e,n,r,i,s,o,u,a,f){this.x2=e,this.y2=n,this.x3=r,this.y3=i,this.x=s,this.y=o,this.owner=u,this.prec=a,this.rel=f,t.__super__.constructor.call(this,this.x,this.y,this.owner)}return cn(t,e),t.prototype.p2=function(){return new J(this.x2,this.y2)},t.prototype.p3=function(){return new J(this.x3,this.y3)},t.prototype.p=function(){return new J(this.x,this.y)},t.prototype.absorb=function(e,t){return this["x"+t]=e.x,this["y"+t]=e.y},t.prototype.show=function(){return this.owner?t.__super__.show.apply(this,arguments):this},t.prototype.cleanUp=function(){return},t.prototype.scale=function(e,n,r){return this.absorb(this.p2().scale(e,n,r),2),this.absorb(this.p3().scale(e,n,r),3),t.__super__.scale.call(this,e,n,r)},t.prototype.rotate=function(e,n){return this.absorb(this.p2().rotate(e,n),2),this.absorb(this.p3().rotate(e,n),3),t.__super__.rotate.call(this,e,n)},t.prototype.relative=function(){var e,t,n,r,i;return this.rel?this:(n=this.prec.absolute(),r=n.x,i=n.y,e=[this.x2-r,this.y2-i,this.x3-r,this.y3-i,this.x-r,this.y-i,this.owner,this.prec],this.constructor===st&&(e=e.slice(2)),e.unshift(null),t=new(Function.prototype.bind.apply(this.constructor,e)),t.rel=!0,t)},t.prototype.absolute=function(){var e,t,n,r,i;return this.rel?(n=this.prec.absolute(),r=n.x,i=n.y,e=[this.x2+r,this.y2+i,this.x3+r,this.y3+i,this.x+r,this.y+i,this.owner,this.prec],this.constructor===st&&(e=e.slice(2)),e.unshift(null),t=new(Function.prototype.bind.apply(this.constructor,e)),t.rel=!1,t):this},t}(q),h=function(e){function t(e,n,r,i,s,o,u,a,f){this.x2=e,this.y2=n,this.x3=r,this.y3=i,this.x=s,this.y=o,this.owner=u,this.prec=a,this.rel=f,t.__super__.constructor.call(this,this.x2,this.y2,this.x3,this.y3,this.x,this.y,this.owner,this.prec,this.rel)}return cn(t,e),t.prototype.toString=function(){return""+(this.rel?"c":"C")+this.x2+","+this.y2+" "+this.x3+","+this.y3+" "+this.x+","+this.y},t.prototype.reverse=function(){return(new t(this.x3,this.y3,this.x2,this.y2,this.x,this.y,this.owner,this.prec,this.rel)).inheritPosition(this)},t.prototype.clone=function(){return new t(this.x2,this.y2,this.x3,this.y3,this.x,this.y,this.owner,this.prec,this.rel)},t}(c),st=function(e){function t(e,n,r,i,s,o,u){this.x3=e,this.y3=n,this.x=r,this.y=i,this.owner=s,this.prec=o,this.rel=u,this.inheritFromPrec(this.prec),t.__super__.constructor.call(this,this.x2,this.y2,this.x3,this.y3,this.x,this.y,this.owner,this.prec,this.rel)}return cn(t,e),t.prototype.inheritFromPrec=function(e){var t,n;return this.prec=e,this.prec instanceof c?(n=this.prec.absolute(),t=(new J(n.x3,n.y3)).reflect(n)):t=new J(this.x,this.y),this.x2=t.x,this.y2=t.y},t.prototype.toCurveTo=function(e){var t;return e==null&&(e=null),e===null&&(this.prec instanceof c?e=this.prec.p3().reflect(this.prec.p()):e=new J(this.x,this.y)),t=new h(e.x,e.y,this.x3,this.y3,this.x,this.y,this.owner,this.prec,this.rel),t.at=this.at,t},t.prototype.replaceWithCurveTo=function(e){return e==null&&(e=null),this.replaceWith(this.toCurveTo(e))},t.prototype.toString=function(){return""+(this.rel?"s":"S")+this.x3+","+this.y3+" "+this.x+","+this.y},t.prototype.reverse=function(){return new h(this.x3,this.y3,this.x2,this.y2,this.x,this.y,this.owner,this.prec,this.rel)},t.prototype.clone=function(){return new t(this.x3,this.y3,this.x,this.y,this.owner,this.prec,this.rel)},t}(c),U=function(){function e(e,t,n){var r,i,s,o,u,a=this;this.owner=t,this.segments=n!=null?n:[],typeof e=="string"&&(e=Wt.conversions.stringToAlop(e,this.owner)),r=[],o=void 0,i=function(){var e;if(r.length===0)return;return e=new z(r,a),a.lastSegment=e,a.firstSegment===null&&(a.firstSegment=e),a.segments.push(e),r=[]},this.segments.length!==0&&(this.firstSegment=this.segments[0],this.lastSegment=this.segments[this.segments.length-1]);if(e.length===0)return;for(s in e){if(!ln.call(e,s))continue;u=e[s],s=parseInt(s,10),u.at=s,s===0&&(this.first=u),s===e.length-1&&(this.last=u),u.setPrec(o!=null?o:e[e.length-1]),o!=null&&o.setSucc(u),u instanceof H&&i(),r.push(u),o=u}i(),o.setSucc(this.first)}return e.prototype.first=null,e.prototype.last=null,e.prototype.firstSegment=null,e.prototype.lastSegment=null,e.prototype.closed=!1,e.prototype.moveSegmentToFront=function(e){if(!this.segments.has(e))return;return this.segments=this.segments.cannibalizeUntil(e)},e.prototype.movePointToFront=function(e){return this.moveSegmentToFront(e.segment),e.segment.movePointToFront(e)},e.prototype.firstPointThatEquals=function(e){return this.filter(function(t){return t.equal(e)})[0]},e.prototype.closedOnSameSpot=function(){return this.closed&&this.last.equal(this.first)},e.prototype.length=function(){return this.segments.reduce(function(e,t){return e+t.points.length},0)},e.prototype.all=function(){var e,t,n,r,i;e=[],i=this.segments;for(n=0,r=i.length;n<r;n++)t=i[n],e=e.concat(t.points);return e},e.prototype.renumber=function(){return this.all().map(function(e,t){return e.at=t,e})},e.prototype.pushSegment=function(e){return this.lastSegment=e,this.segments.push(e)},e.prototype.push=function(e,t){this.segments.length===0&&this.pushSegment(new z([],this)),e.owner=this.owner;if(t==null)return e.at=this.lastSegment.points.length,this.lastSegment.points.push(e),this.last!=null?(this.last.setSucc(e),e.setPrec(this.last)):e.setPrec(e),this.first!=null?(this.first.setPrec(e),e.setSucc(this.first)):e.setSucc(e),this.last=e,this},e.prototype.replace=function(e,t){return this.segmentContaining(e).replace(e,t)},e.prototype.reverse=function(){return new e([],this.owner,this.segments.map(function(e){return e.reverse()}))},e.prototype.at=function(e){return this.segmentContaining(parseInt(e,10)).at(e)},e.prototype.close=function(){return this.closed=!0,this},e.prototype.relative=function(){return this.segments=this.segments.map(function(e){return e.points=e.points.map(function(e){var t;return t=e.relative(),t.inheritPosition(e),t}),e}),this},e.prototype.absolute=function(){return this.segments=this.segments.map(function(e){return e.points=e.points.map(function(e){var t;return t=e.absolute(),t.inheritPosition(e),t}),e}),this},e.prototype.drawBasePoints=function(){return this.map(function(e){var t;return(t=e.baseHandle)!=null&&t.remove(),e.draw(),e.makeAntlers()}),this},e.prototype.removeBasePoints=function(){return this.map(function(e){var t;return(t=e.baseHandle)!=null?t.remove():void 0}),this},e.prototype.hide=function(){return this.map(function(e){return e.hide()})},e.prototype.unhover=function(){return this.map(function(e){return e.unhover()})},e.prototype.join=function(e){return this.all().join(e)},e.prototype.segmentContaining=function(e){var t,n,r,i,s,o;if(typeof e=="number"){o=this.segments;for(i=0,s=o.length;i<s;i++){t=o[i];if(!(t.startsAt<=e))break;n=t}return n}return r=this.segments.filter(function(t){return t.points.indexOf(e)>-1}),r.length===1?r[0]:[]},e.prototype.hasPointWithin=function(e,t){return this.filter(function(n){return n.within(e,t)}).length>0},e.prototype.remove=function(e){var t,n,r,i;typeof e=="number"&&(e=this.at(e));if(e instanceof Array){i=[];for(n=0,r=e.length;n<r;n++)t=e[n],i.push(this.remove(t));return i}if(e instanceof q)return this.segmentContaining(e).remove(e)},e.prototype.filter=function(e){return this.all().filter(e)},e.prototype.filterSegments=function(e){return this.segments.map(function(t){return new z(t.points.filter(e))})},e.prototype.fetch=function(e){return this.all().filter(function(t){return t instanceof e})},e.prototype.map=function(e){return this.segments.map(function(t){return t.points.map(e)})},e.prototype.forEach=function(e){return this.segments.forEach(function(t){return t.points.forEach(e)})},e.prototype.mapApply=function(e){return this.segments.map(function(t){return t.points=t.points.map(e)})},e.prototype.xRange=function(){var e;return e=this.all().map(function(e){return e.x}),new K(Math.min.apply(this,e),Math.max.apply(this,e))},e.prototype.yRange=function(){var e;return e=this.all().map(function(e){return e.y}),new K(Math.min.apply(this,e),Math.max.apply(this,e))},e.prototype.toString=function(){return this.segments.join(" ")+(this.closed?"z":"")},e.prototype.insideOf=function(e){return this.all().filter(function(t){return t.insideOf(e)})},e.prototype.notInsideOf=function(e){return this.all().filter(function(t){return!t.insideOf(e)})},e.prototype.withoutMoveTos=function(){return new e([],this.owner,this.filterSegments(function(e){return!(e instanceof H)}))},e}(),z=function(){function e(e,t){var n=this;this.points=e,this.list=t,this.startsAt=this.points.length!==0?this.points[0].at:0,this.list!=null&&(this.owner=this.list.owner),this.points[0]instanceof H&&(this.moveTo=this.points[0]),this.points.forEach(function(e){return e.segment=n}),this}return e.prototype.insert=function(e,t){var n,r;n=this.points.slice(0,t),r=this.points.slice(t);if(e instanceof Array)return r.forEach(function(t){return t.at+=e.length}),n=n.concat(e);if(e instanceof q)return r.forEach(function(e){return e.at+=1}),n[n.length-1].setSucc(e),r[0].setPrec(e),n.push(e);throw new Error("PointsList: don't know how to insert "+e+".")},e.prototype.toString=function(){return this.points.join(" ")},e.prototype.at=function(e){return this.points[e-this.startsAt]},e.prototype.remove=function(e){return e.prec.succ=e.succ,e.succ.prec=e.prec,e===this.list.last&&(this.list.last=e.prec),e===this.list.first&&(this.list.first=e.succ),this.points=this.points.remove(e),e.remove()},e.prototype.movePointToFront=function(e){if(!this.points.has(e))return;return this.removeMoveTo(),this.points=this.points.cannibalizeUntil(e),this},e.prototype.moveMoveTo=function(e){var t,n,r,i,s;r=this.points.slice(1);for(t=i=0,s=e.at-1;0<=s?i<=s:i>=s;t=0<=s?++i:--i)n=n.cannibalize();return this.moveTo.copy(e),this.points=[this.moveTo].concat(n)},e.prototype.replace=function(e,t){var n,r,i,s,o,u,a,f,l,c,h;if(t instanceof q)t.inheritPosition(e),this.points=this.points.replace(e,t);else if(t instanceof Array){o=t.length,n=e.at,s=e.prec,u=e.succ,e.succ.prec=t[o-1];for(a=0,l=t.length;a<l;a++)r=t[a],r.owner=this.owner,r.at=n,r.prec=s,r.succ=u,s.succ=r,s=r,n+=1;this.points=this.points.replace(e,t),h=this.points.slice(n);for(f=0,c=h.length;f<c;f++)i=h[f],i.at+=o-1}return t},e.prototype.validateLinks=function(){var e,t,n,r,i;console.log(this.points.map(function(e){return""+e.prec.at+" "+e.at+" "+e.succ.at})),n=this.points.length-1,i=this.points;for(e in i){if(!ln.call(i,e))continue;t=i[e],e=parseInt(e,10);if(t.prec!==this.points[n]){console.log(t,"prec wrong. Expecting",n);debugger;return!1}r=e===this.points.length-1?0:e+1;if(t.succ!==this.points[r])return console.log(t,"succ wrong"),!1;n=e}return!0},e.prototype.reverse=function(){var t,n,r,i,s,o;this.removeMoveTo(),r=[],i=[],o=this.points;for(t in o){if(!ln.call(o,t))continue;n=o[t],i.push(n),r.push({x:n.x,y:n.y})}return s=i.slice(1).reverse().map(function(e){return e instanceof c?e.reverse():e}),r=r.reverse(),i=i.slice(0,1).concat(s),i=i.map(function(e,t){var n,i;return n=r[0],e.x=n.x,e.y=n.y,i=e.succ,e.succ=e.prec,e.prec=i,e.at=t,r=r.slice(1),e}),new e(i,this.list)},e.prototype.removeMoveTo=function(){return this.points=this.points.filter(function(e){return!(e instanceof H)})},e.prototype.ensureMoveTo=function(){var e,t,n;return t=this.points.last(),e=this.points.first(),n=new H(t.x,t.y,t.owner,t),n.at=0,t.succ=e.prec=n,n.succ=e,this.points.unshift(n),this},e}(),L=function(){function e(e,t,n){this.a=e,this.b=t,this.source=n!=null?n:this.toLineTo(),this.calculate()}return e.prototype.calculate=function(){return this.slope=(this.a.y-this.b.y)/(this.b.x-this.a.x),this.angle=Math.atan(this.slope)/(Math.PI/180),this.length=Math.sqrt(Math.pow(this.b.x-this.a.x,2)+Math.pow(this.b.y-this.a.y,2)),this},e.prototype.beginning=function(){return this.a},e.prototype.end=function(){return this.a},e.prototype.toString=function(){return"(Line segment: "+this.a.toString()+" "+this.b.toString()+")"},e.prototype.constructorString=function(){return"new LineSegment("+this.a.constructorString()+", "+this.b.constructorString()+")"},e.prototype.angle360=function(){return this.b.angle360(this.a)},e.prototype.toLineTo=function(){return new A(this.b.x,this.b.y)},e.prototype.toSVGPoint=function(){return this.toLineTo()},e.prototype.reverse=function(){return new e(this.b,this.a)},e.prototype.bounds=function(e){var t,n,r,s,o,u;return e==null&&(e=!1),this.boundsCached!=null&&e?this.boundsCached:(s=Math.min(this.a.x,this.b.x),n=Math.max(this.a.x,this.b.x),o=Math.min(this.a.y,this.b.y),r=Math.max(this.a.y,this.b.y),u=this.width(),t=this.height(),this.boundsCached=new i(s,o,u,t))},e.prototype.boundsCached=void 0,e.prototype.rotate=function(t,n){return new e(this.a.rotate(t,n),this.b.rotate(t,n))},e.prototype.width=function(){return Math.abs(this.a.x-this.b.x)},e.prototype.height=function(){return Math.abs(this.a.y-this.b.y)},e.prototype.xRange=function(){return new K(Math.min(this.a.x,this.b.x),Math.max(this.a.x,this.b.x))},e.prototype.yRange=function(){return new K(Math.min(this.a.y,this.b.y),Math.max(this.a.y,this.b.y))},e.prototype.xDiff=function(){return Math.max(this.b.x,this.a.x)-Math.min(this.b.x,this.a.x)},e.prototype.xbaDiff=function(){return this.b.x-this.a.x},e.prototype.yDiff=function(){return Math.max(this.b.y,this.a.y)-Math.min(this.b.y,this.a.y)},e.prototype.ybaDiff=function(){return this.b.y-this.a.y},e.prototype.yAtX=function(e,t){return t==null&&(t=!0),!t&&!this.xRange().containsInclusive(e)?null:this.a.y+(e-this.a.x)*this.slope},e.prototype.xAtY=function(e,t){return t==null&&(t=!0),!t&&!this.yRange().containsInclusive(e)?null:this.a.x+(e-this.a.y)/this.slope},e.prototype.ends=function(){return[a,b]},e.prototype.posnAtPercent=function(e){return new J(this.a.x+(this.b.x-this.a.x)*e,this.a.y+(this.b.y-this.a.y)*e)},e.prototype.findPercentageOfPoint=function(e){var t;return t=e.distanceFrom(this.a),t/(t+e.distanceFrom(this.b))},e.prototype.splitAt=function(t,n){var r,i,s,o,u,a,f,l,c,h,p;n==null&&(n=null
);if(typeof t=="number")return f=n?n:this.posnAtPercent(t),[new e(this.a,f),new e(f,this.b)];if(t instanceof Array){a=[],r={};for(l=0,h=t.length;l<h;l++)u=t[l],r[u.distanceFrom(this.a)]=u;i=Object.keys(r).map(parseFloat).sort(rn),o=this.a;for(c=0,p=i.length;c<p;c++)s=i[c],u=r[s],a.push(new e(o,u)),o=u;return a.push(new e(o,this.b)),a}if(t instanceof J)return[new e(this.a,t),new e(t,this.b)]},e.prototype.midPoint=function(){return this.splitAt(.5)[0].b},e.prototype.nudge=function(e,t){return this.a.nudge(e,t),this.b.nudge(e,t)},e.prototype.scale=function(e,t,n){return this.a.scale(e,t,n),this.b.scale(e,t,n)},e.prototype.equal=function(e){return e instanceof l?!1:this.a.equal(e.a)&&this.b.equal(e.b)||this.a.equal(e.b)&&this.b.equal(e.a)},e.prototype.intersects=function(e){var t;return t=this.intersection(e),t instanceof J||t instanceof Array},e.prototype.intersection=function(t){if(t instanceof e)return this.intersectionWithLineSegment(t);if(t instanceof o)return this.intersectionWithCircle(t);if(t instanceof l)return t.intersectionWithLineSegment(this)},e.prototype.intersectionWithLineSegment=function(e){var t,n,r,i,s;return n=e.xbaDiff()*(this.a.y-e.a.y)-e.ybaDiff()*(this.a.x-e.a.x),t=this.xbaDiff()*(this.a.y-e.a.y)-this.ybaDiff()*(this.a.x-e.a.x),s=e.ybaDiff()*this.xbaDiff()-e.xbaDiff()*this.ybaDiff(),s!==0?(i=n/s,r=t/s,0<=i&&i<=1&&0<=r&&r<=1?new J(this.a.x+i*(this.b.x-this.a.x),this.a.y+i*(this.b.y-this.a.y)):null):n===0||t===0?Infinity:0},e.prototype.intersectionWithEllipse=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b;v=e.data.rx,m=e.data.ry,s=e.data.cx,o=e.data.cy,h=new J(this.a.x,this.a.y),f=new J(this.b.x-this.a.x,this.b.y-this.a.y),i=new J(s,o),a=h.subtract(i),c=new J(f.x/(v*v),f.y/(m*m)),l=new J(a.x/(v*v),a.y/(m*m)),p=[],t=f.dot(c),n=f.dot(l),r=a.dot(l)-1,u=n*n-t*r;if(u<0)return null;if(u>0){d=Math.sqrt(u),y=(-n-d)/t,b=(-n+d)/t;if((y<0||1<y)&&(b<0||1<b))return y<0&&b<0&&y>1&&b>1?null:null;0<=y&&y<=1&&p.push(this.a.lerp(this.b,y)),0<=b&&b<=1&&p.push(this.a.lerp(this.b,b))}else{g=-n/t;if(!(0<=g&&g<=1))return null;p.push(this.a.lerp(this.b,g))}return p},e.prototype.intersectionWithCircle=function(e){var t,n,r,i,s,o,u,a;return t=Math.pow(this.xDiff(),2)+Math.pow(this.yDiff(),2),n=2*((this.b.x-this.a.x)*(this.a.x-e.data.cx)+(this.b.y-this.a.y)*(this.a.y-e.data.cy)),r=Math.pow(e.data.cx,2)+Math.pow(e.data.cy,2)+Math.pow(this.a.x,2)+Math.pow(this.a.y,2)-2*(e.data.cx*this.a.x+e.data.cy*this.a.y)-Math.pow(e.data.r,2),i=n*n-4*t*r,i<0?null:i===0?0:(s=Math.sqrt(i),u=(-n+s)/(2*t),a=(-n-s)/(2*t),(u<0||u>1)&&(a<0||a>1)?u<0&&a<0||u>1&&a>1?null:!0:(o=[],0<=u&&u<=1&&o.push(this.a.lerp(this.b,u)),0<=a&&a<=1&&o.push(this.a.lerp(this.b,a)),o))},e}(),Q=function(e){function t(e,n){this.a=e,this.angle=n,t.__super__.constructor.call(this,this.a,this.a.clone().nudge(0,-1e5).rotate(this.angle,this.a))}return cn(t,e),t}(L),l=function(){function e(e,t,n,r,i){this.p1=e,this.p2=t,this.p3=n,this.p4=r,this.source=i!=null?i:this.toCurveTo()}return e.prototype.toString=function(){return"new CubicBezier("+this.p1+", "+this.p2+", "+this.p3+", "+this.p4+")"},e.prototype.toCurveTo=function(){return new h(this.p2.x,this.p2.y,this.p3.x,this.p3.y,this.p4.x,this.p4.y)},e.prototype.toSVGPoint=function(){return this.toCurveTo()},e.prototype.length=function(){return this.intoLineSegments(4).reduce(function(e,t){return e+t.length})},e.prototype.beginning=function(){return this.p1},e.prototype.end=function(){return this.p4},e.prototype.nudge=function(e,t){return this.p1.nudge(e,t),this.p2.nudge(e,t),this.p3.nudge(e,t),this.p4.nudge(e,t),this},e.prototype.scale=function(e,t,n){return this.p1.scale(e,t,n),this.p2.scale(e,t,n),this.p3.scale(e,t,n),this.p4.scale(e,t,n),this},e.prototype.rotate=function(e,t){return this.p1.rotate(e,t),this.p2.rotate(e,t),this.p3.rotate(e,t),this.p4.rotate(e,t),this},e.prototype.reverse=function(){return new e(this.p4,this.p3,this.p2,this.p1)},e.prototype.equal=function(e){return e instanceof L?!1:this.p1.equal(e.p1)&&this.p2.equal(e.p2)&&this.p3.equal(e.p3)&&this.p4.equal(e.p4)||this.p1.equal(e.p4)&&this.p2.equal(e.p3)&&this.p3.equal(e.p2)&&this.p4.equal(e.p1)},e.prototype.intersects=function(e){var t;return t=this.intersection(e),t instanceof J||t instanceof Array&&t.length>0},e.prototype.intersection=function(t){switch(t.constructor){case L:return this.intersectionWithLineSegment(t);case e:return this.intersectionWithCubicBezier(t)}},e.prototype.xRange=function(){return this.bounds().xr},e.prototype.yRange=function(){return this.bounds().yr},e.prototype.ends=function(){return[this.p1,this.p4]},e.prototype.midPoint=function(){return this.splitAt(.5)[0].p4},e.prototype.bounds=function(e){var t,n,r,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P;e==null&&(e=!1);if(this.boundsCached!=null&&e)return this.boundsCached;u=a=Infinity,s=o=-Infinity,g=this.p2.x-this.p1.x,y=this.p2.y-this.p1.y,b=this.p3.x-this.p2.x,w=this.p3.y-this.p2.y,E=this.p4.x-this.p3.x,S=this.p4.y-this.p3.y;for(r=P=0;P<=40;r=++P)t=r/40,f=this.p1.x+t*g,l=this.p1.y+t*y,c=this.p2.x+t*b,h=this.p2.y+t*w,p=this.p3.x+t*E,d=this.p3.y+t*S,x=c-f,T=h-l,N=p-c,C=d-h,v=f+t*x,m=l+t*T,A=c+t*N,O=h+t*C,k=A-v,L=O-m,_=v+t*k,D=m+t*L,u=Math.min(u,_),a=Math.min(a,D),s=Math.max(s,_),o=Math.max(o,D),M=s-u,n=o-a;return this.boundsCached=new i(u,a,M,n)},e.prototype.boundsCached=void 0,e.prototype.intoLineSegments=function(e){var t,n,r,i,s,o,u;i=[];for(r=u=0;0<=e?u<=e:u>=e;r=0<=e?++u:--u)t=1/r,s=Math.pow(1-t,3)*this.p1.x+3*Math.pow(1-t,2)*t*this.p2.x+3*(1-t)*Math.pow(t,2)*this.p3.x+Math.pow(t,3)*this.p4.x,o=Math.pow(1-t,3)*this.p1.y+3*Math.pow(1-t,2)*t*this.p2.y+3*(1-t)*Math.pow(t,2)*this.p3.y+Math.pow(t,3)*this.p4.y,r%2===0?n=new J(s,o):i.push(new L(n,new J(s,o)));return i.splice(1)},e.prototype.splitAt=function(t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w;n==null&&(n=null);if(typeof t=="number")return i=(new L(this.p1,this.p2)).posnAtPercent(t),s=(new L(this.p2,this.p3)).posnAtPercent(t),o=(new L(this.p3,this.p4)).posnAtPercent(t),u=(new L(i,s)).posnAtPercent(t),a=(new L(s,o)).posnAtPercent(t),r=n?n:(new L(u,a)).posnAtPercent(t),[new e(this.p1,i,u,r),new e(r,a,o,this.p4)];if(t instanceof J)return this.splitAt(this.findPercentageOfPoint(t),t);if(t instanceof Array){v={},d=[];for(g=0,b=t.length;g<b;g++)p=t[g],c=this.findPercentageOfPoint(p),v[c]=p;h=Object.keys(v).map(parseFloat).sort(rn),m=this;for(y=0,w=h.length;y<w;y++)l=h[y],f=m.splitAt(v[l]),d.push(f[0]),m=f[1];return d.push(m),d}},e.prototype.findPercentageOfPoint=function(e,t,n,r){var i,s,o,u,a,f,l;return t==null&&(t=.001),n==null&&(n=0),r==null&&(r=.5),l=this.splitAt(.5),i=l[0],u=l[1],i.p4.within(t,e)||r<1e-4?n:(s=i.bounds(),a=u.bounds(),s.xr.containsInclusive(e.x,.2)&&s.yr.containsInclusive(e.y,.2)&&(o=i.findPercentageOfPoint(e,t,n,r/2)),a.xr.containsInclusive(e.x,.2)&&a.yr.containsInclusive(e.y,.2)&&(f=u.findPercentageOfPoint(e,t,n+r,r/2)),o!=null?o:f!=null?f:n)},e.prototype.intersectionWithLineSegment=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S;h=e.a.min(e.b),c=e.a.max(e.b),w=[],t=this.p1.multiplyBy(-1),n=this.p2.multiplyBy(3),r=this.p3.multiplyBy(-3),f=t.add(n.add(r.add(this.p4))),u=new J(f.x,f.y),t=this.p1.multiplyBy(3),n=this.p2.multiplyBy(-6),r=this.p3.multiplyBy(3),f=t.add(n.add(r)),o=new J(f.x,f.y),t=this.p1.multiplyBy(-3),n=this.p2.multiplyBy(3),r=t.add(n),s=new J(r.x,r.y),i=new J(this.p1.x,this.p1.y),p=new J(e.a.y-e.b.y,e.b.x-e.a.x),a=e.a.x*e.b.y-e.b.x*e.a.y,E=(new V([p.dot(u),p.dot(o),p.dot(s),p.dot(i)+a])).roots();for(l in E)S=E[l],0<=S&&S<=1&&(v=this.p1.lerp(this.p2,S),m=this.p2.lerp(this.p3,S),g=this.p3.lerp(this.p4,S),y=v.lerp(m,S),b=m.lerp(g,S),d=y.lerp(b,S),e.a.x===e.b.x?h.y<=d.y&&d.y<=c.y&&w.push(d):e.a.y===e.b.y?h.x<=d.x&&d.x<=c.x&&w.push(d):d.gte(h)&&d.lte(c)&&w.push(d));return w},e.prototype.intersectionWithCubicBezier=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U,z,W,X,$,K,Q,G,Y,Z,et,tt,nt;K=[],t=this.p1.multiplyBy(-1),n=this.p2.multiplyBy(3),r=this.p3.multiplyBy(-3),U=t.add(n.add(r.add(this.p4))),b=new J(U.x,U.y),t=this.p1.multiplyBy(3),n=this.p2.multiplyBy(-6),r=this.p3.multiplyBy(3),U=t.add(n.add(r)),d=new J(U.x,U.y),t=this.p1.multiplyBy(-3),n=this.p2.multiplyBy(3),r=t.add(n),f=new J(r.x,r.y),i=new J(this.p1.x,this.p1.y),t=e.p1.multiplyBy(-1),n=e.p2.multiplyBy(3),r=e.p3.multiplyBy(-3),U=t.add(n.add(r.add(e.p4))),j=new J(U.x,U.y),t=e.p1.multiplyBy(3),n=e.p2.multiplyBy(-6),r=e.p3.multiplyBy(3),U=t.add(n.add(r)),D=new J(U.x,U.y),t=e.p1.multiplyBy(-3),n=e.p2.multiplyBy(3),r=t.add(n),A=new J(r.x,r.y),T=new J(e.p1.x,e.p1.y),s=i.x*i.x,o=i.x*i.x*i.x,u=i.y*i.y,a=i.y*i.y*i.y,l=f.x*f.x,c=f.x*f.x*f.x,h=f.y*f.y,p=f.y*f.y*f.y,v=d.x*d.x,m=d.x*d.x*d.x,g=d.y*d.y,y=d.y*d.y*d.y,w=b.x*b.x,E=b.x*b.x*b.x,S=b.y*b.y,x=b.y*b.y*b.y,N=T.x*T.x,C=T.x*T.x*T.x,k=T.y*T.y,L=T.y*T.y*T.y,O=A.x*A.x,M=A.x*A.x*A.x,_=A.y*A.y,P=D.x*D.x,H=D.x*D.x*D.x,B=D.y*D.y,F=j.x*j.x,I=j.x*j.x*j.x,q=j.y*j.y,R=j.y*j.y*j.y,$=new V([-E*R+x*I-3*b.x*S*F*j.y+3*w*b.y*j.x*q,-6*b.x*D.x*S*j.x*j.y+6*w*b.y*D.y*j.x*j.y+3*D.x*x*F-3*E*D.y*q-3*b.x*S*D.y*F+3*w*D.x*b.y*q,-6*A.x*b.x*S*j.x*j.y-6*b.x*D.x*S*D.y*j.x+6*w*D.x*b.y*D.y*j.y+3*A.x*x*F+3*P*x*j.x+3*A.x*w*b.y*q-3*b.x*A.y*S*F-3*b.x*P*S*j.y+w*b.y*j.x*(6*A.y*j.y+3*B)+E*(-A.y*q-2*B*j.y-j.y*(2*A.y*j.y+B)),f.x*d.y*b.x*b.y*j.x*j.y-f.y*d.x*b.x*b.y*j.x*j.y+6*A.x*D.x*x*j.x+3*f.x*d.x*b.x*b.y*q+6*i.x*b.x*S*j.x*j.y-3*f.x*d.x*S*j.x*j.y-3*f.y*d.y*b.x*b.y*F-6*i.y*w*b.y*j.x*j.y-6*T.x*b.x*S*j.x*j.y+3*f.y*d.y*w*j.x*j.y-2*d.x*g*b.x*j.x*j.y-6*A.x*b.x*D.x*S*j.y-6*A.x*b.x*S*D.y*j.x-6*b.x*A.y*D.x*S*j.x+6*A.x*w*b.y*D.y*j.y+2*v*d.y*b.y*j.x*j.y+H*x-3*i.x*x*F+3*i.y*E*q+3*T.x*x*F+y*b.x*F-m*b.y*q-3*i.x*w*b.y*q+3*i.y*b.x*S*F-2*f.x*d.y*w*q+f.x*d.y*S*F-f.y*d.x*w*q+2*f.y*d.x*S*F+3*T.x*w*b.y*q-d.x*g*b.y*F-3*T.y*b.x*S*F+v*d.y*b.x*q-3*b.x*P*S*D.y+w*b.y*j.x*(6*T.y*j.y+6*A.y*D.y)+w*D.x*b.y*(6*A.y*j.y+3*B)+E*(-2*A.y*D.y*j.y-T.y*q-D.y*(2*A.y*j.y+B)-j.y*(2*T.y*j.y+2*A.y*D.y)),6*f.x*d.x*b.x*b.y*D.y*j.y+f.x*d.y*b.x*D.x*b.y*j.y+f.x*d.y*b.x*b.y*D.y*j.x-f.y*d.x*b.x*D.x*b.y*j.y-f.y*d.x*b.x*b.y*D.y*j.x-6*f.y*d.y*b.x*D.x*b.y*j.x-6*i.x*D.x*x*j.x+6*T.x*D.x*x*j.x+6*i.y*E*D.y*j.y+2*y*b.x*D.x*j.x-2*m*b.y*D.y*j.y+6*i.x*b.x*D.x*S*j.y+6*i.x*b.x*S*D.y*j.x+6*i.y*b.x*D.x*S*j.x-3*f.x*d.x*D.x*S*j.y-3*f.x*d.x*S*D.y*j.x+2*f.x*d.y*D.x*S*j.x+4*f.y*d.x*D.x*S*j.x-6*i.x*w*b.y*D.y*j.y-6*i.y*w*D.x*b.y*j.y-6*i.y*w*b.y*D.y*j.x-4*f.x*d.y*w*D.y*j.y-6*T.x*b.x*D.x*S*j.y-6*T.x*b.x*S*D.y*j.x-2*f.y*d.x*w*D.y*j.y+3*f.y*d.y*w*D.x*j.y+3*f.y*d.y*w*D.y*j.x-2*d.x*g*b.x*D.x*j.y-2*d.x*g*b.x*D.y*j.x-2*d.x*g*D.x*b.y*j.x-6*T.y*b.x*D.x*S*j.x-6*A.x*b.x*A.y*S*j.x-6*A.x*b.x*D.x*S*D.y+6*T.x*w*b.y*D.y*j.y+2*v*d.y*b.x*D.y*j.y+2*v*d.y*D.x*b.y*j.y+2*v*d.y*b.y*D.y*j.x+3*A.x*P*x+3*O*x*j.x-3*b.x*A.y*P*S-3*O*b.x*S*j.y+w*D.x*b.y*(6*T.y*j.y+6*A.y*D.y)+w*b.y*j.x*(6*T.y*D.y+3*_)+A.x*w*b.y*(6*A.y*j.y+3*B)+E*(-2*T.y*D.y*j.y-j.y*(2*T.y*D.y+_)-A.y*(2*A.y*j.y+B)-D.y*(2*T.y*j.y+2*A.y*D.y)),f.x*A.x*d.y*b.x*b.y*j.y+f.x*d.y*b.x*A.y*b.y*j.x+f.x*d.y*b.x*D.x*b.y*D.y-f.y*d.x*A.x*b.x*b.y*j.y-f.y*d.x*b.x*A.y*b.y*j.x-f.y*d.x*b.x*D.x*b.y*D.y-6*f.y*A.x*d.y*b.x*b.y*j.x-6*i.x*A.x*x*j.x+6*T.x*A.x*x*j.x+2*A.x*y*b.x*j.x+6*i.x*A.x*b.x*S*j.y+6*i.x*b.x*A.y*S*j.x+6*i.x*b.x*D.x*S*D.y+6*i.y*A.x*b.x*S*j.x-3*f.x*d.x*A.x*S*j.y-3*f.x*d.x*A.y*S*j.x-3*f.x*d.x*D.x*S*D.y+2*f.x*A.x*d.y*S*j.x+4*f.y*d.x*A.x*S*j.x-6*i.y*A.x*w*b.y*j.y-6*i.y*w*A.y*b.y*j.x-6*i.y*w*D.x*b.y*D.y-6*T.x*A.x*b.x*S*j.y-6*T.x*b.x*A.y*S*j.x-6*T.x*b.x*D.x*S*D.y+3*f.y*A.x*d.y*w*j.y-3*f.y*d.y*b.x*P*b.y+3*f.y*d.y*w*A.y*j.x+3*f.y*d.y*w*D.x*D.y-2*d.x*A.x*g*b.x*j.y-2*d.x*A.x*g*b.y*j.x-2*d.x*g*b.x*A.y*j.x-2*d.x*g*b.x*D.x*D.y-6*T.y*A.x*b.x*S*j.x-6*A.x*b.x*A.y*D.x*S+6*T.y*w*A.y*b.y*j.x+2*v*A.x*d.y*b.y*j.y+2*v*d.y*A.y*b.y*j.x+2*v*d.y*D.x*b.y*D.y-3*i.x*P*x+3*T.x*P*x+3*O*D.x*x+y*b.x*P+3*i.y*b.x*P*S+f.x*d.y*P*S+2*f.y*d.x*P*S-d.x*g*P*b.y-3*T.y*b.x*P*S-3*O*b.x*S*D.y+v*d.y*b.x*(2*A.y*j.y+B)+f.x*d.x*b.x*b.y*(6*A.y*j.y+3*B)+A.x*w*b.y*(6*T.y*j.y+6*A.y*D.y)+m*b.y*(-2*A.y*j.y-B)+i.y*E*(6*A.y*j.y+3*B)+f.y*d.x*w*(-2*A.y*j.y-B)+f.x*d.y*w*(-4*A.y*j.y-2*B)+i.x*w*b.y*(-6*A.y*j.y-3*B)+w*D.x*b.y*(6*T.y*D.y+3*_)+T.x*w*b.y*(6*A.y*j.y+3*B)+E*(-2*T.y*A.y*j.y-D.y*(2*T.y*D.y+_)-T.y*(2*A.y*j.y+B)-A.y*(2*T.y*j.y+2*A.y*D.y)),-i.x*f.x*d.y*b.x*b.y*j.y+i.x*f.y*d.x*b.x*b.y*j.y+6*i.x*f.y*d.y*b.x*b.y*j.x-6*i.y*f.x*d.x*b.x*b.y*j.y-i.y*f.x*d.y*b.x*b.y*j.x+i.y*f.y*d.x*b.x*b.y*j.x+f.x*f.y*d.x*d.y*b.x*j.y-f.x*f.y*d.x*d.y*b.y*j.x+f.x*T.x*d.y*b.x*b.y*j.y+f.x*T.y*d.y*b.x*b.y*j.x+f.x*A.x*d.y*b.x*b.y*D.y+f.x*d.y*b.x*A.y*D.x*b.y-T.x*f.y*d.x*b.x*b.y*j.y-6*T.x*f.y*d.y*b.x*b.y*j.x-f.y*d.x*T.y*b.x*b.y*j.x-f.y*d.x*A.x*b.x*b.y*D.y-f.y*d.x*b.x*A.y*D.x*b.y-6*f.y*A.x*d.y*b.x*D.x*b.y-6*i.x*T.x*x*j.x-6*i.x*A.x*D.x*x-2*i.x*y*b.x*j.x+6*T.x*A.x*D.x*x+2*T.x*y*b.x*j.x+2*A.x*y*b.x*D.x+2*i.y*m*b.y*j.y-6*i.x*i.y*b.x*S*j.x+3*i.x*f.x*d.x*S*j.y-2*i.x*f.x*d.y*S*j.x-4*i.x*f.y*d.x*S*j.x+3*i.y*f.x*d.x*S*j.x+6*i.x*i.y*w*b.y*j.y+6*i.x*T.x*b.x*S*j.y-3*i.x*f.y*d.y*w*j.y+2*i.x*d.x*g*b.x*j.y+2*i.x*d.x*g*b.y*j.x+6*i.x*T.y*b.x*S*j.x+6*i.x*A.x*b.x*S*D.y+6*i.x*b.x*A.y*D.x*S+4*i.y*f.x*d.y*w*j.y+6*i.y*T.x*b.x*S*j.x+2*i.y*f.y*d.x*w*j.y-3*i.y*f.y*d.y*w*j.x+2*i.y*d.x*g*b.x*j.x+6*i.y*A.x*b.x*D.x*S-3*f.x*T.x*d.x*S*j.y+2*f.x*T.x*d.y*S*j.x+f.x*f.y*g*b.x*j.x-3*f.x*d.x*T.y*S*j.x-3*f.x*d.x*A.x*S*D.y-3*f.x*d.x*A.y*D.x*S+2*f.x*A.x*d.y*D.x*S+4*T.x*f.y*d.x*S*j.x+4*f.y*d.x*A.x*D.x*S-2*i.x*v*d.y*b.y*j.y-6*i.y*T.x*w*b.y*j.y-6*i.y*T.y*w*b.y*j.x-6*i.y*A.x*w*b.y*D.y-2*i.y*v*d.y*b.x*j.y-2*i.y*v*d.y*b.y*j.x-6*i.y*w*A.y*D.x*b.y-f.x*f.y*v*b.y*j.y-2*f.x*h*b.x*b.y*j.x+3*T.x*f.y*d.y*w*j.y-2*T.x*d.x*g*b.x*j.y-2*T.x*d.x*g*b.y*j.x-6*T.x*T.y*b.x*S*j.x-6*T.x*A.x*b.x*S*D.y-6*T.x*b.x*A.y*D.x*S+3*f.y*T.y*d.y*w*j.x+3*f.y*A.x*d.y*w*D.y+3*f.y*d.y*w*A.y*D.x-2*d.x*T.y*g*b.x*j.x-2*d.x*A.x*g*b.x*D.y-2*d.x*A.x*g*D.x*b.y-2*d.x*g*b.x*A.y*D.x-6*T.y*A.x*b.x*D.x*S-h*d.x*d.y*b.x*j.x+2*T.x*v*d.y*b.y*j.y+6*T.y*w*A.y*D.x*b.y+2*l*f.y*b.x*b.y*j.y+l*d.x*d.y*b.y*j.y+2*v*T.y*d.y*b.y*j.x+2*v*A.x*d.y*b.y*D.y+2*v*d.y*A.y*D.x*b.y+M*x+3*s*x*j.x-3*u*E*j.y+3*N*x*j.x+p*w*j.x-c*S*j.y-f.x*h*w*j.y+l*f.y*S*j.x-3*s*b.x*S*j.y+3*u*w*b.y*j.x-l*g*b.x*j.y+h*v*b.y*j.x-3*O*b.x*A.y*S-3*N*b.x*S*j.y+3*k*w*b.y*j.x+f.x*d.x*b.x*b.y*(6*T.y*j.y+6*A.y*D.y)+m*b.y*(-2*T.y*j.y-2*A.y*D.y)+i.y*E*(6*T.y*j.y+6*A.y*D.y)+f.y*d.x*w*(-2*T.y*j.y-2*A.y*D.y)+v*d.y*b.x*(2*T.y*j.y+2*A.y*D.y)+f.x*d.y*w*(-4*T.y*j.y-4*A.y*D.y)+i.x*w*b.y*(-6*T.y*j.y-6*A.y*D.y)+T.x*w*b.y*(6*T.y*j.y+6*A.y*D.y)+A.x*w*b.y*(6*T.y*D.y+3*_)+E*(-2*T.y*A.y*D.y-k*j.y-A.y*(2*T.y*D.y+_)-T.y*(2*T.y*j.y+2*A.y*D.y)),-i.x*f.x*d.y*b.x*b.y*D.y+i.x*f.y*d.x*b.x*b.y*D.y+6*i.x*f.y*d.y*b.x*D.x*b.y-6*i.y*f.x*d.x*b.x*b.y*D.y-i.y*f.x*d.y*b.x*D.x*b.y+i.y*f.y*d.x*b.x*D.x*b.y+f.x*f.y*d.x*d.y*b.x*D.y-f.x*f.y*d.x*d.y*D.x*b.y+f.x*T.x*d.y*b.x*b.y*D.y+f.x*T.y*d.y*b.x*D.x*b.y+f.x*A.x*d.y*b.x*A.y*b.y-T.x*f.y*d.x*b.x*b.y*D.y-6*T.x*f.y*d.y*b.x*D.x*b.y-f.y*d.x*T.y*b.x*D.x*b.y-f.y*d.x*A.x*b.x*A.y*b.y-6*i.x*T.x*D.x*x-2*i.x*y*b.x*D.x+2*T.x*y*b.x*D.x+2*i.y*m*b.y*D.y-6*i.x*i.y*b.x*D.x*S+3*i.x*f.x*d.x*S*D.y-2*i.x*f.x*d.y*D.x*S-4*i.x*f.y*d.x*D.x*S+3*i.y*f.x*d.x*D.x*S+6*i.x*i.y*w*b.y*D.y+6*i.x*T.x*b.x*S*D.y-3*i.x*f.y*d.y*w*D.y+2*i.x*d.x*g*b.x*D.y+2*i.x*d.x*g*D.x*b.y+6*i.x*T.y*b.x*D.x*S+6*i.x*A.x*b.x*A.y*S+4*i.y*f.x*d.y*w*D.y+6*i.y*T.x*b.x*D.x*S+2*i.y*f.y*d.x*w*D.y-3*i.y*f.y*d.y*w*D.x+2*i.y*d.x*g*b.x*D.x-3*f.x*T.x*d.x*S*D.y+2*f.x*T.x*d.y*D.x*S+f.x*f.y*g*b.x*D.x-3*f.x*d.x*T.y*D.x*S-3*f.x*d.x*A.x*A.y*S+4*T.x*f.y*d.x*D.x*S-2*i.x*v*d.y*b.y*D.y-6*i.y*T.x*w*b.y*D.y-6*i.y*T.y*w*D.x*b.y-6*i.y*A.x*w*A.y*b.y-2*i.y*v*d.y*b.x*D.y-2*i.y*v*d.y*D.x*b.y-f.x*f.y*v*b.y*D.y-2*f.x*h*b.x*D.x*b.y+3*T.x*f.y*d.y*w*D.y-2*T.x*d.x*g*b.x*D.y-2*T.x*d.x*g*D.x*b.y-6*T.x*T.y*b.x*D.x*S-6*T.x*A.x*b.x*A.y*S+3*f.y*T.y*d.y*w*D.x+3*f.y*A.x*d.y*w*A.y-2*d.x*T.y*g*b.x*D.x-2*d.x*A.x*g*b.x*A.y-h*d.x*d.y*b.x*D.x+2*T.x*v*d.y*b.y*D.y-3*f.y*O*d.y*b.x*b.y+6*T.y*A.x*w*A.y*b.y+2*l*f.y*b.x*b.y*D.y+l*d.x*d.y*b.y*D.y+2*v*T.y*d.y*D.x*b.y+2*v*A.x*d.y*A.y*b.y-3*i.x*O*x+3*T.x*O*x+3*s*D.x*x-3*u*E*D.y+3*N*D.x*x+O*y*b.x+p*w*D.x-c*S*D.y+3*i.y*O*b.x*S-f.x*h*w*D.y+f.x*O*d.y*S+2*f.y*d.x*O*S+l*f.y*D.x*S-d.x*O*g*b.y-3*T.y*O*b.x*S-3*s*b.x*S*D.y+3*u*w*D.x*b.y-l*g*b.x*D.y+h*v*D.x*b.y-3*N*b.x*S*D.y+3*k*w*D.x*b.y+v*d.y*b.x*(2*T.y*D.y+_)+f.x*d.x*b.x*b.y*(6*T.y*D.y+3*_)+m*b.y*(-2*T.y*D.y-_)+i.y*E*(6*T.y*D.y+3*_)+f.y*d.x*w*(-2*T.y*D.y-_)+f.x*d.y*w*(-4*T.y*D.y-2*_)+i.x*w*b.y*(-6*T.y*D.y-3*_)+T.x*w*b.y*(6*T.y*D.y+3*_)+E*(-2*T.y*_-k*D.y-T.y*(2*T.y*D.y+_)),-i.x*f.x*d.y*b.x*A.y*b.y+i.x*f.y*d.x*b.x*A.y*b.y+6*i.x*f.y*A.x*d.y*b.x*b.y-6*i.y*f.x*d.x*b.x*A.y*b.y-i.y*f.x*A.x*d.y*b.x*b.y+i.y*f.y*d.x*A.x*b.x*b.y-f.x*f.y*d.x*A.x*d.y*b.y+f.x*f.y*d.x*d.y*b.x*A.y+f.x*T.x*d.y*b.x*A.y*b.y+6*f.x*d.x*T.y*b.x*A.y*b.y+f.x*T.y*A.x*d.y*b.x*b.y-T.x*f.y*d.x*b.x*A.y*b.y-6*T.x*f.y*A.x*d.y*b.x*b.y-f.y*d.x*T.y*A.x*b.x*b.y-6*i.x*T.x*A.x*x-2*i.x*A.x*y*b.x+6*i.y*T.y*E*A.y+2*T.x*A.x*y*b.x+2*i.y*m*A.y*b.y-2*m*T.y*A.y*b.y-6*i.x*i.y*A.x*b.x*S+3*i.x*f.x*d.x*A.y*S-2*i.x*f.x*A.x*d.y*S-4*i.x*f.y*d.x*A.x*S+3*i.y*f.x*d.x*A.x*S+6*i.x*i.y*w*A.y*b.y+6*i.x*T.x*b.x*A.y*S-3*i.x*f.y*d.y*w*A.y+2*i.x*d.x*A.x*g*b.y+2*i.x*d.x*g*b.x*A.y+6*i.x*T.y*A.x*b.x*S+4*i.y*f.x*d.y*w*A.y+6*i.y*T.x*A.x*b.x*S+2*i.y*f.y*d.x*w*A.y-3*i.y*f.y*A.x*d.y*w+2*i.y*d.x*A.x*g*b.x-3*f.x*T.x*d.x*A.y*S+2*f.x*T.x*A.x*d.y*S+f.x*f.y*A.x*g*b.x-3*f.x*d.x*T.y*A.x*S+4*T.x*f.y*d.x*A.x*S-6*i.x*T.y*w*A.y*b.y-2*i.x*v*d.y*A.y*b.y-6*i.y*T.x*w*A.y*b.y-6*i.y*T.y*A.x*w*b.y-2*i.y*v*A.x*d.y*b.y-2*i.y*v*d.y*b.x*A.y-f.x*f.y*v*A.y*b.y-4*f.x*T.y*d.y*w*A.y-2*f.x*h*A.x*b.x*b.y+3*T.x*f.y*d.y*w*A.y-2*T.x*d.x*A.x*g*b.y-2*T.x*d.x*g*b.x*A.y-6*T.x*T.y*A.x*b.x*S-2*f.y*d.x*T.y*w*A.y+3*f.y*T.y*A.x*d.y*w-2*d.x*T.y*A.x*g*b.x-h*d.x*A.x*d.y*b.x+6*T.x*T.y*w*A.y*b.y+2*T.x*v*d.y*A.y*b.y+2*l*f.y*b.x*A.y*b.y+l*d.x*d.y*A.y*b.y+2*v*T.y*A.x*d.y*b.y+2*v*T.y*d.y*b.x*A.y+3*s*A.x*x-3*u*E*A.y+3*N*A.x*x+p*A.x*w-c*A.y*S-3*k*E*A.y-f.x*h*w*A.y+l*f.y*A.x*S-3*s*b.x*A.y*S+3*u*A.x*w*b.y-l*g*b.x*A.y+h*v*A.x*b.y-3*N*b.x*A.y*S+3*k*A.x*w*b.y,i.x*i.y*f.x*d.y*b.x*b.y-i.x*i.y*f.y*d.x*b.x*b.y+i.x*f.x*f.y*d.x*d.y*b.y-i.y*f.x*f.y*d.x*d.y*b.x-i.x*f.x*T.y*d.y*b.x*b.y+6*i.x*T.x*f.y*d.y*b.x*b.y+i.x*f.y*d.x*T.y*b.x*b.y-i.y*f.x*T.x*d.y*b.x*b.y-6*i.y*f.x*d.x*T.y*b.x*b.y+i.y*T.x*f.y*d.x*b.x*b.y-f.x*T.x*f.y*d.x*d.y*b.y+f.x*f.y*d.x*T.y*d.y*b.x+f.x*T.x*T.y*d.y*b.x*b.y-T.x*f.y*d.x*T.y*b.x*b.y-2*i.x*T.x*y*b.x+2*i.y*m*T.y*b.y-3*i.x*i.y*f.x*d.x*S-6*i.x*i.y*T.x*b.x*S+3*i.x*i.y*f.y*d.y*w-2*i.x*i.y*d.x*g*b.x-2*i.x*f.x*T.x*d.y*S-i.x*f.x*f.y*g*b.x+3*i.x*f.x*d.x*T.y*S-4*i.x*T.x*f.y*d.x*S+3*i.y*f.x*T.x*d.x*S+6*i.x*i.y*T.y*w*b.y+2*i.x*i.y*v*d.y*b.y+2*i.x*f.x*h*b.x*b.y+2*i.x*T.x*d.x*g*b.y+6*i.x*T.x*T.y*b.x*S-3*i.x*f.y*T.y*d.y*w+2*i.x*d.x*T.y*g*b.x+i.x*h*d.x*d.y*b.x+i.y*f.x*f.y*v*b.y+4*i.y*f.x*T.y*d.y*w-3*i.y*T.x*f.y*d.y*w+2*i.y*T.x*d.x*g*b.x+2*i.y*f.y*d.x*T.y*w+f.x*T.x*f.y*g*b.x-3*f.x*T.x*d.x*T.y*S-2*i.x*v*T.y*d.y*b.y-6*i.y*T.x*T.y*w*b.y-2*i.y*T.x*v*d.y*b.y-2*i.y*l*f.y*b.x*b.y-i.y*l*d.x*d.y*b.y-2*i.y*v*T.y*d.y*b.x-2*f.x*T.x*h*b.x*b.y-f.x*f.y*v*T.y*b.y+3*T.x*f.y*T.y*d.y*w-2*T.x*d.x*T.y*g*b.x-T.x*h*d.x*d.y*b.x+3*u*f.x*d.x*b.x*b.y+3*f.x*d.x*k*b.x*b.y+2*T.x*v*T.y*d.y*b.y-3*s*f.y*d.y*b.x*b.y+2*l*f.y*T.y*b.x*b.y+l*d.x*T.y*d.y*b.y-3*N*f.y*d.y*b.x*b.y-o*x+a*E+C*x-L*E-3*i.x*N*x-i.x*p*w+3*s*T.x*x+i.y*c*S+3*i.y*k*E+T.x*p*w+s*y*b.x-3*u*T.y*E-u*m*b.y+N*y*b.x-c*T.y*S-m*k*b.y-i.x*l*f.y*S+i.y*f.x*h*w-3*i.x*u*w*b.y-i.x*h*v*b.y+i.y*l*g*b.x-f.x*h*T.y*w+3*s*i.y*b.x*S+s*f.x*d.y*S+2*s*f.y*d.x*S-2*u*f.x*d.y*w-u*f.y*d.x*w+l*T.x*f.y*S-3*i.x*k*w*b.y+3*i.y*N*b.x*S+f.x*N*d.y*S-2*f.x*k*d.y*w+T.x*h*v*b.y-f.y*d.x*k*w-s*d.x*g*b.y-3*s*T.y*b.x*S+3*u*T.x*w*b.y+u*v*d.y*b.x-l*T.y*g*b.x+2*N*f.y*d.x*S+3*T.x*k*w*b.y-N*d.x*g*b.y-3*N*T.y*b.x*S+v*k*d.y*b.x]),Q=$.rootsInterval(0,1);for(z in Q){if(!ln.call(Q,z))continue;G=Q[z],et=(new V([b.x,d.x,f.x,i.x-T.x-G*A.x-G*G*D.x-G*G*G*j.x])).roots(),nt=(new V([b.y,d.y,f.y,i.y-T.y-G*A.y-G*G*D.y-G*G*G*j.y])).roots();if(et.length>0&&nt.length>0){Y=.01;for(W in et){if(!ln.call(et,W))continue;Z=et[W];if(0<=Z&&Z<=1)for(X in nt){if(!ln.call(nt,X))continue;tt=nt[X],Math.abs(Z-tt)<Y&&K.push(j.multiplyBy(G*G*G).add(D.multiplyBy(G*G).add(A.multiplyBy(G).add(T))))}}}}return K},e}(),P=function(){function e(e){this.data=e!=null?e:{},this.rep=this.toSVG(),this.$rep=$(this.rep),this.metadata={angle:0,locked:!1},this.data.dontTrack||(this.metadata.uuid=uuid()),this.rep.setAttribute("uuid",this.metadata.uuid),this.validateColors(),this.type!=="text"&&(this.data=$.extend({fill:new u("none"),stroke:new u("none")},this.data)),this.updateDataArchived(),this.data["mondrian:angle"]!=null&&(this.metadata.angle=parseFloat(this.data["mondrian:angle"],10))}return e.prototype.commit=function(){var e,t,n;n=this.data;for(e in n){t=n[e];if(e==="")delete this.data[""];else{if((""+t).mentions("NaN"))throw new Error("NaN! Ack. Attribute = "+e+", Value = "+t);this.rep.setAttribute(e,t)}}return this.metadata.angle===0?this.rep.removeAttribute("mondrian:angle"):(this.metadata.angle<0&&(this.metadata.angle+=360),this.rep.setAttribute("mondrian:angle",this.metadata.angle)),this},e.prototype.updateDataArchived=function(e){return e!=null?this.dataArchived[e]=this.data[e]:this.dataArchived=Tt(this.data)},e.prototype.toSVG=function(){var e,t,n,r;t=document.createElementNS("http://www.w3.org/2000/svg",this.type),r=this.data;for(e in r)n=r[e],e!==""&&t.setAttribute(e,n);return t},e.prototype.validateColors=function(){this.data.fill!=null&&!(this.data.fill instanceof u)&&(this.data.fill=new u(this.data.fill)),this.data.stroke!=null&&!(this.data.stroke instanceof u)&&(this.data.stroke=new u(this.data.stroke));if(this.data["stroke-width"]==null)return this.data["stroke-width"]=1},e.prototype.points=[],e.prototype.center=function(){var e,t;return e=this.xRange(),t=this.yRange(),new J(e.min+(e.max-e.min)/2,t.min+(t.max-t.min)/2)},e.prototype.queryPoint=function(e){return this.points.filter(function(t){return t.baseHandle===e})[0]},e.prototype.queryAntlerPoint=function(e){return this.antlerPoints.filter(function(t){return t.baseHandle===e})[0]},e.prototype.show=function(){return this.rep.style.display="block"},e.prototype.hide=function(){return this.rep.style.display="none"},e.prototype.showPoints=function(){return this.points.map(function(e){return e.show()}),this},e.prototype.hidePoints=function(){return this.points.map(function(e){return e.hide()}),this},e.prototype.unhoverPoints=function(){return this.points.map(function(e){return e.unhover()}),this},e.prototype.removePoints=function(){return this.points.map(function(e){return e.clear()}),this},e.prototype.unremovePoints=function(){return this.points.map(function(e){return e.unclear()}),this},e.prototype.destroyPoints=function(){return this.points.map(function(e){return e.remove()})},e.prototype.removeHoverTargets=function(){var e,t,n,r,i;e=Yt("svg#hover-targets [owner='"+this.metadata.uuid+"']"),i=[];for(n=0,r=e.length;n<r;n++)t=e[n],i.push(t.remove());return i},e.prototype.redrawHoverTargets=function(){var e=this;return this.removeHoverTargets(),this.points.map(function(e){return new C(e.prec,e)}),this},e.prototype.topLeftBound=function(){return new J(this.xRange().min,this.yRange().min)},e.prototype.topRightBound=function(){return new J(this.xRange().max,this.yRange().min)},e.prototype.bottomRightBound=function(){return new J(this.xRange().max,this.yRange().max)},e.prototype.bottomLeftBound=function(){return new J(this.xRange().min,this.yRange().max)},e.prototype.attr=function(e){var t,n,r;r=[];for(t in e)n=e[t],typeof n=="function"?r.push(this.data[t]=n(this.data[t])):r.push(this.data[t]=n);return r},e.prototype.appendTo=function(e,t){var n;return t==null&&(t=!0),typeof e=="string"?n=Gt(e):n=e,n.appendChild(this.rep),t&&(ui.elements.has(this)||ui.elements.push(this)),this},e.prototype.clone=function(){var e,t,n;return t=Tt(this.data),n=Tt(this.transform),delete t.id,e=new this.constructor(t),e.transform=n,e},e.prototype["delete"]=function(){var e=this;return this.rep.remove(),ui.elements=ui.elements.remove(this),St(function(){e.destroyPoints(),e.removeHoverTargets();if(e.group)return e.group["delete"]()})},e.prototype.zIndex=function(){var e,t=this;return e=0,Ct.$main.children().each(function(n,r){if(r.getAttribute("uuid")===t.metadata.uuid)return e=n,!1}),e},e.prototype.moveForward=function(e){var t,n,r;e==null&&(e=1);for(n=r=1;1<=e?r<=e:r>=e;n=1<=e?++r:--r){t=this.$rep.next();if(t.length===0)break;t.after(this.$rep)}return this},e.prototype.moveBack=function(e){var t,n,r;e==null&&(e=1);for(n=r=1;1<=e?r<=e:r>=e;n=1<=e?++r:--r){t=this.$rep.prev();if(t.length===0)break;t.before(this.$rep)}return this},e.prototype.bringToFront=function(){return Ct.$main.append(this.$rep)},e.prototype.sendToBack=function(){return Ct.$main.prepend(this.$rep)},e.prototype.transform={},e.prototype.swapFillAndStroke=function(){var e;return e=this.data.stroke,this.attr({stroke:this.data.fill,fill:e}),this.commit()},e.prototype.eyedropper=function(e){return this.data.fill=e.data.fill,this.data.stroke=e.data.stroke,this.data["stroke-width"]=e.data["stroke-width"],this.commit()},e.prototype.bounds=function(){var e,t,n;return e=this.boundsCached,e!==null&&this.caching?e:(t=this.xRange(),n=this.yRange(),this.boundsCached=new i(t.min,n.min,t.length(),n.length()))},e.prototype.boundsCached=null,e.prototype.hideUI=function(){return ui.removePointHandles()},e.prototype.refreshUI=function(){return this.points.map(function(e){return e.updateHandle()}),this.redrawHoverTargets()},e.prototype.overlaps=function(e){return this["overlaps"+e.type.capitalize()](e)},e.prototype.lineSegmentsIntersect=function(e){var t,n,r,i,s,o,u,a,f,c,h,p,d;o=this.lineSegments(),f=e.lineSegments();for(c=0,p=o.length;c<p;c++){s=o[c],s instanceof l&&(i=s.bounds(!0)),t=s instanceof L?s.a:s.p1,n=s instanceof L?s.b:s.p2;if(e.contains(t)||e.contains(n))return!0;for(h=0,d=f.length;h<d;h++){a=f[h],s instanceof l||a instanceof l?(u=a.bounds(!0),r=i.overlapsBounds(u)):r=!0;if(r&&s.intersects(a))return!0}}return!1},e.prototype.lineSegmentIntersections=function(e){var t,n,r,i,s,o,u,a,f,l,c,h;n=[],s=this.lineSegments(),a=e.lineSegments();for(f=0,c=s.length;f<c;f++){i=s[f],r=i.bounds(!0);for(l=0,h=a.length;l<h;l++)u=a[l],o=u.bounds(!0),t=i.intersection(u),t instanceof J?n.push({intersection:[t],aline:i,bline:u,a:i.source,b:u.source}):t instanceof Array&&t.length>0&&n.push({intersection:t,aline:i,bline:u,a:i.source,b:u.source})}return n},e.prototype.remove=function(){this.rep.remove();if(this.points!==[])return this.points.map(function(e){var t;return(t=e.baseHandle)!=null?t.remove():void 0})},e.prototype.convertTo=function(e){var t;return t=this["convertTo"+e](),t.eyedropper(this),t},e.prototype.toString=function(){return"("+this.type+" Monsvg object)"},e.prototype.repToString=function(){return(new XMLSerializer).serializeToString(this.rep)},e.prototype.carryOutTransformations=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p;e==null&&(e=this.data.transform),t==null&&(t=new J(0,0)),r=e.replace(", ",",").split(" ").reverse(),p=[];for(f=0,l=r.length;f<l;f++){n=r[f],s=(c=n.match(/[a-z]+/gi))!=null?c[0]:void 0,o=(h=n.match(/\([\-\d\,\.]*\)/gi))!=null?h[0].replace(/[\(\)]/gi,""):void 0;switch(s){case"scale":i=parseFloat(o),this.scale(i,i,t),p.push(this.data["stroke-width"]*=i);break;case"translate":o=o.split(","),u=parseFloat(o[0]),a=o[1]!=null?parseFloat(o[1]):0,p.push(this.nudge(u,-a));break;case"rotate":this.rotate(parseFloat(o),t),p.push(this.metadata.angle=0);break;default:p.push(void 0)}}return p},e.prototype.applyTransform=function(e){var t,n,r,i,s,o,u,a,f,l;console.log("apply transform"),a=e.split(" ");for(o=0,u=a.length;o<u;o++){t=a[o],n=(f=t.match(/[a-z]+/gi))!=null?f[0]:void 0,r=(l=t.match(/\([\-\d\,\.]*\)/gi))!=null?l[0].replace(/[\(\)]/gi,""):void 0;switch(n){case"scale":r=parseFloat(r),this.transform.scale!=null?this.transform.scale*=r:this.transform.scale=r;break;case"translate":r=r.split(","),i=parseFloat(r[0]),s=parseFloat(r[1]),i=parseFloat(i),s=parseFloat(s),this.transform.translate!=null?(this.transform.translate.x+=i,this.transform.translate.y+=s):this.transform.translate={x:i,y:s};break;case"rotate":r=parseFloat(r),this.transform.rotate!=null?(this.transform.rotate+=r,this.transform.rotate%=360):this.transform.rotate=r}}return this.commit()},e.prototype.setFill=function(e){return this.data.fill=new u(e)},e.prototype.setStroke=function(e){return this.data.stroke=new u(e)},e.prototype.setStrokeWidth=function(e){return this.data["stroke-width"]=e},e.prototype.setupToCanvas=function(e){var t;return e.beginPath(),e.fillStyle=""+this.data.fill,(this.data["stroke-width"]!=null)>0&&((t=this.data.stroke)!=null?t.hex:void 0)!=="none"?(e.strokeStyle=""+this.data.stroke,e.lineWidth=parseFloat(this.data["stroke-width"])):(e.strokeStyle="none",e.lineWidth="0"),e},e.prototype.finishToCanvas=function(e){var t,n;return((t=this.points)!=null?t.closed:void 0)&&e.closePath(),e.fill(),this.data["stroke-width"]>0&&((n=this.data.stroke)!=null?n.hex:void 0)!=="none"&&e.stroke(),e},e.prototype.clearCachedObjects=function(){},e.prototype.lineSegments=function(){},e}(),C=function(e){function t(e,n,r){this.a=e,this.b=n,this.width=r,this.width==null&&(this.width=1),this.owner=this.b.owner,n=this.b instanceof st?this.b.toCurveTo():this.b,this.d="M"+this.a.x*ui.canvas.zoom+","+this.a.y*ui.canvas.zoom+" "+n.toStringWithZoom(),this.data={fill:"none",stroke:"rgba(75, 175, 255, 0.0)","stroke-width":4/ui.canvas.zoom,d:this.d},this.b.hoverTarget=this,t.__super__.constructor.call(this,this.data),this.appendTo("#hover-targets",!1),this.rep.setAttribute("a",this.a.at),this.rep.setAttribute("b",this.b.at),this.rep.setAttribute("owner",this.owner.metadata.uuid)}return cn(t,e),t.prototype.type="path",t.prototype.highlight=function(){return ui.unhighlightHoverTargets(),this.a.hover(),this.b.hover(),this.attr({"stroke-width":5,stroke:"#4981e0"}),ui.hoverTargetsHighlighted.push(this),this.commit()},t.prototype.unhighlight=function(){return this.attr({"stroke-width":5,stroke:"rgba(75, 175, 255, 0.0)"}),this.commit()},t.prototype.active=function(){return this.a.baseHandle.setAttribute("active",""),this.b.baseHandle.setAttribute("active","")},t.prototype.nudge=function(e,t){return this.a.nudge(e,t),this.b.nudge(e,t),this.owner.commit(),this.unhighlight(),this.constructor(this.a,this.b,this.width)},t}(P),k=function(e){function t(){return un=t.__super__.constructor.apply(this,arguments),un}return cn(t,e),t.prototype.type="line",t.prototype.a=function(){return new J(this.data.x1,this.data.y1)},t.prototype.b=function(){return new J(this.data.x2,this.data.y2)},t.prototype.absorbA=function(e){return this.data.x1=e.x,this.data.y1=e.y},t.prototype.absorbB=function(e){return this.data.x2=e.x,this.data.y2=e.y},t.prototype.asLineSegment=function(){return new L(this.a(),this.b())},t.prototype.fromLineSegment=function(e){return this.absorbA(e.a),this.absorbB(e.b)},t.prototype.xRange=function(){return this.asLineSegment().xRange()},t.prototype.yRange=function(){return this.asLineSegment().yRange()},t.prototype.nudge=function(e,t){return this.data.x1+=e,this.data.x2+=e,this.data.y1-=t,this.data.y2-=t,this.commit()},t.prototype.scale=function(e,t,n){return this.absorbA(this.a().scale(e,t,n)),this.absorbB(this.b().scale(e,t,n)),this.commit()},t.prototype.overlapsRect=function(e){var t,n,r,i,s;n=this.asLineSegment();if(this.a().insideOf(e))return!0;if(this.b().insideOf(e))return!0;s=e.lineSegments();for(r=0,i=s.length;r<i;r++){t=s[r];if(t.intersects(n))return!0}return!1},t}(P),G=function(e){function t(e){this.data=e,t.__super__.constructor.call(this,this.data),this.data.x==null&&(this.data.x=0),this.data.y==null&&(this.data.y=0),this.data.x=parseFloat(this.data.x),this.data.y=parseFloat(this.data.y),this.data.width=parseFloat(this.data.width),this.data.height=parseFloat(this.data.height)}return cn(t,e),t.prototype.type="rect",t.prototype.commit=function(){return this._validateDimensions(),t.__super__.commit.apply(this,arguments)},t.prototype.points=function(){return[new q(this.data.x,this.data.y),new q(this.data.x+this.data.width,this.data.y),new q(this.data.x+this.data.width,this.data.y+this.data.height),new q(this.data.x,this.data.y+this.data.height)]},t.prototype.lineSegments=function(){var e;return e=this.points(),[new L(e[0],e[1],e[1]),new L(e[1],e[2],e[2]),new L(e[2],e[3],e[3]),new L(e[3],e[0],e[0])]},t.prototype.center=function(){return new J(this.data.x+this.data.width/2,this.data.y+this.data.height/2)},t.prototype.xRange=function(){return new K(this.data.x,this.data.x+this.data.width)},t.prototype.yRange=function(){return new K(this.data.y,this.data.y+this.data.height)},t.prototype.clearCachedObjects=function(){},t.prototype.contains=function(e){return this.xRange().contains(e.x)&&this.yRange().contains(e.y)},t.prototype.overlaps=function(e){return this["overlaps"+e.type.capitalize()](e)},t.prototype.overlapsPolygon=function(e){return this.contains(e.center()||e.contains(this.center()))?!0:this.lineSegmentsIntersect(e)},t.prototype.overlapsCircle=function(e){},t.prototype.overlapsRect=function(e){return this.overlapsPolygon(e)},t.prototype.intersections=
function(e){var t,n,r,i,s,o,u,a,f,l;n=[],f=this.lineSegments();for(s=0,u=f.length;s<u;s++){r=f[s],l=e.lineSegments();for(o=0,a=l.length;o<a;o++)i=l[o],t=r.intersection(i),t instanceof J&&n.push(t)}return n},t.prototype.containments=function(e){var t,n,r,i,s,o,u;t=[],r=e.points,i=this.xRange(),s=this.yRange();for(o=0,u=r.length;o<u;o++)n=r[o],i.contains(n.x)&&s.contains(n.y)&&t.push(n);return t},t.prototype.containmentsBothWays=function(e){return this.containments(e).concat(e.containments(this))},t.prototype.scale=function(e,t,n){var r=this;return n==null&&(n=this.center()),this.attr({x:function(t){return(t-n.x)*e+n.x},y:function(e){return(e-n.y)*t+n.y},width:function(t){return t*e},height:function(e){return e*t}}),this.commit()},t.prototype.nudge=function(e,t){return this.data.x+=e,this.data.y-=t,this.commit()},t.prototype.convertToPath=function(){var e,t;return t=this.points(),e=new F({d:"M"+t[0]+" L"+t[1]+" L"+t[2]+" L"+t[3]+" L"+t[0]}),e.eyedropper(this),e.updateDataArchived(),e},t.prototype.drawToCanvas=function(e){return e=this.setupToCanvas(e),e.rect(this.data.x,this.data.y,this.data.width,this.data.height),e=this.finishToCanvas(e)},t.prototype._validateDimensions=function(){this.data.height<0&&(this.data.height*=-1);if(this.data.width<0)return this.data.width*=-1},t}(P),o=function(e){function t(){return an=t.__super__.constructor.apply(this,arguments),an}return cn(t,e),t.prototype.type="circle",t.prototype.scale=function(e,t){return this.attr({r:function(t){return t*e}}),this.commit()},t.prototype.scaleXY=function(e,t,n){},t.prototype.points=[],t.prototype.center=function(){return new J(this.data.cx,this.data.cy)},t.prototype.xRange=function(){return new K(this.data.cx-this.data.r,this.data.cx+this.data.r)},t.prototype.yRange=function(){return new K(this.data.cy-this.data.r,this.data.cy+this.data.r)},t.prototype.overlaps=function(e){return this["overlaps"+e.type.capitalize()](e)},t.prototype.overlapsPolygon=function(e){var t,n,r,i;if(e.contains(this.center()))return!0;i=e.lineSegments();for(n=0,r=i.length;n<r;n++){t=i[n];if(t.intersects(this))return!0}return!1},t.prototype.overlapsCircle=function(e){},t.prototype.overlapsRect=function(e){return this.overlapsPolygon(e)},t.prototype.nudge=function(e,t){return this.attr({cx:function(t){return t+=e},cy:function(e){return e-=t}}),this.commit()},t}(P),y=function(e){function t(e){this.data=e,t.__super__.constructor.call(this,this.data),this.data.cx=parseFloat(this.data.cx),this.data.cy=parseFloat(this.data.cy),this.data.rx=parseFloat(this.data.rx),this.data.ry=parseFloat(this.data.ry)}return cn(t,e),t.prototype.type="ellipse",t.prototype.xRange=function(){return new K(this.data.cx-this.data.rx,this.data.cx+this.data.rx)},t.prototype.yRange=function(){return new K(this.data.cy-this.data.ry,this.data.cy+this.data.ry)},t.prototype.c=function(){return new J(this.data.cx,this.data.cy)},t.prototype.top=function(){return new J(this.data.cx,this.data.cy-this.data.ry)},t.prototype.right=function(){return new J(this.data.cx+this.data.rx,this.data.cy)},t.prototype.bottom=function(){return new J(this.data.cx,this.data.cy+this.data.ry)},t.prototype.left=function(){return new J(this.data.cx-this.data.rx,this.data.cy)},t.prototype.overlapsRect=function(e){var t,n,r,i;i=e.lineSegments();for(n=0,r=i.length;n<r;n++){t=i[n];if(t.intersectionWithEllipse(this)instanceof Array)return!0}},t.prototype.nudge=function(e,t){return this.data.cx+=e,this.data.cy-=t,this.commit()},t.prototype.scale=function(e,t,n){var r;return r=this.c().scale(e,t,n),this.data.cx=r.x,this.data.cy=r.y,this.data.rx*=e,this.data.ry*=t,this.commit()},t.prototype.convertToPath=function(){var e,t,n,r,i,s,o,u,a;return i=new F({d:"M"+this.data.cx+","+(this.data.cy-this.data.ry)}),i.eyedropper(this),a=this.top(),s=this.right(),e=this.bottom(),r=this.left(),o=this.data.rx,u=this.data.ry,n=Math.KAPPA*u,t=Math.KAPPA*o,i.points.push(new h(a.x+t,a.y,s.x,s.y-n,s.x,s.y)),i.points.push(new h(s.x,s.y+n,e.x+t,e.y,e.x,e.y)),i.points.push(new h(e.x-t,e.y,r.x,r.y+n,r.x,r.y)),i.points.push(new h(r.x,r.y-n,a.x-t,a.y,a.x,a.y)),i.points.close(),i.points.drawBasePoints(),i.updateDataArchived(),i},t}(P),W=function(e){function t(e){this.data=e,this.points=new U(this.parsePoints(this.data.points)),t.__super__.constructor.call(this,this.data)}return cn(t,e),t.prototype.type="polygon",t.prototype.appendTo=function(e,n){return n==null&&(n=!0),t.__super__.appendTo.call(this,e,n),this.points.drawBasePoints().hide(),n&&this.redrawHoverTargets(),this},t.prototype.commit=function(){return this.data.points=this.points.toString(),t.__super__.commit.apply(this,arguments)},t.prototype.lineSegments=function(){var e,t;return e=this.points.points,t=[],e.map(function(n,r){var i;return i=e[r===e.length-1?0:r+1],t.push(new L(n,i))}),t},t.prototype.xs=function(){return this.points.all().map(function(e){return e.x})},t.prototype.ys=function(){return this.points.all().map(function(e){return e.y})},t.prototype.xRange=function(){return(new K).fromList(this.xs())},t.prototype.yRange=function(){return(new K).fromList(this.ys())},t.prototype.topLeftBound=function(){return new J(this.xRange().min,this.yRange().min)},t.prototype.topRightBound=function(){return new J(this.xRange().max,this.yRange().min)},t.prototype.bottomRightBound=function(){return new J(this.xRange().max,this.yRange().max)},t.prototype.bottomLeftBound=function(){return new J(this.xRange().min,this.yRange().max)},t.prototype.bounds=function(){var e,t;return e=this.xRange(),t=this.yRange(),new i(e.min,t.min,e.length(),t.length())},t.prototype.center=function(){return this.bounds().center()},t.prototype.parsePoints=function(){var e,t=this;return this.data.points===""?[]:(e=[],this.data.points=this.data.points.match(/[\d\,\. ]/gi).join(""),this.data.points.split(" ").map(function(n){var r,i,s;n=n.split(",");if(n.length===2)return i=parseFloat(n[0]),s=parseFloat(n[1]),r=new q(i,s,t),e.push(r)}),e)},t.prototype.clearCachedObjects=function(){},t.prototype.rotate=function(e,t){var n=this;return t==null&&(t=this.center()),this.points.map(function(n){return n.rotate(e,t)}),this.metadata.angle+=e,this.metadata.angle%=360},t.prototype.scale=function(e,t,n){return n==null&&(n=this.center()),this.points.map(function(r){return r.scale(e,t,n)}),this.commit()},t.prototype.nudge=function(e,t){return this.points.map(function(n){return n.nudge(e,t)}),this.commit()},t.prototype.contains=function(e){return e.insideOf(this.lineSegments())},t.prototype.overlaps=function(e){return this["overlaps"+e.type.capitalize()](e)},t.prototype.overlapsPolygon=function(e){var t,n,r,i,s,o,u,a;if(this.contains(e.center()||e.contains(this.center())))return!0;u=this.lineSegments();for(r=0,s=u.length;r<s;r++){t=u[r];if(e.contains(t.a||e.contains(t.b)))return!0;a=e.lineSegments();for(i=0,o=a.length;i<o;i++){n=a[i];if(n.intersects(t))return!0}}return!1},t.prototype.overlapsCircle=function(e){},t.prototype.overlapsRect=function(e){return this.overlapsPolygon(e)},t.prototype.convertToPath=function(){var e,t,n,r,i,s,o;r=new F({d:"M"+this.points.at(0).x+","+this.points.at(0).y}),r.eyedropper(this),t=r.points.at(0),o=this.points.all().slice(1);for(i=0,s=o.length;i<s;i++)n=o[i],e=new A(n.x,n.y,r,t,!1),r.points.push(e),t=e;return r.points.close(),r},t}(P),X=function(e){function t(){return fn=t.__super__.constructor.apply(this,arguments),fn}return cn(t,e),t.prototype.convertToPath=function(){var e,t,n,r,i,s,o;r=new F({d:"M"+this.points.at(0).x+","+this.points.at(0).y}),r.eyedropper(this),t=r.points.at(0),o=this.points.all().slice(1);for(i=0,s=o.length;i<s;i++)n=o[i],e=new A(n.x,n.y,r,t,!1),r.points.push(e),t=e;return r},t}(W),F=function(e){function t(e){var n,r,i;this.data=e,t.__super__.constructor.call(this,this.data),((n=this.data)!=null?n.d:void 0)!=null&&this.importNewPoints(this.data.d),this.antlerPoints=new U([],this),((r=this.data)!=null?(i=r.d)!=null?i.match(/z$/gi):void 0:void 0)!==null&&(this.points.closed=!0)}return cn(t,e),t.prototype.type="path",t.prototype.caching=!0,t.prototype.commit=function(){return this.data.d=this.points.toString(),t.__super__.commit.apply(this,arguments)},t.prototype.hover=function(){return ui.selection.elements.all.has(this)||this.showPoints(),ui.unhighlightHoverTargets()},t.prototype.unhover=function(){return this.hidePoints()},t.prototype.virgin=void 0,t.prototype.virginMode=function(){return this.virgin.eyedropper(this),this.$rep.replaceWith(this.virgin.$rep)},t.prototype.editMode=function(){return this.virgin.$rep.replaceWith(this.$rep)},t.prototype.woohoo=function(){return this.virgin=void 0},t.prototype.importNewPoints=function(e){return e instanceof U?this.points=e:this.points=new U(e,this),this.points=this.points.absolute(),this.clearCachedObjects(),this},t.prototype.cleanUpPoints=function(){var e,t,n,r;r=this.points.all();for(t=0,n=r.length;t<n;t++)e=r[t],e.cleanUp();return this.commit()},t.prototype.appendTo=function(e,n){return n==null&&(n=!0),t.__super__.appendTo.call(this,e,n),this.points.drawBasePoints().hide(),n&&this.redrawHoverTargets(),this},t.prototype.xRange=function(){var e;return e=this.xRangeCached,e!==null?e:this.xRangeCached=(new K).fromRangeList(this.lineSegments().map(function(e){return e.xRange()}))},t.prototype.xRangeCached=null,t.prototype.yRange=function(){var e;return e=this.yRangeCached,e!==null?e:this.yRangeCached=(new K).fromRangeList(this.lineSegments().map(function(e){return e.yRange()}))},t.prototype.yRangeCached=null,t.prototype.nudgeCachedObjects=function(e,t){var n,r,i,s;return(n=this.boundsCached)!=null&&n.nudge(e,t),(r=this.xRangeCached)!=null&&r.nudge(e),(i=this.yRangeCached)!=null&&i.nudge(t),(s=this.lineSegmentsCached)!=null?s.map(function(n){return n.nudge(e,t)}):void 0},t.prototype.scaleCachedObjects=function(e,t,n){var r,i,s;return(r=this.boundsCached)!=null&&r.scale(e,t,n),(i=this.xRangeCached)!=null&&i.scale(e,n.x),(s=this.yRangeCached)!=null&&s.scale(t,n.y),this.lineSegmentsCached=null},t.prototype.clearCachedObjects=function(){return this.lineSegmentsCached=null,this.boundsCached=null,this.xRangeCached=null,this.yRangeCached=null,this},t.prototype.lineSegments=function(){var e,t,n=this;return e=this.lineSegmentsCached,e!==null?e:(t=[],this.points.all().map(function(e,n){return t.push(Wt.conversions.pathSegment(e,e.succ))}),this.lineSegmentsCached=t)},t.prototype.lineSegmentsCached=null,t.prototype.scale=function(e,t,n){var r,i,s=this;return n==null&&(n=this.center()),this.scaleCachedObjects(e,t,n),r=this.metadata.angle,r!==0&&this.rotate(360-r,n),this.points.map(function(r){return r.scale(e,t,n)}),r!==0&&this.rotate(r,n),this.commit(),(i=this.virgin)!=null?i.scale(e,t,n):void 0},t.prototype.nudge=function(e,t){var n;return this.points.map(function(n){return n.nudge(e,t,!1)}),this.nudgeCachedObjects(e,t),this.commit(),(n=this.virgin)!=null?n.nudge(e,t):void 0},t.prototype.rotate=function(e,t){return t==null&&(t=this.center()),this.metadata.angle+=e,this.metadata.angle%=360,this.clearCachedObjects(),this.points.map(function(n){return n.rotate(e,t)}),this.commit(),this.woohoo()},t.prototype.fitToBounds=function(e){var t,n,r,i,s;this.clearCachedObjects(),t=this.bounds(),r=t.width,n=t.height,i=e.width/t.width,s=e.height/t.height;if(isNaN(i)||i===Infinity||i===-Infinity||i===0)i=1;if(isNaN(s)||s===Infinity||s===-Infinity||s===0)s=1;i=Math.max(1e-5,i),s=Math.max(1e-5,s),this.scale(i,s,new J(t.x,t.y)),this.nudge(e.x-t.x,t.y-e.y);if(this.points.toString().indexOf("NaN")>-1)debugger},t.prototype.overlapsRect=function(e){var t,n,r,i;if(this.bounds().overlapsBounds(e.bounds())){i=this.points.all();for(n=0,r=i.length;n<r;n++){t=i[n];if(t.insideOf(e))return!0}return this.lineSegmentsIntersect(e)}return!1},t.prototype.drawToCanvas=function(e){var t,n,r,i;e=this.setupToCanvas(e),i=this.points.all();for(n=0,r=i.length;n<r;n++){t=i[n];switch(t.constructor){case H:e.moveTo(t.x,t.y);break;case A:case N:case gt:e.lineTo(t.x,t.y);break;case h:case st:e.bezierCurveTo(t.x2,t.y2,t.x3,t.y3,t.x,t.y)}}return this.finishToCanvas(e)},t}(P),at=function(e){function t(e,n){this.data=e,this.content=n!=null?n:"",this.data=$.extend({x:0,y:0,"font-size":ui.utilities.typography.sizeControl.read(),"font-family":ui.utilities.typography.faceControl.selected.val},this.data),this.data.x=kt(this.data.x),this.data.y=kt(this.data.y),t.__super__.constructor.call(this,this.data),this.transformations=new ht(this,[new Y(0),new tt(1,1),new pt(0,0)]),this.origin=new J(this.data.x,this.data.y),this.textEditable=new lt(this),this}return cn(t,e),t.prototype.type="text",t.prototype.caching=!1,t.prototype.setContent=function(e){return this.content=e,this.commit()},t.prototype.setSize=function(e){return this.data["font-size"]=e},t.prototype.setFace=function(e){return this.data["font-family"]=e},t.prototype.commit=function(){return this.data.x=this.origin.x,this.data.y=this.origin.y,this.rep.textContent=this.content,this.transformations.commit(),t.__super__.commit.apply(this,arguments)},t.prototype.editableMode=function(){return this.textEditable.show(),this.hide(),ui.textEditing=this,ui.selection.elements.deselectAll()},t.prototype.displayMode=function(){return this.textEditable.hide(),this.show(),ui.textEditing=void 0,this.adjustForScale()},t.prototype.show=function(){return this.rep.style.display="block"},t.prototype.hide=function(){return this.rep.style.display="none"},t.prototype.originRotated=function(){return this.origin.clone().rotate(this.metadata.angle,this.center())},t.prototype.simulateInSandbox=function(){return $("#text-sandbox").text(this.content).css({"font-size":this.data["font-size"],"font-family":this.data["font-family"]})},t.prototype.selectAll=function(){this.editableMode(),this.textEditable.focus(),document.execCommand("selectAll",!1,null)},t.prototype["delete"]=function(){return t.__super__["delete"].apply(this,arguments),this.textEditable.hide()},t.prototype.toSVG=function(){var e;return e=t.__super__.toSVG.apply(this,arguments),e.textContent=this.content,e},t.prototype.normalizedOrigin=function(){return this.origin.clone().rotate(-this.metadata.angle,this.center())},t.prototype.nudge=function(e,t){return this.origin.nudge(e,t),this.adjustForScale(),this.commit()},t.prototype.rotate=function(e,t,n){var r,i;return t==null&&(t=this.center()),n==null&&(n=!0),this.metadata.angle+=e,this.metadata.angle%=360,i=this.center(),r=this.center().rotate(e,t),this.origin.nudge(r.x-i.x,i.y-r.y),this.transformations.get("rotate").rotate(e),n&&this.adjustForScale(),this.commit()},t.prototype.scale=function(e,t,n){var r;return r=this.metadata.angle,r!==0&&this.rotate(360-r,n),this.origin.scale(e,t,n),this.transformations.get("scale").scale(e,t),this.adjustForScale(),r!==0&&this.rotate(r,n),this.commit()},t.prototype.adjustForScale=function(){var e,t,n;return t=this.transformations.get("scale"),n=this.transformations.get("translate"),e=this.metadata.angle,this.rotate(-e,this.center(),!1),n.y=(t.y-1)/t.y*-this.origin.y,n.x=(t.x-1)/t.x*-this.origin.x,this.rotate(e,this.center(),!1),this.commit()},t.prototype.hover=function(){ui.selection.elements.all.has(this)},t.prototype.unhover=function(){return $("#text-underline").hide()},t.prototype.drawToCanvas=function(){},t.prototype.clone=function(){var e;return e=t.__super__.clone.apply(this,arguments),e.setContent(this.content),e},t.prototype.width=function(){return this.simulateInSandbox(),$("#text-sandbox")[0].clientWidth*this.transformations.get("scale").x},t.prototype.height=function(){return this.data["font-size"]*this.transformations.get("scale").y},t.prototype.xRange=function(){return new K(this.origin.x,this.origin.x+this.width())},t.prototype.yRange=function(){return new K(this.origin.y-this.height(),this.origin.y)},t.prototype.overlapsRect=function(e){return this.bounds().toRect().overlaps(e)},t.prototype.setupToCavnas=function(e){var t,n;return n=this.transformations.get("scale"),t=this.originRotated(),e.translate(t.x,t.y),e.rotate(this.metadata.angle*(Math.PI/180)),e.scale(n.x,n.y),e.font=""+this.data["font-size"]+"px "+this.data["font-family"],e},t.prototype.drawToCanvas=function(e){var t;return t=this.transformations.get("scale"),e=this.setupToCavnas(e),e.fillText(this.content.strip(),0,0),e=this.finishToCanvas(e)},t.prototype.finishToCanvas=function(e){var t,n;return n=this.transformations.get("scale"),t=this.originRotated(),e.scale(1/n.x,1/n.y),e.rotate(-this.metadata.angle*(Math.PI/180)),e.translate(-t.x,-t.y),e},t}(P),lt=function(){function e(e){this.owner=e}return e.prototype.refresh=function(){var e,t,n,r,i,s;return this.$rep.text(this.owner.content),this.owner.data["font-size"]!=null&&this.$rep.css({"font-size":kt(this.owner.data["font-size"])*ui.canvas.zoom+"px"}),this.owner.data["font-family"]!=null&&this.$rep.css({"font-family":this.owner.data["font-family"]}),s=this.owner.transformations.get("translate"),this.owner.rep.textContent===""&&(r=!0,this.owner.rep.textContent="[FILLER]",this.$rep.text("[FILLER]")),n=this.owner.$rep.offset(),e=n.left-ui.canvas.normal.x,i=n.top-ui.canvas.normal.y,this.$rep.css({left:e.px(),top:i.px(),color:this.owner.data.fill}),this.$rep.css,this.owner.transformations.applyAsCSS(this.rep),t=this.$rep.offset(),r&&(this.$rep.text(""),this.owner.rep.textContent=""),this.$rep.css({left:(e+n.left-t.left).px(),top:(i+n.top-t.top).px()})},e.prototype.show=function(){var e=this;return this.$rep=$('<div class="text" contenteditable="true"\n   quarantine spellcheck="false">'+this.owner.content+"</div>"),this.rep=this.$rep[0],$("#typography").append(this.$rep),this.$rep.one("blur",function(){return e.commit(),e.owner.displayMode()}),this.rep.style.display="block",this.refresh()},e.prototype.hide=function(){if(this.rep==null)return;return this.rep.remove(),this.rep=void 0},e.prototype.focus=function(){return this.$rep.focus()},e.prototype.commit=function(){var e,t;return t=this.owner.originRotated(),this.owner.setContent(this.$rep.text().replace(/$\s+/g,"")),e=this.owner.originRotated(),this.owner.nudge(t.x-e.x,t.y-e.y)},e}(),dt=function(e){function t(e){this.data=e}return cn(t,e),t.prototype.type="tspan",t}(P),p=!0,Kt={merge:function(e){var t,n,r,i,s,o;this._reset(),t=e.map(function(e){return e.clone()});while(t.length>1)o=[t[0],t[1]],r=o[0],s=o[1],i=this._mergePair(r,s),t=[i].concat(t.slice(2));return n=t[0],n.appendTo("#main"),n.eyedropper(e[0]),ui.selection.elements.select(n)},_segments:[],_segmentAccumulation:[],_intersections:[],_keep:function(e){return this._segmentAccumulation.push(e),p&&ui.annotations.drawDot(e,ui.colors.black.hex,4),e.flag("kept")},_commitCurrentSegment:function(){if(this._segmentAccumulation.length===0)return;return this._segments.push((new z(this._segmentAccumulation)).ensureMoveTo()),this._segmentAccumulation=[]},_getIntersection:function(e){var t;t=this._intersections.filter(function(t){return t.intersection.has(function(t){return t.equal(e)})});if(t.length>0)return t[0]},_packageSegmentsIntoPathElement:function(){var e,t;return t=new U([],[],this._segments),e=new F({d:t.toString(),fill:(new u(0,0,0,.4)).toRGBString(),stroke:ui.colors.black.hex}),e},_reset:function(){return this._segments=this._segmentAccumulation=this._intersections=[]},_splitAtIntersections:function(e,t){var n,r,i,s,o,u,a,f,l,c;if(t.length===0)return e;a=e.points.all(),c=e.lineSegments();for(f=0,l=c.length;f<l;f++)r=c[f],n=t.filter(function(e){return e.aline.equal(r)||e.bline.equal(r)}),n.length>0&&(o=r.source,o.succ instanceof st&&o.succ.replaceWithCurveTo(),u=n.reduce(function(e,t){return e.concat(t.intersection)},[]),u=u.filter(function(e){var t;return t=a.filter(function(t){return t.within(.1,e)}).length===0,t&&a.push(e),t}),i=r.splitAt(u),s=i.map(function(e){return e.source}),s.slice(0,s.length-1).forEach(function(e){return e.flag("desired")}),e.points.replace(o,s));return e},_desiredPointsRemaining:function(e){return e.filter(function(e){return e.flagged("desired")&&!e.flagged("kept")})},_findAndSplitIntersections:function(e,t){return this._intersections=Wt.analysis.intersections(e,t),e=this._splitAtIntersections(e,this._intersections),t=this._splitAtIntersections(t,this._intersections),[e,t]},_removeOverlappingAdjecentPoints:function(e){return e.points.forEach(function(t){if(t.within(1e-5,t.succ))return e.points.remove(t)})},_flagDesiredPoints:function(e,t){return e.points.all().forEach(function(e){if(!e.insideOf(t))return e.flag("desired")}),t.points.all().forEach(function(t){if(!t.insideOf(e))return t.flag("desired")}),[e,t]},_mergePair:function(e,t){var n,r,i,s,o;return this._intersections=Wt.analysis.intersections(e,t),s=this._findAndSplitIntersections(e,t),e=s[0],t=s[1],o=this._flagDesiredPoints(e,t),e=o[0],t=o[1],r=e.points.withoutMoveTos(),n=t.points.withoutMoveTos(),this._walk(r,n),i=this._packageSegmentsIntoPathElement(),this._reset(),i},_walk:function(e,t){var n,r,i,s,o,u,a,f,l,c,h,d,v,m,g,y,b,w,E,S;n=e.owner,S=e.segments;for(y=0,w=S.length;y<w;y++){m=S[y],c=m.points;if(c[0].flagged("kept")){this._commitCurrentSegment(),d=this._desiredPointsRemaining(e),h=this._desiredPointsRemaining(t);if(d.length===0||h.length===0)return;if(d.length>0)return e.movePointToFront(d[0]),this._walk(e,t);if(h.length>0)return t.movePointToFront(h[0]),this._walk(t,e)}for(b=0,E=c.length;b<E;b++){l=c[b],p&&ui.annotations.drawDot(l,ui.colors.green.hex,8),o=this._getIntersection(l);if(o)return f=t.filter(function(e){return e.equal(l)})[0],f.flag("kept"),u=Wt.conversions.pathSegment(f,f.succ),a=Wt.conversions.pathSegment(f.prec,f),f.within(.01,f.succ)&&(g=!0),f.within(.01,f.prec)&&(v=!0),u.midPoint().insideOf(n)?a.midPoint().insideOf(n)?Qt("PANIC"):(t=t.reverse(),f=t.filter(function(e){return e.equal(l)})[0],r=f.succ):r=f.succ,s=r.segment,t.moveSegmentToFront(s),s.movePointToFront(r),this._keep(l),this._walk(t,e);if(l.flagged("kept"))break;this._keep(l)}this._commitCurrentSegment(),i=this._desiredPointsRemaining(m.points),i.length===0?e.segments.without(m).length===0?this._walk(t,e):(e.segments=e.segments.cannibalize(),this._walk(e,t)):(m.movePointToFront(i[0]),this._walk(e,t))}return this._commitCurrentSegment(),this._walk(t,e)}},S=function(){function e(e,t,n,r,i){this.key=e,this.name=t,this.path=n,this.thumbnail=r,this.contents=i,this}return e.prototype.fromService=function(e){switch(e){case services.local:return function(e){return new O(e)};case services.permalink:return function(e){return new I(e)};case services.dropbox:return function(e,t,n){return new d(e,t,n)}}},e.prototype.use=function(e){var t=this;return e==null&&(e=!1),ui.file=this,ui.menu.refresh(),""+window.location.pathname+window.location.search!==this.expectedURL()&&history.replaceState("","",this.expectedURL()),ui.menu.items.filename.refresh(),this.contents!=null?e&&(Mt.parseAndAppend(this.contents),this.archive!=null?(archive.loadFromString(this.archive),ui.utilities.history.deleteThumbsCached().build(),delete this.archive):(console.log("No saved archive found that matches the file, starting with a fresh one."),archive.setup())):this.load(function(){return t.use()}),this},e.prototype.get=function(e,t){return this.service.get(this.key,e,t),this},e.prototype.put=function(e,t){return this.service.put(this.key,this.contents,e,t),this},e.prototype.set=function(e){return this.contents=e!=null?e:Mt.makeFile(),this},e.prototype.save=function(e){return this.set(),this.put(e),this},e.prototype.hasChanges=function(){return this.contents!==Mt.makeFile()},e.prototype.toString=function(){var e;return e={key:this.key,name:this.name,path:this.path,service:this.service.name},e.toString()},e.prototype.expectedURL=function(){switch(this.constructor){case I:return"/?p="+this.key;default:return"/"}},e.prototype.readonly=!1,e}(),window.LocalFile=O,window.File=S,O=function(e){function t(e){this.key=e,this.service=services.local,this.name=this.key,this.path="",this.displayLocation="local storage",this.load(),t.__super__.constructor.call(this,this.key,this.name,this.path,this.thumbnail,this.contents),this}return cn(t,e),t.prototype.load=function(e){var t=this;return e==null&&(e=function(){}),this.get(function(n){return t.contents=n.contents,t.archive=n.archive,t===ui.file&&t.use(!0),e(n)}),this},t}(S),window.LocalFile=O,I=function(e){function t(e){this.key=e,this.service=services.permalink,this.path="",this.displayLocation="permalink ",t.__super__.constructor.call(this,this.key,this.name,this.path,this.thumbnail)}return cn(t,e),t.prototype.load=function(){var e=this;return this.get(function(t){e.contents=t.contents,e.name=t.file_name;if(e===ui.file)return e.use()}),this},t.prototype.use=function(e){t.__super__.use.call(this,e);if(this.contents!=null)return history.replaceState("","","/?p="+this.key)},t}(S),d=function(e){function t(e){this.key=e,this.service=services.dropbox,this.name=this.key.match(/[^\/]+$/)[0],this.path=this.key.substring(0,this.key.length-this.name.length),this.displayLocation=this.key,t.__super__.constructor.call(this,this.key,this.name,this.path,this.thumbnail)}return cn(t,e),t.prototype.load=function(e){var t=this;return e==null&&(e=function(){}),this.get(function(n){return t.contents=n.contents,archive.get(),t===ui.file&&t.use(!0),e(n)},function(e){t.contents=Mt.makeFile();if(t===ui.file)return t.use(!0)}),this},t.prototype.put=function(e){return archive.put(),t.__super__.put.call(this,e)},t}(S),Nt={albq:'<svg id="main" width="800" height="470.59" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:mondrian="http://mondrian.io/xml" viewbox="0 0 800 470.59" enable-background="new 0 0 800 470.59" style="width: 800px; height: 470.59px; -webkit-transform: scale(1);">\n  <rect opacity="1" fill="rgb(199, 15, 46)" fill-opacity="1" stroke="none" stroke-width="1" stroke-linecap="round" stroke-linejoin="miter" stroke-miterlimit="4" stroke-dasharray="none" stroke-opacity="1" id="rect3491" width="800" height="470.58984" x="0" y="0.00015633789" >\n  </rect>\n  <path id="path3290" fill="rgb(245, 220, 15)" fill-rule="evenodd" stroke="none" stroke-width="1px" stroke-linecap="butt" stroke-linejoin="miter" stroke-opacity="1" fill-opacity="1" d="M394.625,383.43375 C381.16854,383.95982 376.92586,396.10106 374.875,403.46875 C372.73136,411.16976 373.54029,423.67459 382,423.7775 C385.09344,423.81513 388.0005,422.0739 390.09375,420.21875 L384.875,442.21875 L393.5,442.21875 L404.4375,395.78125 C404.95468,393.59667 404.72172,391.07616 403.75,388.875 C401.94548,384.78738 398.68662,383.27496 394.625,383.43375 M393.34375,389.78125 C395.26133,389.83533 397.13959,390.74597 396.53125,393.3125 L391.25,415.59375 C379.11731,421.56397 381.42886,411.35222 383.375,402.96875 C384.35154,398.76206 386.57754,392.68705 390.3125,390.4375 C391.02749,390.00687 392.1932,389.7488 393.34375,389.78125 M421.3125,384.09 L412.75,384.09 L407.9375,404.7775 C405.17878,416.63643 409.35555,423.26919 414.875,423.7775 C418.15997,424.08003 421.54456,422.35493 423.87944,419.06596 L422.75,423.09 L431.25,423.09 L440.5625,384.09 L432,384.09 L425.44194,411.70796 C423.41424,416.12473 419.5936,418.94076 416.3125,416.465 C413.65852,414.46243 415.31018,409.25358 416.4375,404.5275 L421.3125,384.09 M516.95447,383.43375 C503.49801,383.95982 499.25533,396.10106 497.20447,403.46875 C495.06083,411.16976 495.86976,423.67459 504.32947,423.7775 C507.42291,423.81513 510.32997,422.0739 512.42322,420.21875 L507.20447,442.21875 L515.82947,442.21875 L526.76697,395.78125 C527.28415,393.59667 527.05119,391.07616 526.07947,388.875 C524.27495,384.78738 521.01609,383.27496 516.95447,383.43375 M515.67322,389.78125 C517.5908,389.83533 519.46906,390.74597 518.86072,393.3125 L513.57947,415.59375 C501.44678,421.56397 503.75833,411.35222 505.70447,402.96875 C506.68101,398.76206 508.90701,392.68705 512.64197,390.4375 C513.35696,390.00687 514.52267,389.7488 515.67322,389.78125 M545.76329,384.09 L537.20079,384.09 L532.38829,404.7775 C529.62957,416.63643 533.80634,423.26919 539.32579,423.7775 C542.61076,424.08003 545.99535,422.35493 548.33023,419.06596 L547.20079,423.09 L555.70079,423.09 L565.01329,384.09 L556.45079,384.09 L549.89273,411.70796 C547.86503,416.12473 544.04439,418.94076 540.76329,416.465 C538.10931,414.46243 539.76097,409.25358 540.88829,404.5275 L545.76329,384.09 M463.125,383.40625 C455.93939,383.74932 452.75701,386.31345 449.25,390.09375 C444.85824,394.82776 442.19997,401.01352 441.375,408.21875 C440.52947,415.60356 444.72557,423.74517 451.375,423.78125 C456.75995,423.80993 461.45192,422.15464 465.5,416.34375 L463.05676,413.12906 C461.40372,415.01424 460.23986,415.98258 458.39644,416.78384 C455.27512,418.14056 451.48107,419.23399 449.73995,415.69399 C449.17445,414.54425 449.16151,412.84294 449.3125,410.71875 C463.67766,411.06162 470.27579,400.56019 471.13756,396.15181 C472.74417,387.93325 468.44611,383.1522 463.125,383.40625 M463.5,397.46875 C461.95149,401.52548 455.46221,405.30317 449.75628,405.35447 C450.96482,396.91546 454.90118,389.33747 459.875,388.96875 C465.30667,388.56609 464.31332,395.33803 463.5,397.46875 M587.92935,383.40625 C580.74374,383.74932 577.56136,386.31345 574.05435,390.09375 C569.66259,394.82776 567.00432,401.01352 566.17935,408.21875 C565.33382,415.60356 569.52992,423.74517 576.17935,423.78125 C581.5643,423.80993 586.25627,422.15464 590.30435,416.34375 L587.86111,413.12906 C586.20807,415.01424 585.04421,415.98258 583.20079,416.78384 C580.07947,418.14056 576.28542,419.23399 574.5443,415.69399 C573.9788,414.54425 573.96586,412.84294 574.11685,410.71875 C588.48201,411.06162 595.08014,400.56019 595.94191,396.15181 C597.54852,387.93325 593.25046,383.1522 587.92935,383.40625 M588.30435,397.46875 C586.75584,401.52548 580.26656,405.30317 574.56063,405.35447 C575.76917,396.91546 579.70553,389.33747 584.67935,388.96875 C590.11102,388.56609 589.11767,395.33803 588.30435,397.46875 M354.84446,384.09 L346.28196,384.09 L341.46946,404.7775 C338.71074,416.63643 342.88751,423.26919 348.40696,423.7775 C351.69193,424.08003 355.07652,422.35493 357.4114,419.06596 L356.28196,423.09 L364.78196,423.09 L374.09446,384.09 L365.53196,384.09 L358.9739,411.70796 C356.9462,416.12473 353.12556,418.94076 349.84446,416.465 C347.19048,414.46243 348.84214,409.25358 349.96946,404.5275 L354.84446,384.09 M315.37813,423.7775 C328.83459,423.25143 333.07727,411.11019 335.12813,403.7425 C337.27177,396.04149 336.46284,383.53666 328.00313,383.43375 C324.90969,383.39612 322.00263,385.13735 319.90938,386.9925 L326.25313,360.6175 L317.62813,360.6175 L306.19063,408.055 C304.45111,415.86104 306.38136,423.3441 315.37813,423.7775 M314.09688,410.52375 L318.75313,391.6175 C330.88582,385.64728 328.57427,395.85903 326.62813,404.2425 C325.65159,408.44919 323.42559,414.5242 319.69063,416.77375 C314.56894,418.67038 312.88313,415.66403 314.09688,410.52375 M287.15663,416.63765 L300.625,360.715 L309.25,360.715 L294.375,423.09 C289.83883,422.57067 288.15033,419.55539 287.15663,416.63765 M494.4375,384.09375 C491.55707,384.26624 488.73052,385.9659 486.6875,388.84375 L487.8125,384.8125 L479.3125,384.8125 L470,423.8125 L478.5625,423.8125 L485.125,396.1875 C488.08663,390.36739 493.58787,391.43816 496.71859,393.15257 L499.90625,386.03125 C498.68568,384.92568 497.25033,384.26893 495.6875,384.125 C495.27688,384.08718 494.84899,384.06911 494.4375,384.09375 M279.34375,353.0625 C275.35785,353.05705 272.13945,354.9123 269.75,357.34375 C276.33396,354.89877 284.97578,355.42612 282.125,367.09375 L275.375,394.6875 C267.83796,396.40612 261.51167,396.33588 255.90625,394.78125 C256.435,393.02259 256.96397,391.34882 257.5,389.84375 C262.21528,376.6043 269.37175,365.06154 275.5,359.34375 C275.25117,359.31468 275.00252,359.28736 274.75,359.28125 C266.9218,359.09196 257.68856,368.03927 250.5,385.34375 C247.42153,392.75433 246.52867,401.53171 246.90625,412.0625 C246.9977,414.61292 245.96073,415.84375 242.75,415.84375 L233.8125,415.84375 C230.06115,415.84375 227.31254,418.60908 225.40625,421.6875 C224.45847,423.21805 223.15246,423.71875 221.40625,423.71875 L211.03125,423.71875 C206.57801,423.71875 202.74003,429.12391 201.59375,431.6875 L215.4375,431.71875 C218.9619,431.7267 222.90385,430.22707 223.84375,427.28125 C224.45839,425.35484 225.23385,423.84375 227.1875,423.84375 L237.25,423.84375 C246.53998,423.84375 250.83126,411.82928 254.15625,400.71875 C259.90669,403.23586 266.88029,402.82892 273.59375,401.96875 L270,416.71875 C270.94199,419.86009 274.014,423.09375 277.25,423.09375 L289.625,371.21875 C291.17932,364.70318 292.03438,357.19937 285.25,354.34375 C283.12988,353.45137 281.15552,353.06498 279.34375,353.0625 M243.78125,404.53125 C244.30746,389.04608 250.37557,371.20112 262.15257,362.43138 C242.39633,365.95552 238.5331,389.72437 243.78125,404.53125z" >\n  </path>\n  <path opacity="1" fill="rgb(245, 220, 15)" fill-opacity="1" fill-rule="evenodd" stroke="none" stroke-width="1px" stroke-linecap="butt" stroke-linejoin="miter" stroke-opacity="1" d="M140.80512,124.44307 C140.48954,116.8959 137.95674,109.29261 133.84446,102.14704 C145.40584,83.622779 143.15705,58.912707 127.06066,42.816361 C120.00663,35.762334 111.31952,31.366697 102.20147,29.624435 C104.88234,31.270212 107.41539,33.247368 109.73654,35.568516 C122.55956,48.391552 125.06105,67.622572 117.27168,82.966804 C109.71805,77.067306 100.88709,72.515567 91.572737,67.697681 C84.623787,64.10338 79.717594,57.217864 77.806247,40.45197 C71.216273,40.15034 66.12818,42.142295 62.316259,45.954216 C58.504317,49.766157 56.512369,54.854243 56.814014,61.444203 C73.579929,63.355529 80.465367,68.261662 84.059727,75.210691 C88.877607,84.525041 93.429347,93.356005 99.328847,100.90964 C83.984607,108.69901 64.753659,106.19759 51.930561,93.374496 C49.609412,91.053347 47.632256,88.520293 45.98648,85.839425 C47.728734,94.957482 52.124456,103.64465 59.178405,110.69861 C75.274701,126.79491 99.984907,129.04385 118.50909,117.48242 C125.65466,121.59469 133.25786,124.12744 140.80512,124.44307z" id="path3404" >\n  </path>\n  <path opacity="1" fill="rgb(245, 220, 15)" fill-opacity="1" stroke="none" stroke-width="11.78761100999999900" stroke-linecap="round" stroke-linejoin="miter" stroke-miterlimit="4" stroke-dasharray="none" stroke-opacity="1" d="M384.15625,22.34375 L384.15625,129.125 C381.52847,129.81543 378.98223,130.67432 376.5,131.6875 L376.5,46.03125 L364.5,46.03125 L364.5,138.1875 C358.29317,142.49038 352.89663,147.88692 348.59375,154.09375 L256.4375,154.09375 L256.4375,166.09375 L342.09375,166.09375 C341.08057,168.57598 340.22168,171.12222 339.53125,173.75 L232.75,173.75 L232.75,185.75 L337.625,185.5 C337.53694,186.85258 337.5,188.21954 337.5,189.59375 C337.5,190.96796 337.53694,192.33501 337.625,193.6875 L232.75,193.4375 L232.75,205.4375 L339.53125,205.4375 C340.22168,208.06458 341.08057,210.61248 342.09375,213.09375 L256.4375,213.09375 L256.4375,225.09375 L348.625,225.09375 C352.92561,231.28867 358.29982,236.67401 364.5,240.96875 L364.5,333.15625 L376.5,333.15625 L376.5,247.46875 C378.98223,248.48097 381.52847,249.34152 384.15625,250.03125 L384.15625,356.84375 L396.15625,356.84375 L395.90625,251.9375 C397.25883,252.02546 398.62579,252.0625 400,252.0625 C401.37421,252.0625 402.74117,252.02546 404.09375,251.9375 L403.84375,356.84375 L415.84375,356.84375 L415.84375,250.03125 C418.47153,249.34152 421.01777,248.48097 423.5,247.46875 L423.5,333.15625 L435.5,333.15625 L435.5,240.96875 C441.70018,236.67401 447.07439,231.28867 451.375,225.09375 L543.5625,225.09375 L543.5625,213.09375 L457.90625,213.09375 C458.91943,210.61248 459.77832,208.06458 460.46875,205.4375 L567.25,205.4375 L567.25,193.4375 L462.375,193.6875 C462.46306,192.33501 462.5,190.96796 462.5,189.59375 C462.5,188.21954 462.46306,186.85258 462.375,185.5 L567.25,185.75 L567.25,173.75 L460.46875,173.75 C459.77832,171.12222 458.91943,168.57598 457.90625,166.09375 L543.5625,166.09375 L543.5625,154.09375 L451.40625,154.09375 C447.10337,147.88692 441.70683,142.49038 435.5,138.1875 L435.5,46.03125 L423.5,46.03125 L423.5,131.6875 C421.01777,130.67432 418.47153,129.81543 415.84375,129.125 L415.84375,22.34375 L403.84375,22.34375 L404.09375,127.21875 C402.74117,127.13069 401.37421,127.09375 400,127.09375 C398.62579,127.09375 397.25883,127.13069 395.90625,127.21875 L396.15625,22.34375 L384.15625,22.34375 M400,139.0625 C427.94161,139.06249 450.5,161.65213 450.5,189.59375 C450.49998,217.53538 427.94162,240.09375 400,240.09375 C372.05837,240.09374 349.5,217.53538 349.5,189.59375 C349.5,161.65213 372.05838,139.0625 400,139.0625" id="path3423" >\n  </path>\n  <path id="path3458" fill="rgb(245, 220, 15)" fill-rule="evenodd" stroke="none" stroke-width="1px" stroke-linecap="butt" stroke-linejoin="miter" stroke-opacity="1" fill-opacity="1" d="M371.23106,205.77851 C369.29484,210.95758 371.19003,215.67896 374.7666,218.15287 C381.53891,197.75345 387.50725,184.36933 394.74236,171.83738 L376.00403,171.83738 L370.87751,180.49944 L384.48931,180.49944 C380.0699,188.19847 375.31518,194.85415 371.23106,205.77851 M404.21875,170.25 C397.53833,170.25 391.24637,178.65645 390.15625,189 C389.06613,199.34356 393.60084,207.71874 400.28125,207.71875 C406.96167,207.71875 413.25362,199.34356 414.34375,189 C415.43387,178.65644 410.89917,170.25 404.21875,170.25 M401.46875,177.84375 C405.06775,177.84375 408.34127,182.85241 408.78125,189 C409.22124,195.14759 406.66151,200.125 403.0625,200.125 C399.46349,200.125 396.18998,195.14759 395.75,189 C395.31003,182.85241 397.86974,177.84375 401.46875,177.84375 M438.125,159.96875 C428.35549,167.45602 419.05386,175.60093 417.5,188.09375 C416.47978,196.29615 419.06754,207.70302 427.25,207.71875 C431.87039,207.72763 438.82592,205.12517 441.625,189.96875 C443.62668,179.13008 438.156,171.79085 433.375,170.46875 C435.93931,167.09182 437.87506,165.38544 441,162.84375 L438.125,159.96875 M436.25,189.90625 C436.83451,197.46827 431.6068,203.1044 427.125,198.53125 C423.58711,194.92125 421.24957,186.94715 428,177.96875 C434.44668,178.06469 435.85259,184.76478 436.25,189.90625 M362.83417,206.83917 L369.3749,171.92577 L362.21545,171.92577 L356.90518,199.89321 C355.86506,205.37119 359.31092,206.83917 362.83417,206.83917z" >\n  </path>\n</svg>'
},window.archive={setup:function(){return this.events=[{"do":function(){},undo:function(){},position:0,current:!0}]},undo:function(){return this.goToEvent(this.currentPosition()-1)},redo:function(){return this.goToEvent(this.currentPosition()+1)},goToEnd:function(){return this.goToEvent(this.events.length-1)},goToBeginning:function(){return this.goToEvent(0)},eventsUpToCurrent:function(){return this.events.slice(0,this.currentPosition()+1)},currentEvent:function(){var e;return e=this.events.filter(function(e){return e.current}),e!=null?e[0]:null},currentPosition:function(){var e;return e=this.currentEvent(),e!=null?e.position:-1},currentlyAtEnd:function(){return this.currentPosition()===this.events.length-1},currentlyAtBeginning:function(){return this.currentPosition()===0},addEvent:function(e){var t,n;this.events.length&&(this.events=this.eventsUpToCurrent()),ui.utilities.history.deleteThumbsCached(this.currentPosition()),e.position=this.events.length,(n=this.currentEvent())!=null&&(n.current=!1),e.current=!0,this.events.push(e),t=ui.utilities.history;if(e.position%t.every===0)return t.buildThumbs(t.every,e.position)},addMapEvent:function(e,t,n){return this.addEvent(new M(e,t,n))},addExistenceEvent:function(e){return this.addEvent(new E(e))},addPointExistenceEvent:function(e,t,n){return this.addEvent(new R(e,t,n))},addAttrEvent:function(e,t,n){if(e.length===0)return;return this.addEvent(new r(e,t,n))},addZIndexEvent:function(e,t,n){if(e.length+t===0)return;return this.addEvent(new yt(e,t,n))},goToEvent:function(e){var t,n,r,i,s,o,u,a,f,l;r=this.currentPosition(),t=this.currentEvent(),t&&(t.current=!1),n=Math.abs(e-r),e>this.events.length-1&&(e=this.events.length-1,this.events[e].current=!0),e<0?(e=0,this.events[0].current=!0):this.events[e].current=!0;if(e>r)for(i=s=u=r+1;u<=e?s<=e:s>=e;i=u<=e?++s:--s)(a=this.events[i])!=null&&a["do"]();else if(e<r)for(i=o=r,f=e+1;r<=f?o<=f:o>=f;i=r<=f?++o:--o)(l=this.events[i])!=null&&l.undo();if(!this.simulating)return ui.selection.refresh()},runThrough:function(e,t){var n=this;e==null&&(e=30),t==null&&(t=0),this.goToEvent(t);if(t<this.events.length)return setTimeout(function(){return n.runThrough(e,t+1)},e)},diffState:function(){var e;return e={},Ct.$main.children().each(function(t,n){var r,i,s,o,u;e[t]={},o=n.attributes,u=[];for(i=0,s=o.length;i<s;i++)r=o[i],u.push(e[t][r.name]=r.value);return u}),e},saveDiffState:function(){return this.lastDiffState=this.diffState(),this.atMostRecentEvent=Mt.makeFile()},fileAt:function(e){var t,n;return t=this.currentPosition(),this.goToEvent(e),n=Mt.makeFile(),this.goToEvent(t),n},toJSON:function(){return this.events.length>1?{f:hex_md5(Mt.makeFile()),e:this.events.slice(1),p:this.currentPosition()}:{}},toString:function(){return JSON.stringify(this.toJSON())},loadFromString:function(e,t){var n,r,i,s;return t==null&&(t=!0),e=JSON.parse(e),Object.keys(e).length===0?this.setup():t&&e.f!==hex_md5(ui.file.contents)?(console.log("File contents md5 mismatch"),this.setup()):(n=e.e,i=n.map(function(e){return(new w).fromJSON(e)}),r=1,i.map(function(e){return e.position=r,r+=1}),this.setup(),this.events=this.events.concat(i),this.events[0].current=!1,(s=this.events[parseInt(e.p,10)])!=null?s.current=!0:void 0)},put:function(){return $.ajax({url:""+Z.MEOWSET.ENDPOINT+"/baddeley/put",type:"POST",dataType:"json",data:{session_token:ui.account.session_token,file_hash:hex_md5(ui.file.contents),archive:archive.toString()},success:function(e){}})},get:function(){var e=this;return $.ajax({url:""+Z.MEOWSET.ENDPOINT+"/baddeley/get",data:{session_token:ui.account.session_token,file_hash:hex_md5(ui.file.contents)},dataType:"json",success:function(t){return e.loadFromString(t.archive)}})}},nn.push(function(){if(ui.file==null)return archive.setup()}),w=function(){function e(){}return e.prototype.current=!1,e.prototype.position=void 0,e.prototype.toString=function(){return JSON.stringify(this.toJSON())},e.prototype.fromJSON=function(e){var t,n,i,s,o,u,a,f,l;typeof e=="string"&&(e=JSON.parse(e));switch(e.t[0]){case"m":return o={n:"nudge",s:"scale",r:"rotate"}[e.t[2]],u=e.i,t=e.a,new M(o,u,t);case"e":return i=new E(e.a),i.mode={d:"delete",c:"create"}[e.t[2]],i;case"p":return l=e.p,n=e.i,s=parseInt(e.e,10),a={d:"delete",c:"create"}[e.t[2]],f=new R(s,l,n),f.mode=a,f;case"a":return new r(e.i,e.c,e.o);case"z":return new yt(e.ib,e.ia,e.d)}},e}(),window.Event=w,M=function(e){function t(e,t,n){var r=this;this.funKey=e,this.indexes=t,this.args=n,this.operatingOn=this.indexes instanceof Array?"elems":"points";switch(this.funKey){case"nudge":this._undo=function(e){return e.nudge(-r.args.x,-r.args.y,!0)},this._do=function(e){return e.nudge(r.args.x,r.args.y,!0)};break;case"scale":this.args.x=Math.max(this.args.x,1e-5),this.args.y=Math.max(this.args.y,1e-5),this._undo=function(e){return e.scale(1/r.args.x,1/r.args.y,new J(r.args.origin))},this._do=function(e){return e.scale(r.args.x,r.args.y,new J(r.args.origin))};break;case"rotate":this._undo=function(e){return e.rotate(-r.args.angle,new J(r.args.origin))},this._do=function(e){return e.rotate(r.args.angle,new J(r.args.origin))}}}return cn(t,e),t.prototype.undo=function(){return this._execute(this._undo)},t.prototype["do"]=function(){return this._execute(this._do)},t.prototype._execute=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v;if(this.operatingOn==="elems"){archive.simulating||(ui.selection.points.deselectAll(),ui.selection.elements.deselectAll()),h=this.indexes,d=[];for(a=0,l=h.length;a<l;a++)n=h[a],t=en(parseInt(n,10)),archive.simulating||ui.selection.elements.selectMore(t),e(t),d.push(t.redrawHoverTargets());return d}p=this.indexes,v=[];for(n in p){if(!ln.call(p,n))continue;u=p[n],t=en(parseInt(n,10)),archive.simulating||(ui.selection.elements.deselectAll(),ui.selection.points.deselectAll());for(f=0,c=u.length;f<c;f++){o=u[f],s=t.points.at(parseInt(o,10));if(this.args.antler!=null){switch(this.args.antler){case"p2":s.antlers.succp2!=null?(i=s.antlers.succp2.angle360(s),e(s.antlers.succp2),r=s.antlers.succp2.angle360(s),s.antlers.lockAngle&&s.antlers.basep3.rotate(r-i,s),s.antlers.visible&&s.antlers.redraw()):console.log("wtf");break;case"p3":i=s.antlers.basep3.angle360(s),e(s.antlers.basep3),r=s.antlers.basep3.angle360(s),s.antlers.lockAngle&&s.antlers.succp2.rotate(r-i,s),s.antlers.visible&&s.antlers.redraw()}s.antlers.commit()}else e(s);archive.simulating||ui.selection.points.selectMore(s)}t.commit(),v.push(t.redrawHoverTargets())}return v},t.prototype.toJSON=function(){return{t:"m:"+{nudge:"n",scale:"s",rotate:"r"}[this.funKey],i:this.indexes,a:this.args}},t}(w),r=function(e){function t(e,t,n){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A;this.indexes=e,this.changes=t,this.oldValues=n,typeof this.indexes=="number"&&(this.indexes=[this.indexes]),typeof this.changes=="string"&&(this.changes=[this.changes]),i=this.oldValues==null,i&&(this.oldValues={}),this.attrs=[],this.microManMode=!1;if(this.changes instanceof Array){this.attrs=this.changes,this.changes={},o=en(this.indexes[0]),x=this.attrs;for(c=0,v=x.length;c<v;c++)r=x[c],this.changes[r]=o.data[r].toString();if(i){T=this.indexes;for(h=0,m=T.length;h<m;h++){u=T[h],s=en(u),this.oldValues[u]={},N=this.attrs;for(p=0,g=N.length;p<g;p++)r=N[p],this.oldValues[u][r]=s.dataArchived[r].toString(),s.updateDataArchived(r)}}}else if(typeof this.changes=="object"){a=Object.keys(this.changes),f=a.filter(function(e){return/\d+/gi.test(e)});if(a.length===f.length){this.microManMode=!0;if(i){C=this.indexes;for(d=0,y=C.length;d<y;d++){u=C[d],s=en(u),this.oldValues[u]={},k=this.changes[u];for(r in k){if(!ln.call(k,r))continue;l=k[r],this.oldValues[u][r]=s.dataArchived[r].toString(),s.updateDataArchived(r)}}}}else{this.attrs=Object.keys(this.changes);if(i){L=this.indexes;for(E=0,b=L.length;E<b;E++){u=L[E],s=en(u),this.oldValues[u]={},A=this.attrs;for(S=0,w=A.length;S<w;S++)r=A[S],this.oldValues[u][r]=s.dataArchived[r].toString(),s.updateDataArchived(r)}}}}}return cn(t,e),t.prototype["do"]=function(){return this.applyValues(this.changes,this.microManMode)},t.prototype.undo=function(){return this.applyValues(this.oldValues,!0)},t.prototype.applyValues=function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p;l=this.indexes,p=[];for(o=0,a=l.length;o<a;o++){i=l[o],r=en(parseInt(i,10));if(t){c=e[i];for(n in c){if(!ln.call(c,n))continue;s=c[n],r["set"+n.camelCase().capitalize()](s)}}else{h=this.attrs;for(u=0,f=h.length;u<f;u++)n=h[u],r["set"+n.camelCase().capitalize()](e[n])}p.push(r.commit())}return p},t.prototype.toJSON=function(){return{t:"a",i:this.indexes,c:this.changes,o:this.oldValues}},t}(w),yt=function(e){function t(e,t,n){var r,i,s,o;this.indexesBefore=e,this.indexesAfter=t,this.direction=n,s=function(e){return e.moveForward()},r=function(e){return e.moveBack()},o=function(e){return e.bringToFront()},i=function(e){return e.sendToBack()},console.log(this.direction);switch(this.direction){case"mf":this._do=s,this._undo=r;break;case"mb":this._do=r,this._undo=s;break;case"mff":this._do=o,this._undo=i;break;case"mbb":this._do=i,this._undo=o}}return cn(t,e),t.prototype["do"]=function(){var e,t,n,r;r=this.indexesBefore;for(t=0,n=r.length;t<n;t++)e=r[t],this._do(en(e));return ui.elements.sortByZIndex()},t.prototype.undo=function(){var e,t,n,r;r=this.indexesAfter;for(t=0,n=r.length;t<n;t++)e=r[t],this._undo(en(e));return ui.elements.sortByZIndex()},t.prototype.toJSON=function(){return{t:"z",ib:this.indexesBefore,ia:this.indexesAfter,d:this.direction}},t}(w),E=function(e){function t(e){var t,n,r,i,s,o,u,a,f,l,c,h,p;this.args={};if(e instanceof Object&&!(e instanceof Array)){r=Object.keys(e),s=r.filter(function(e){return e.match(/^[\d]*$/gi)!==null});if(r.length===s.length)return this.args=e,this}if(typeof e=="number"){t=(h=en(e))!=null?h.repToString():void 0;if(t==null){ui.selection.elements.all.map(function(e){return e["delete"]()});return}this.args[e]=this.cleanUpStringElem(t),this.mode="delete"}else if(e instanceof Array)if(typeof e[0]=="number"){for(a=0,l=e.length;a<l;a++){n=e[a],t=(p=en(e))!=null?p.repToString():void 0;if(t==null){ui.selection.elements.all.map(function(e){return e["delete"]()});return}this.args[n]=this.cleanUpStringElem(t),this.mode="delete"}this.mode="delete"}else{Ft(e[0])&&(o=!!e[0].parentNode,u=new XMLSerializer,e=e.map(function(e){return u.serializeToString(e)})),i=ui.elements.length,o&&(i-=e.length);for(f=0,c=e.length;f<c;f++)t=e[f],this.args[i]=this.cleanUpStringElem(t),++i;this.mode="create"}else Ft(e)&&(e=(new XMLSerializer).serializeToString(e)),this.args[ui.elements.length-1]=this.cleanUpStringElem(e),this.mode="create"}return cn(t,e),t.prototype.cleanUpStringElem=function(e){return e=e.replace(/uuid\=\"\w*\"/gi,""),e},t.prototype.draw=function(){var e,t,n,r,i,s,o;s=this.args,o=[];for(n in s){if(!ln.call(s,n))continue;e=s[n],n=parseInt(n,10),r=Mt.parseElement($(e)),r.appendTo("#main"),archive.simulating||(ui.selection.elements.deselectAll(),ui.selection.elements.select([r])),i=r.zIndex(),i!==n?i>n?o.push(function(){var e,s,o;o=[];for(t=e=1,s=i-n;1<=s?e<=s:e>=s;t=1<=s?++e:--e)o.push(r.moveBack());return o}()):i<n?o.push(function(){var e,s,o;o=[];for(t=e=1,s=n-i;1<=s?e<=s:e>=s;t=1<=s?++e:--e)o.push(r.moveForward());return o}()):o.push(void 0):o.push(void 0)}return o},t.prototype["delete"]=function(){var e,t,n,r,i,s,o;n={},s=this.args;for(t in s){if(!ln.call(s,t))continue;e=s[t],t=parseInt(t,10),n[t]=en(t)}o=$t(n);for(r=0,i=o.length;r<i;r++)e=o[r],e["delete"]();if(!archive.simulating)return ui.selection.elements.validate()},t.prototype.undo=function(){return this.mode==="delete"?this.draw():this["delete"]()},t.prototype["do"]=function(){return this.mode==="delete"?this["delete"]():this.draw()},t.prototype.toJSON=function(){return{t:"e:"+{"delete":"d",create:"c"}[this.mode],a:this.args}},t}(w),R=function(e){function t(e,t,n){var r;this.ei=e,this.point=t,r=this.getElem(),typeof this.point=="number"?(this.mode="remove",this.point=r.points.at(this.point),this.pointIndex=this.point):(this.mode="create",typeof this.point=="string"&&(this.point=new q(this.point)),n!=null?this.pointIndex=n:this.pointIndex=r.points.all().length-1)}return cn(t,e),t.prototype["do"]=function(){return this.mode==="remove"?this.remove():this.add()},t.prototype.undo=function(){return this.mode==="remove"?this.add():this.remove()},t.prototype.getElem=function(){return en(this.ei)},t.prototype.add=function(){var e,t;return e=this.point.clone(),t=this.getElem(),t.hidePoints(),t.points.push(e),e.equal(t.points.first)&&e!==t.points.first&&t.points.close(),t.commit(),e.draw(),archive.simulating||(ui.selection.elements.deselectAll(),ui.selection.points.select(e)),this.getElem().redrawHoverTargets()},t.prototype.remove=function(){var e;return e=this.getElem(),e.points.remove(this.pointIndex),e.hidePoints(),archive.simulating||(ui.selection.elements.deselectAll(),ui.selection.points.select(e.points.last)),e.commit()},t.prototype.toJSON=function(){return{t:"p:"+{remove:"d",create:"c"}[this.mode],e:this.ei,p:this.point.toString(),i:this.pointIndex}},t}(w),Ct={setup:function(){return this.$body=$("body"),this.body=this.$body[0],this.$main=$("#main"),this.main=this.$main[0],this.$ui=$("#ui"),this.ui=this.$ui[0],this.$bg=$("#bg"),this.bg=this.$bg[0],this.$annotations=$("#annotations"),this.annotations=this.$annotations[0],this.$hoverTargets=$("#hover-targets"),this.hoverTargets=this.$hoverTargets[0],this.$grid=$("#grid"),this.grid=this.$grid[0],this.$utilities=$("#utilities"),this.utilities=this.$utilities[0],this.$selectionBox=$("#selection-box"),this.selectionBox=this.$selectionBox[0],this.$dragSelection=$("#drag-selection"),this.dragSelection=this.$dragSelection[0],this.$menuBar=$("#menu-bar"),this.menuBar=this.$menuBar[0],this.$currentSwatches=$("#current-swatches"),this.currentSwatches=this.$currentSwatches[0],this.$toolPalette=$("#tool-palette"),this.toolPalette=this.$toolPalette[0],this.$toolCursorPlaceholder=$("#tool-cursor-placeholder"),this.toolCursorPlaceholder=this.$toolCursorPlaceholder[0],this.$canvas=$("#canvas"),this.canvas=this.$canvas[0],this.$logoLeft=$("#logo #left-bar"),this.$logoMiddle=$("#logo #middle-bar"),this.$logoRight=$("#logo #right-bar"),this.logoLeft=this.$logoLeft[0],this.logoMiddle=this.$logoMiddle[0],this.logoRight=this.$logoRight[0],this.$filename=$("#filename-menu"),this.filename=this.$filename[0],this.$login=$("#login-mg"),this.login=this.$login[0],this.$tmpPaste=$("#tmp-paste"),this.tmpPaste=this.$tmpPaste[0],this.$pngSandbox=$("#png-download-sandbox"),this.pngSandbox=this.$pngSandbox[0],this.$currentService=$("#current-service"),this.currentService=this.$currentService[0],this.$serviceLogo=$(".service-logo"),this.serviceLogo=this.$serviceLogo[0],this.$serviceGallery=$("#service-file-gallery"),this.serviceGallery=this.$serviceGallery[0],this.$serviceGalleryThumbs=$("#service-file-gallery-thumbnails"),this.serviceGalleryThumbs=this.$serviceGalleryThumbs[0],this.$serviceBrowser=$("#service-file-browser"),this.serviceBrowser=this.$serviceBrowser[0],this.$registerButton=$("#register-mg"),this.registerButton=this.$registerButton[0],this.$dialogTitle=$("#dialog-title"),this.dialogTitle=this.$dialogTitle[0]}},nn.push(function(){return Ct.setup()}),window.ui={setup:function(){var e=this;return this.uistate=new vt,this.uistate.restore(),ui.window.on("focus",function(){return Ct.$toolCursorPlaceholder.hide()}),window.scrollTo(0,0),this.fill=(new ot("5fcda7")).appendTo("#fill-color"),this.stroke=(new ot("000000")).appendTo("#stroke-color"),this.fill.type="fill",this.stroke.type="stroke",this.changeTo("draw"),this.selection.elements.on("change",function(){return e.refreshUtilities(),e.transformer.refresh(),e.utilities.transform.refresh()})},clear:function(){return $("#ui .point.handle").remove()},importState:function(e){var t=this;return this.fill.absorb(new u(e.fill)),this.stroke.absorb(new u(e.stroke)),this.canvas.setZoom(parseFloat(e.zoom)),this.refreshAfterZoom(),this.canvas.normal=new J(e.normal),this.canvas.refreshPosition(),e.tool!=null?tn.push(function(){return t.switchToTool($t(tools).filter(function(t){return t.id===e.tool})[0])}):tn.push(function(){return t.switchToTool(tools.cursor)})},"new":function(e,t,n,r){return n==null&&(n=this.canvas.normal),r==null&&(r=this.canvas.zoom),this.canvas.width=e,this.canvas.height=t,this.canvas.zoom=r,this.canvas.normal=n,this.canvas.redraw(),this.canvas.zoom100(),this.deleteAll()},configurations:{draw:function(){return{show:[Ct.$canvas,Ct.$toolPalette,Ct.$menuBar,Ct.$filename,Ct.$currentSwatches,Ct.$utilities]}},gallery:function(){return{show:[Ct.$currentService,Ct.$serviceGallery]}},browser:function(){return{show:[Ct.$currentService,Ct.$serviceBrowser]}}},changeTo:function(e){var t,n,r,i,s,o,u;(o=this.currentConfig)!=null&&o.show.map(function(e){return e.hide()}),this.hotkeys.enable().reset(),u=this.utilities;for(i=0,s=u.length;i<s;i++)t=u[i],t.hide();return this.currentConfig=typeof (n=this.configurations)[e]=="function"?n[e]():void 0,this.currentConfig!=null&&(this.currentConfig.show.map(function(e){return e.show()}),typeof (r=this.currentConfig).etc=="function"&&r.etc(),this.currentConfig.title!=null?Ct.$dialogTitle.show().text(this.currentConfig.title):Ct.$dialogTitle.hide()),this.menu.closeAllDropdowns(),this},refreshAfterZoom:function(){var e,t,n,r;r=this.elements;for(t=0,n=r.length;t<n;t++)e=r[t],e.refreshUI();return this.selection.points.show(),this.grid.refreshRadii()},switchToTool:function(e){var t,n,r,i,s,o,u=this;if(e===this.uistate.get("tool"))return;(t=this.uistate.get("tool"))!=null&&t.tearDown(),this.uistate.set("tool",e),(n=Ct.$toolCursorPlaceholder)!=null&&n.hide(),(r=Ct.$body)!=null&&r.off("mousemove.tool-placeholder"),(i=Ct.body)!=null&&i.setAttribute("tool",e.cssid),e.setup(),e!==tools.paw&&((s=Gt(".tool-button[selected]"))!=null&&s.removeAttribute("selected"),(o=Gt("#"+e.id+"-btn"))!=null&&o.setAttribute("selected",""),Ct.$body.on("mousemove.tool-placeholder",function(t){if(t.offsetX!==e.offsetX||t.offsetY!==e.offsetY)return Ct.$toolCursorPlaceholder.hide(),Ct.$body.off("mousemove.tool-placeholder")})),this.refreshUtilities();if(this.cursor.currentPosn===void 0)return;return Ct.$toolCursorPlaceholder.show().attr("tool",e.cssid).css({left:this.cursor.currentPosn.x-e.offsetX,top:this.cursor.currentPosn.y-e.offsetY})},switchToLastTool:function(){return this.switchToTool(this.uistate.get("lastTool"))},hover:function(e,t){var n,r,i;e.target=t,this.uistate.get("tool").dispatch(e,"hover"),i=Bt(t);if(i)switch(i){case"menu":r=$t(this.menu.menus);if(r.filter(function(e){return e.dropdownOpen}).length>0){n=r.filter(function(e){return e.itemid===t.id})[0];if(n!=null)return n.openDropdown()}}},unhover:function(e,t){return e.target=t,this.uistate.get("tool").dispatch(e,"unhover")},click:function(e,t){var n,r,i,s;if(t.nodeName.toLowerCase()==="emph"||t.hasAttribute("buttontext"))n=$(t).closest(".menu-item")[0],n==null&&(n=$(t).closest(".menu")[0]),t=n;r=Bt(t);if(!r)return this.uistate.get("tool").dispatch(e,"click");switch(r){case"menu":return(i=this.menu.menu(t.id))!=null?i._click(e):void 0;case"menu-item":return(s=this.menu.item(t.id))!=null?s._click(e):void 0;default:return this.topUI.dispatch(e,"click")}},doubleclick:function(e,t){return this.uistate.get("tool").dispatch(e,"doubleclick")},mousemove:function(e){var t;t=Bt(e.target),t&&this.topUI.dispatch(e,"mousemove");if(this.uistate.get("tool")===tools.paw)return Ct.$toolCursorPlaceholder.css({left:e.clientX-8,top:e.clientY-8})},mousedown:function(e){if(!Bt(e.target))return this.menu.closeAllDropdowns(),this.refreshUtilities(),this.uistate.get("tool").dispatch(e,"mousedown")},mouseup:function(e){var t;return t=Bt(e.target),t?this.topUI.dispatch(e,"mouseup"):(e.stopPropagation(),this.uistate.get("tool").dispatch(e,"mouseup"))},startDrag:function(e){var t,n,r,i,s,o;n=Bt(e.target);if(n)return this.topUI.dispatch(e,"startDrag");this.uistate.get("tool").initialDragPosn=new J(e),this.uistate.get("tool").dispatch(e,"startDrag"),s=this.hotkeys.modifiersDown,o=[];for(r=0,i=s.length;r<i;r++)t=s[r],o.push(this.uistate.get("tool").activateModifier(t));return o},continueDrag:function(e,t){var n;return e.target=t,n=Bt(t),n?this.topUI.dispatch(e,"continueDrag"):this.uistate.get("tool").dispatch(e,"continueDrag")},stopDrag:function(e,t){var n,r,i,s;document.onselectstart=function(){return!0},n=e.target,e.target=t,r=Bt(e.target);if(!r)return this.uistate.get("tool").dispatch(e,"stopDrag"),this.uistate.get("tool").initialDragPosn=null,this.snap.toNothing();if(t.nodeName.toLowerCase()==="emph"||t.hasAttribute("buttontext"))t=t.parentNode;switch(r){case"menu":if(n===t)return(i=this.menu.menu(t.id))!=null?i._click(e):void 0;break;case"menu-item":if(n===t)return(s=this.menu.item(t.id))!=null?s._click(e):void 0;break;default:return this.topUI.dispatch(e,"stopDrag")}},fill:null,stroke:null,elements:[],queryElement:function(e){var t,n,r,i;i=this.elements;for(n=0,r=i.length;n<r;n++){t=i[n];if(t.rep===e)return t}},hoverTargetsHighlighted:[],unhighlightHoverTargets:function(){var e,t,n,r;r=this.hoverTargetsHighlighted;for(t=0,n=r.length;t<n;t++)e=r[t],e.unhighlight();return this.hoverTargetsHighlighted=[]},refreshUtilities:function(){var e,t,n,r;if(!Et)return;n=this.utilities,r=[];for(e in n){if(!ln.call(n,e))continue;t=n[e],t.shouldBeOpen()?r.push(t.show()):r.push(t.hide())}return r},deleteAll:function(){var e,t,n,r;r=this.elements;for(t=0,n=r.length;t<n;t++)e=r[t],e["delete"]();return this.elements=[],Ct.main.removeChildren(),this.selection.refresh()},colors:{transparent:new u(0,0,0,0),white:new u(255,255,255),black:new u(0,0,0),red:new u(255,0,0),yellow:new u(255,255,0),green:new u(0,255,0),teal:new u(0,255,255),blue:new u(0,0,255),pink:new u(255,0,255),"null":new u(null,null,null),logoRed:new u("#E03F4A"),logoYellow:new u("#F1CF2E"),logoBlue:new u("#3FB2E0")}},nn.push(function(){return ui.setup()}),ui.logo={animate:function(){var e=this;this._animateRequests+=1;if(this._animateRequests===1)return clearInterval(this.animateLogoInterval),this.animateLogoInterval=setInterval(function(){var t,n;return e._animateRequests===0?e._reset():(n=[ui.colors.logoRed,ui.colors.logoYellow,ui.colors.logoBlue],t=parseInt(Math.random()*3),Ct.$logoLeft.css("background-color",n[t]),n=n.slice(0,t).concat(n.slice(t+1)),t=parseInt(Math.random()*2),Ct.$logoMiddle.css("background-color",n[t]),n=n.slice(0,t).concat(n.slice(t+1)),Ct.$logoRight.css("background-color",n[0]))},170)},stopAnimating:function(){this._animateRequests-=1;if(this._animateRequests<0)return this._animateRequests=0},_animateRequests:0,_reset:function(){return clearInterval(this.animateLogoInterval),Ct.$logoLeft.css("background-color",ui.colors.logoRed),Ct.$logoMiddle.css("background-color",ui.colors.logoYellow),Ct.$logoRight.css("background-color",ui.colors.logoBlue)}},vt=function(){function e(e){var t=this;this.attributes=e!=null?e:this.DEFAULTS(),this.on("change",function(){return t.saveLocally()})}return e.prototype.restore=function(){var e;return e=localStorage.getItem("uistate"),e!=null&&this.importJSON(JSON.parse(e)),this},e.prototype.set=function(e,t){if(this.attributes[e]===t)return;switch(e){case"tool":this.attributes.lastTool=this.attributes.tool,this.attributes.tool=t;break;default:this.attributes[e]=t}return this.trigger("change",e,t),this.trigger("change:"+e,t)},e.prototype.get=function(e){return this.attributes[e]},e.prototype.saveLocally=function(){return localStorage.setItem("uistate",this.toJSON())},e.prototype.apply=function(){return ui.fill.absorb(this.get("fill")),ui.stroke.absorb(this.get("stroke"))},e.prototype.toJSON=function(){return{fill:this.attributes.fill.hex,stroke:this.attributes.stroke.hex,strokeWidth:this.attributes.strokeWidth,zoom:this.attributes.zoom,normal:this.attributes.normal.toJSON(),tool:this.attributes.tool.id,lastTool:this.attributes.lastTool.id}},e.prototype.importJSON=function(e){return this.attributes={fill:new u(e.fill),stroke:new u(e.stroke),strokeWidth:e.strokeWidth,zoom:e.zoom,normal:J.fromJSON(e.normal),tool:tools[e.tool],lastTool:tools[e.lastTool]},this.trigger("change")},e.prototype.DEFAULTS=function(){return{fill:new u("#5fcda7"),stroke:new u("#000000"),strokeWidth:1,zoom:1,normal:new J(-1,-1),tool:tools.cursor,lastTool:tools.cursor}},e}(),$.extend(vt.prototype,Xt.events),window.UIState=vt,ui.selection={elements:{all:[],clone:function(){return this.all.map(function(e){return e.clone()})},empty:function(){return this.all.length===0},exists:function(){return!this.empty()},select:function(e){return ui.selection.points.deselectAll(),e instanceof Array?this.all=e:this.all=[e],this.trigger("change")},selectMore:function(e){var t,n,r;ui.selection.points.deselectAll();if(e instanceof Array)for(n=0,r=e.length;n<r;n++)t=e[n],this.all.ensure(t);else this.all.ensure(e);return this.trigger("change")},selectAll:function(){return ui.selection.points.deselectAll(),this.all=ui.elements,this.trigger("change")},selectWithinBounds:function(e){var t;return ui.selection.points.deselectAll(),t=e.toRect(),this.all=ui.elements.filter(function(e){return e.overlaps(t)}),this.trigger("change")},deselect:function(e){return this.all.remove(e),this.trigger("change")},deselectAll:function(){if(this.all.length===0)return;return this.all=[],this.trigger("change")},each:function(e){return this.all.forEach(e)},map:function(e){return this.all.map(e)},filter:function(e){return this.all.filter(e)},zIndexes:function(){var e,t,n,r,i;r=this.all,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(e.zIndex());return i},ofType:function(e){return this.filter(function(t){return t.type===e})},validate:function(){return this.all=this.filter(function(e){return ui.elements.has(e)}),this.trigger("change")},"export":function(e){var t;return this.empty()?"":(e=$.extend({trim:!1},e),t=new et(this.clone()),e.trim&&t.trim(),t.toString())},exportAsDataURI:function(){return"data:image/svg+xml;base64,"+btoa(this["export"]())},exportAsPNG:function(e){return new j(this["export"](e))},asDataURI:function(){}},points:{all:[],empty:function(){return this.all.length===0},exists:function(){return!this.empty()},select:function(e){return ui.selection.elements.deselectAll(),e instanceof Array?this.all=e:this.all=[e],this.all.forEach(function(e){return e.select()}),this.trigger("change")},selectMore:function(e){var t=this;return ui.selection.elements.deselectAll(),e instanceof Array?e.forEach(function(e){return t.all.ensure(e),e.select()}):(this.all.ensure(e),e.select()),this.trigger("change")},deselect:function(e){return e.forEach(function(e){return e.deselect()}),this.all.remove(e),this.trigger("change")},deselectAll:function(){if(this.all.length===0)return;return this.all.forEach(function(e){return e.deselect()}),this.all=[],this.trigger("change")},zIndexes:function(){var e,t,n,r,i,s;t={},s=this.all;for(r=0,i=s.length;r<i;r++)e=s[r],n=e.owner.zIndex(),t[n]==null&&(t[n]=[]),t[n].push(e.at);return t},show:function(){return this.all.map(function(e){return e.show})},hide:function(){return this.all.map(function(e){return e.hide(!0)})},each:function(e){return this.all.forEach(e)},filter:function(e){return this.all.filter(e)},validate:function(){return this.all=this.filter(function(e){return ui.elements.has(e.owner)}),this.trigger("changed")}},refresh:function(){return this.elements.validate()}},$.extend(ui.selection.elements,Xt.events),$.extend(ui.selection.points,Xt.events),$.extend(ui.selection,{macro:function(e){return e.elements!=null&&this.elements.each(function(t){return e.elements.call(t)}),e.points!=null&&this.points.each(function(t){return e.points.call(t)}),e.transformer!=null&&this.elements.exists()&&e.transformer.call(ui.transformer),ui.utilities.transform.refreshValues()},nudge:function(e,t,n){n==null&&(n=!0),this.macro({elements:function(){return this.nudge(e,t)},points:function(){var n;return this.nudge(e,t),(n=this.antlers)!=null&&n.refresh(),this.owner.commit()},transformer:function(){return this.nudge(e,-t).redraw()}});if(n)return archive.addMapEvent("nudge",this.elements.zIndexes(),{x:e,y:t}),this.elements.each(function(e){return e.refreshUI()})},scale:function(e,t,n){return n==null&&(n=ui.transformer.center()),this.macro({elements:function(){return this.scale(e,t,n)}})},rotate:function(e,t){return t==null&&(t=ui.transformer.center()),this.macro({elements:function(){return this.rotate(e,t)},transformer:function(){return this.rotate(e,t).redraw()}})},"delete":function(){return this.macro({elements:function(){return this["delete"]()}})}}),ui.window={setup:function(){var e=this;return window.onfocus=function(t){return e.trigger("focus",[t])},window.onblur=function(t){return e.trigger("blur",[t])},window.onerror=function(t,n,r){return e.trigger("error",[t,n,r])},window.onresize=function(t){return e.trigger("resize",[t])},window.onscroll=function(t){return e.trigger("scroll",[t])},window.onmousewheel=function(t){return e.trigger("mousewheel",[t])}},listeners:{},listenersOne:{},on:function(e,t){var n;return n=this.listeners[e],n===void 0&&(n=this.listeners[e]=[]),n.push(t)},one:function(e,t){var n;return n=this.listenersOne[e],n===void 0&&(n=this.listenersOne[e]=[]),n.push(t)},trigger:function(e,t){var n,r,i,s,o,u,a;r=this.listeners[e];if(r!=null)for(s=0,u=r.length;s<u;s++)n=r[s],n.apply(this,t);i=this.listenersOne[e];if(i!=null){for(o=0,a=i.length;o<a;o++)n=i[o],n.apply(this,t);return delete this.listenersOne[e]}},width:function(){return window.innerWidth},height:function(){return window.innerHeight},halfw:function(){return this.width()/2},halfh:function(){return this.height()/2},center:function(){return new J(this.width()/2,this.height()/2)},centerRelativeToCanvas:function(){return new J((-ui.canvas.normal.x+this.halfw())/ui.canvas.zoom,(-ui.canvas.normal.y+this.halfh())/ui.canvas.zoom)},centerOn:function(e){var t,n;return t=this.width()/2-e.x*ui.canvas.zoom,n=this.height()/2-e.y*ui.canvas.zoom,ui.canvas.normal=new J(t,n),ui.canvas.refreshPosition()}},nn.push(function(){return ui.window.setup()}),ui.clipboard={data:void 0,cut:function(){var e,t,n,r,i;if(ui.selection.elements.all.length===0)return;this.copy(),r=ui.selection.elements.all,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(e["delete"]());return i},copy:function(){if(ui.selection.elements.all.length===0)return;return this.data=ui.selection.elements["export"]()},paste:function(){var e,t,n,r,s,o,u,a;if(this.data==null)return;o=Mt.parseAndAppend(this.data,!1),t=new i(function(){var e,t,n;n=[];for(e=0,t=o.length;e<t;e++)s=o[e],n.push(s.bounds());return n}()),r=t.clone(),r.centerOn(ui.canvas.posnInCenterOfWindow()),e=t.adjustElemsTo(r);for(u=0,a=o.length;u<a;u++)n=o[u],e(n);return ui.selection.elements.select(o),archive.addExistenceEvent(o.map(function(e){return e.rep}))}},nn.push(function(){return ui.window.on("error",function(e,t,n){return sn("Javascript","Error",""+e)})}),ui.afk={active:!1,activate:function(){return this.active=!0,this.startTasks()},activateTimerId:void 0,reset:function(){var e=this;return this.active=!1,clearTimeout(this.activateTimerId),this.activateTimerId=setTimeout(function(){return e.activate()},2e3)},tasks:{},"do":function(e,t){return this.tasks[e]=t},stop:function(e){return delete this.tasks[e]},startTasks:function(e){var t;e==null&&(e=$t(this.tasks)),t=e[0],typeof t=="function"&&t();if(e.length>1&&this.active)return this.startTasks(e.slice(1))}},ui.topUI={dispatch:function(e,t){var n,r,i,s,o,u,a,f;f=e.target.className.split(" ");for(s=0,o=f.length;s<o;s++)n=f[s],typeof (r=this[t])[u="."+n]=="function"&&r[u](e);return typeof (i=this[t])[a="#"+e.target.id]=="function"?i[a](e):void 0},hover:{"slider knob":function(e){}},unhover:{"slider knob":function(){}},click:{".swatch":function(e){var t,n;if(e.target.parentNode.className==="swatch-duo")return;return t=$(e.target),n=t.offset(),ui.utilities.color.setting=e.target,ui.utilities.color.toggle().position(n.left+41,n.top).ensureVisibility()},"#transparent-permanent-swatch":function(){ui.utilities.color.set(ui.colors["null"]),ui.utilities.color.updateIndicator();if(ui.selection.elements.all.length)return archive.addAttrEvent(ui.selection.elements.zIndexes(),ui.utilities.color.setting.getAttribute("type"))},".tool-button":function(e){return ui.switchToTool(tools[e.target.id.replace("-btn","")])},".slider":function(e){return $(e.target).trigger("release")}},mousemove:{"slider knob":function(){}},mousedown:{"slider knob":function(){}},mouseup:{"#color-pool":function(e){ui.utilities.color.selectColor(e),sn("Color","Choose",ui.utilities.color.selectedColor.toString());if(ui.selection.elements.all.length>0)return archive.addAttrEvent(ui.selection.elements.zIndexes(),ui.utilities.color.setting.getAttribute("type"))}},startDrag:{".slider-container":function(e){return console.log(5),ui.cursor.lastDownTarget=$(e.target).find(".knob")[0]}},continueDrag:{"#color-pool":function(
e){return ui.utilities.color.selectColor(e)},".knob":function(e){var t;return t=(new J(e)).subtract(ui.cursor.lastPosn),$(e.target).nudge(t.x,0)}},stopDrag:{".knob":function(e){return $(e.target).trigger("stopDrag")}}},ot=function(e){function t(e,n,r,i){var s=this;this.r=e,this.g=n,this.b=r,this.a=i!=null?i:1,this.r instanceof u&&(this.g=this.r.g,this.b=this.r.b,this.a=this.r.a,this.r=this.r.r),t.__super__.constructor.call(this,this.r,this.g,this.b,this.a),this.$rep=$('<div class="swatch"></div>'),this.rep=this.$rep[0],this.refresh(),this.$rep.on("set",function(e,t){return s.absorb(t),s.refresh()}),this}return cn(t,e),t.prototype.refresh=function(){var e,t,n,r,i,s;this.r===null?(this.rep.style.backgroundColor="",this.rep.style.border="",this.rep.setAttribute("empty",""),this.rep.setAttribute("val","empty")):(this.rep.style.backgroundColor=this.toString(),this.rep.style.border="1px solid "+this.clone().darken(1.5).toHexString(),this.rep.removeAttribute("empty"),this.rep.setAttribute("val",this.toString()));if(this.type!=null){this.rep.setAttribute("type",this.type),t=this.tiedTo();if(t instanceof Array){i=this.tiedTo(),s=[];for(n=0,r=i.length;n<r;n++)e=i[n],e.data[this.type]=this.clone(),s.push(e.commit());return s}return t.data[this.type]=this.clone(),t.commit()}},t.prototype.tiedTo=function(){return ui.selection.elements.all},t.prototype.type=null,t.prototype.appendTo=function(e){return Gt(e).appendChild(this.rep),this},t}(u),window.Swatch=ot,ut=function(){function e(e,t){this.fill=e,this.stroke=t,this.fill instanceof P&&(this.fill.data.stroke===void 0?this.stroke=new ot(null):this.stroke=new ot(this.fill.data.stroke),this.fill.data.fill===void 0?this.fill=new ot(null):this.fill=new ot(this.fill.data.fill)),this.fill.type="fill",this.stroke.type="stroke",this.$rep=$('<div class="swatch-duo"></div>'),this.$rep.append(this.fill.$rep),this.$rep.append(this.stroke.$rep),this.$rep.attr("key",this.toString()),this.rep=this.$rep[0]}return e.prototype.tiedTo=function(){},e.prototype.toString=function(){return""+this.fill.toHexString()+"/"+this.stroke.toHexString()},e}(),ui.snap={toNothing:function(){return this.removeAnnotationLine(),this.supplementEvent=function(e){return e}},toAnyOf:function(e,t,n){return n==null&&(n=function(){}),this.removeAnnotationLine(),this.supplementEvent=function(e){return e}},toOneOf:function(e,t,n){return t==null&&(t="client"),n==null&&(n=function(){}),this.removeAnnotationLine(),this.supplementEvent=function(r){var i,s;return r=Tt(r),i={},e.map(function(e){var n;n=(new J(r[""+t+"X"],r[""+t+"Y"])).perpendicularDistanceFrom(e);if(n!=null)return i[n[0]]=n[1]}),s=i[Math.min.apply(this,Object.keys(i).map(parseFloat))],r[""+t+"X"]=s.x,r[""+t+"Y"]=s.y,ui.cursor.currentPosn=s,n(r),r}},supplementForGrid:function(e){var t;return e=Tt(e),t=e.canvasPosnZoomed,t=this.snapPointToGrid(t),e},snapPointToGrid:function(e){var t;return t=ui.grid.frequency,e.x=e.x.toNearest(t.x,t.x/3),e.y=e.y.toNearest(t.y,t.y/3),e},toThis:function(e,t){return t==null&&(t=function(){}),this.removeAnnotationLine()},annotationLine:null,removeAnnotationLine:function(){var e;return(e=this.annotationLine)!=null&&e.remove(),this.annotationLine=null},updateAnnotationLine:function(e,t){return this.annotationLine==null?this.annotationLine=ui.annotations.drawLine(e,t,"rgba(73,130,224,0.3)"):(this.annotationLine.absorbA(e),this.annotationLine.absorbB(t),this.annotationLine.commit())},presets:{every45:function(e,t){return ui.snap.toOneOf([new Q(e,0),new Q(e,45),new Q(e,90),new Q(e,135),new Q(e,180),new Q(e,225),new Q(e,270),new Q(e,315)],t)}}},ui.canvas={zoom:1,width:1e3,height:800,panLimitX:function(){return Math.max(500,(ui.window.width()-this.width*this.zoom)/2+ui.window.width()/3)},panLimitY:function(){return Math.max(500,(ui.window.height()-this.height*this.zoom)/2+ui.window.height()/3)},origin:new J(0,0),normal:new J(-1,-1),show:function(){return Ct.canvas.style.display="block"},hide:function(){return Ct.canvas.style.display="none"},redraw:function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d=this;return e==null&&(e=!1),(u=Ct.main)!=null&&(u.style.width=this.width.px()),(a=Ct.main)!=null&&(a.style.height=this.height.px()),(f=Ct.main)!=null&&f.setAttribute("width",this.width),(l=Ct.main)!=null&&l.setAttribute("height",this.height),(c=Ct.main)!=null&&c.setAttribute("viewbox","0 0 "+this.width+" "+this.height),(h=Ct.main)!=null&&h.setAttribute("enable-background","new 0 0 "+this.width+" "+this.height),(p=Ct.grid)!=null&&p.setAttribute("width",this.width),(o=Ct.grid)!=null&&o.setAttribute("height",this.height),r={transform:"scale("+ui.canvas.zoom+")","-webkit-transform":"scale("+ui.canvas.zoom+")","-moz-transform":"scale("+ui.canvas.zoom+")"},Ct.$main.css(r),Ct.$grid.css(r),n=function(e){return e.style.width=(d.width*ui.canvas.zoom).px(),e.style.height=(d.height*ui.canvas.zoom).px()},[Ct.bg,Ct.annotations,Ct.hoverTargets].map(n),s=ui.window.width(),i=ui.window.height(),e&&(this.width<s&&(t=s-this.width,this.normal.x=t/2),this.height<i&&(t=i-this.height,this.normal.y=t/2)),this.refreshPosition(),this},nudge:function(e,t){return this.normal=this.normal.add(new J(e,-t)),this.ensureVisibility(),this.snapToIntegers(),this.refreshPosition()},snapToIntegers:function(){return this.normal.x=Math.round(this.normal.x),this.normal.y=Math.round(this.normal.y)},ensureVisibility:function(){var e,t,n,r;return t=this.panLimitX(),n=this.panLimitY(),r=ui.window.width(),e=ui.window.height(),this.normal.x>t&&(this.normal.x=t),this.normal.x<-t-this.width*this.zoom+r&&(this.normal.x=-t-this.width*this.zoom+r),this.normal.y>n&&(this.normal.y=n),this.normal.y<-n-this.height*this.zoom+e&&(this.normal.y=-n-this.height*this.zoom+e),this.refreshPosition()},refreshPosition:function(){var e,t;return(e=Ct.canvas)!=null&&(e.style.left=this.normal.x),(t=Ct.canvas)!=null&&(t.style.top=this.normal.y),ui.uistate.set("normal",this.normal),this},setZoom:function(e){var t;return ui.selection.points.hide(),t=ui.window.centerRelativeToCanvas(),this.zoom=e,this.redraw(),ui.transformer.redraw(!0),ui.window.centerOn(t),this.ensureVisibility()},center:function(){return this.normal.add(new J(this.width*this.zoom/2,this.height*this.zoom/2))},centerOn:function(e){return e=e.subtract(this.center()),this.normal.x+=e.x,this.normal.y+=e.y,this.refreshPosition()},posnInCenterOfWindow:function(){return ui.window.center().subtract(this.normal).setZoom(ui.canvas.zoom)},zoomIn:function(e){return e==null&&(e=1.15),this.setZoom(this.zoom*e)},zoomOut:function(e){return e==null&&(e=.85),this.setZoom(this.zoom*e)},zoom100:function(){return this.setZoom(1),this.centerOn(ui.window.center())},zoomToFit:function(e){var t,n,r,i,s,o=this;return r=this.normal.clone(),t=e.center(),i=ui.window.width()/this.zoom/e.width,n=ui.window.height()/this.zoom/e.height,s=Math.min(i,n),this.setZoom(ui.canvas.zoom*s),ui.window.centerOn(t),St(function(){return ui.refreshAfterZoom()})},petrified:!1,petrify:function(){var e;return this.petrified=!0,e=Ct.$main.clone(),e.attr("id","main-petrified"),Ct.$hoverTargets.hide(),Ct.$annotations.hide(),Ct.$main.hide().after(e)},depetrify:function(){return this.petrified=!1,Ct.$hoverTargets.show(),Ct.$annotations.show(),Ct.$main.show().next().remove()}},nn.push(function(){return ui.canvas.redraw()}),ui.cursor={reset:function(){return this.down=!1,this.wasDownLast=!1,this.downOn=void 0,this.dragging=!1,this.draggingJustBegan=!1,this.currentPosn=void 0,this.lastPosn=void 0,this.lastEvent=void 0,this.lastDown=void 0,this.lastDownTarget=void 0,this.lastUp=void 0,this.lastUpTarget=void 0,this.inHoverState=void 0,this.lastHoverState=void 0,this.resetOnNext=!1,this.doubleclickArmed=!1,!0},snapChangeAccum:{x:0,y:0},resetSnapChangeAccumX:function(){return this.snapChangeAccum.x=0},resetSnapChangeAccumY:function(){return this.snapChangeAccum.y=0},dragAccum:function(){var e;return e=this.lastPosn.subtract(this.lastDown),{x:e.x,y:e.y}},armDoubleClick:function(){var e=this;return this.doubleclickArmed=!0,setTimeout(function(){return e.doubleclickArmed=!1},Z.DOUBLE_CLICK_THRESHOLD)},setup:function(){var e=this;return this.reset(),this._click=function(e){return Dt(e.target)?!0:e.stopPropagation()},this._mousedown=function(t){return ui.afk.reset(),Dt(t.target)?(bt(t.target)||ui.hotkeys.disable(),e.reset(),!0):(t.stopPropagation(),$("input:focus").blur(),$("[contenteditable]").blur(),ui.hotkeys.use("app"),t.originalEvent.preventDefault(),ui.mousedown(t,t.target),e.down=!0,e.lastDown=new J(t),e.downOn=t.target,e.lastDownTarget=t.target)},this._mouseup=function(t){return Dt(t.target)?(bt(t.target)||ui.hotkeys.disable(),ui.dragSelection.end(function(){},!0),!0):(ui.hotkeys.use("app"),ui.mouseup(t,t.target),e.dragging&&!e.draggingJustBegan?ui.stopDrag(t,e.lastDownTarget):e.doubleclickArmed?(e.doubleclickArmed=!1,ui.doubleclick(e.lastEvent,e.lastDownTarget),Dt(t.target)&&(bt(t.target)||ui.hotkeys.disable(),ui.dragSelection.end(function(){},!0))):(ui.click(t,t.target),t.target.nodeName==="text"&&e.armDoubleClick()),e.dragging=!1,e.down=!1,e.lastUp=new J(t),e.lastUpTarget=t.target,e.draggingJustBegan=!1)},this._mousemove=function(t){e.doubleclickArmed=!1,ui.afk.reset(),e.lastPosn=e.currentPosn,e.currentPosn=new J(t);if(Dt(t.target))return bt(t.target)||ui.hotkeys.disable(),!0;ui.mousemove(t,t.target),t.preventDefault(),e.wasDownLast=e.down,e.lastEvent=t,e.currentPosn=new J(t);if(e.down)return e.dragging?(ui.continueDrag(t,e.lastDownTarget),e.draggingJustBegan=!1):(ui.startDrag(e.lastEvent,e.lastDownTarget),e.dragging=e.draggingJustBegan=!0)},this._mouseover=function(t){if(e.dragging)return;return e.lastHoverState=e.inHoverState,e.inHoverState=t.target,e.lastHoverState!=null&&ui.unhover(t,e.lastHoverState),ui.hover(t,e.inHoverState)},$("body").click(function(t){return e._click(t)}).mousemove(function(t){return e._mousemove(t)}).mousedown(function(t){return e._mousedown(t)}).mouseup(function(t){return e._mouseup(t)}).mouseover(function(t){return e._mouseover(t)}),ui.window.on("focus",function(){return e.currentPosn=new J(-100,-100)})}},nn.push(function(){return ui.cursor.setup()}),ui.dragSelection={origin:{x:0,y:0},tl:{x:0,y:0},width:0,height:0,asRect:function(){return new G({x:Ct.$dragSelection.css("left").toFloat()-ui.canvas.normal.x,y:Ct.$dragSelection.css("top").toFloat()-ui.canvas.normal.y,width:this.width,height:this.height})},bounds:function(){return new i(Ct.$dragSelection.css("left").toFloat()-ui.canvas.normal.x,Ct.$dragSelection.css("top").toFloat()-ui.canvas.normal.y,this.width,this.height)},start:function(e){return this.origin.x=e.x,this.origin.y=e.y,Ct.$dragSelection.show()},move:function(e){return this.tl=new J(Math.min(e.x,this.origin.x),Math.min(e.y,this.origin.y)),this.width=Math.max(e.x,this.origin.x)-this.tl.x-1,this.height=Math.max(e.y,this.origin.y)-this.tl.y,Ct.$dragSelection.css({top:this.tl.y,left:this.tl.x,width:this.width,height:this.height})},end:function(e,t){var n;t==null&&(t=!1),Ct.$dragSelection.hide();if(t)return;return this.width<3&&this.height<3?ui.selection.elements.deselectAll():(n=1/ui.canvas.zoom,e(this.bounds().scale(n,n,ui.canvas.origin)),Ct.$dragSelection.hide().css({left:"",top:"",width:"",height:""}))}},ui.transformer={angle:0,resetAccum:function(){return this.accumX=1,this.accumY=1,this.accumA=0,this.origin=void 0,this},hide:function(){var e,t,n,r;n=this.reps,r=[];for(e in n){if(!ln.call(n,e))continue;t=n[e],r.push(t.style.display="none")}return r},show:function(){var e,t,n,r;this.resetAccum(),n=this.reps,r=[];for(e in n){if(!ln.call(n,e))continue;t=n[e],r.push(t.style.display="block")}return r},center:function(){return(new L(this.tl,this.br)).midPoint()},refresh:function(){var e,t,n,r,i,s,o,u,a,f;this.deriveCorners(ui.selection.elements.all),t=this.center();if(ui.selection.elements.all.length===0)return this.hide();this.show(),e=new rt(ui.selection.elements.all.map(function(e){return e.metadata.angle})),e.length===1?this.angle=parseFloat(e[0]):ui.selection.elements.all.map(function(e){return e.metadata.angle=0}),a=ui.selection.elements.all;for(i=0,o=a.length;i<o;i++)n=a[i],this.angle!==0&&(n.rotate(360-this.angle,t),n.clearCachedObjects()),n.clearCachedObjects(),n.lineSegments();this.deriveCorners(ui.selection.elements.all);if(this.angle!==0){f=ui.selection.elements.all;for(s=0,u=f.length;s<u;s++)n=f[s],n.rotate(this.angle,t);r=this.angle,this.angle=0,this.rotate(r,t)}return this.redraw(),this},deriveCorners:function(e){var t,n,r,i,s,o,u,a,f;if(e.length===0){this.tl=this.tr=this.br=this.bl=new J(0,0),this.width=this.height=0;return}o=function(){var n,r,i;i=[];for(n=0,r=e.length;n<r;n++)t=e[n],i.push(t.xRange());return i}(),f=function(){var n,r,i;i=[];for(n=0,r=e.length;n<r;n++)t=e[n],i.push(t.yRange());return i}(),r=function(e){return Math.min.apply(this,e.map(function(e){return e.min}))},n=function(e){return Math.max.apply(this,e.map(function(e){return e.max}))},s=r(o),i=n(o),a=r(f),u=n(f),this.tl=new J(s,a),this.tr=new J(i,a),this.br=new J(i,u),this.bl=new J(s,u),this.lc=new J(s,a+(u-a)/2),this.rc=new J(i,a+(u-a)/2),this.tc=new J(s+(i-s)/2,a),this.bc=new J(s+(i-s)/2,u),this.width=i-s,this.height=u-a,this.width===0&&(this.width=1);if(this.height===0)return this.height=1},pixelToFloat:function(e,t){return e===0?1:1+e/t},redraw:function(){var e,t,n,r,i,s,o,u;if(ui.selection.elements.all.length===0)return this.hide();r=this.correctAngle(this.tl),i=ui.canvas.zoom,e=this.center().zoomed(),u=["tl","tr","br","bl","tc","rc","bc","lc"];for(s=0,o=u.length;s<o;s++)t=u[s],n=this[t].zoomedc(),this.reps[t].style.left=Math.floor(n.x,10),this.reps[t].style.top=Math.floor(n.y,10),this.reps[t].style.WebkitTransform="rotate("+this.angle+"deg)",this.reps[t].style.MozTransform="rotate("+this.angle+"deg)";return this.reps.outline.style.width=""+Math.ceil(this.width*i,10)+"px",this.reps.outline.style.height=""+Math.ceil(this.height*i,10)+"px",r.zoomed(),this.reps.outline.style.left=""+Math.floor(r.x,10)+"px",this.reps.outline.style.top=""+Math.floor(r.y,10)+"px",this.reps.outline.style.WebkitTransform="rotate("+this.angle+"deg)",this.reps.outline.style.MozTransform="rotate("+this.angle+"deg)",this.reps.c.style.left=""+Math.ceil(e.x,10)+"px",this.reps.c.style.top=""+Math.ceil(e.y,10)+"px",this},correctAngle:function(e){return e.clone().rotate(360-this.angle,this.center())},drag:function(e){var t,n,r,i,s,o,u,a,f;n={x:0,y:0},t=this.center(),r=e.canvasPosnZoomed.clone().rotate(360-this.angle,t),i=e.target.className.replace("transform handle ","").split(" ")[1],u={tl:this.br,tr:this.bl,br:this.tl,bl:this.tr,top:this.bc,right:this.lc,bottom:this.tc,left:this.rc},o=u[i],["tr","right","br"].has(i)&&(n.x=r.x-this.correctAngle(this.rc).x),["tl","left","bl"].has(i)&&(n.x=this.correctAngle(this.lc).x-r.x),["tl","top","tr"].has(i)&&(n.y=this.correctAngle(this.tc).y-r.y),["bl","bottom","br"].has(i)&&(n.y=r.y-this.correctAngle(this.bc).y),a=this.pixelToFloat(n.x,this.width),f=this.pixelToFloat(n.y,this.height);if(a<0){s={tl:this.reps.tr,tr:this.reps.tl,br:this.reps.bl,bl:this.reps.br,top:this.reps.bc,right:this.reps.lc,bottom:this.reps.tc,left:this.reps.rc},ui.cursor.lastDownTarget=s[i];switch(i){case"left":case"bl":case"tl":return this._flipOver("R");case"right":case"br":case"tr":return this._flipOver("L")}}if(f<0){s={tl:this.reps.bl,tr:this.reps.br,br:this.reps.tr,bl:this.reps.tl,top:this.reps.bc,right:this.reps.lc,bottom:this.reps.tc,left:this.reps.rc},ui.cursor.lastDownTarget=s[i];switch(i){case"bottom":case"bl":case"br":return this._flipOver("T");case"top":case"tl":case"tr":return this._flipOver("B")}}return ui.hotkeys.modifiersDown.has("shift")&&(i[0]==="side"&&(a===1?a=f:f===1&&(f=a)),a<f?f=a:a=f),ui.hotkeys.modifiersDown.has("alt")&&(o=t,a*=a,f*=f),a=a.ensureRealNumber(),f=f.ensureRealNumber(),a=Math.max(1e-5,a),f=Math.max(1e-5,f),this.scale(a,f,o),this.redraw(),ui.selection.scale(a,f,o)},clonedPosns:function(){return[this.tl,this.tc,this.tr,this.rc,this.br,this.bc,this.bl,this.lc].map(function(e){return e.clone()})},_flipOver:function(e){var t,n,r,i,s,o,u,a,f;f=this.clonedPosns(),u=f[0],o=f[1],a=f[2],s=f[3],r=f[4],t=f[5],n=f[6],i=f[7];switch(e){case"T":this.tl=this.bl.reflect(u),this.tc=this.bc.reflect(o),this.tr=this.br.reflect(a),this.rc=this.rc.reflect(a),this.lc=this.lc.reflect(u),this.bc=o,this.bl=u,this.br=a,ui.selection.scale(1,-1,this.bc);break;case"B":this.bl=this.tl.reflect(n),this.bc=this.tc.reflect(t),this.br=this.tr.reflect(r),this.rc=this.rc.reflect(r),this.lc=this.lc.reflect(n),this.tc=t,this.tl=n,this.tr=r,ui.selection.scale(1,-1,this.tc);break;case"L":this.tl=this.tr.reflect(u),this.lc=this.rc.reflect(i),this.bl=this.br.reflect(n),this.tc=this.tc.reflect(u),this.bc=this.bc.reflect(n),this.rc=i,this.br=n,this.tr=u,ui.selection.scale(-1,1,this.rc);break;case"R":this.tr=this.tl.reflect(a),this.rc=this.lc.reflect(s),this.br=this.bl.reflect(r),this.tc=this.tc.reflect(a),this.bc=this.bc.reflect(r),this.lc=s,this.bl=r,this.tl=a,ui.selection.scale(-1,1,this.lc)}return this.redraw()},flipOriginHorizontally:function(e){switch(e){case this.tl:return this.tr;case this.tr:return this.tl;case this.br:return this.bl;case this.bl:return this.br;case this.rc:return this.lc;case this.lc:return this.rc}},flipOriginVertically:function(e){switch(e){case this.tl:return this.tr;case this.tr:return this.tl;case this.br:return this.bl;case this.bl:return this.br;case this.rc:return this.lc;case this.lc:return this.rc}},scale:function(e,t,n){var r,i,s,o,u;this.origin=n,r=this.center(),u=this.pointsToScale(this.origin);for(s=0,o=u.length;s<o;s++)i=u[s],this.angle!==0&&i.rotate(360-this.angle,r),i.scale(e,t,this.origin.clone().rotate(360-this.angle,r)),this.angle!==0&&i.rotate(this.angle,r);return this,this.width*=e,this.height*=t,this.width===0&&(this.width=1),this.height===0&&(this.height=1),this.accumX*=e,this.accumY*=t,this},pointsToScale:function(e){switch(e){case this.tc:return[this.bl,this.bc,this.br,this.rc,this.lc];case this.rc:return[this.bl,this.lc,this.tl,this.tc,this.bc];case this.bc:return[this.tl,this.tc,this.tr,this.rc,this.lc];case this.lc:return[this.br,this.rc,this.tr,this.bc,this.tc];case this.tl:return[this.tr,this.br,this.bl,this.tc,this.rc,this.bc,this.lc];case this.tr:return[this.tl,this.br,this.bl,this.tc,this.rc,this.bc,this.lc];case this.br:return[this.tl,this.tr,this.bl,this.tc,this.rc,this.bc,this.lc];case this.bl:return[this.tl,this.tr,this.br,this.tc,this.rc,this.bc,this.lc];default:return[this.tl,this.tr,this.br,this.bl,this.tc,this.rc,this.bc,this.lc]}},nudge:function(e,t){var n,r,i,s;s=[this.tl,this.tr,this.br,this.bl,this.tc,this.rc,this.bc,this.lc];for(r=0,i=s.length;r<i;r++)n=s[r],n.nudge(e,-t);return this},rotate:function(e,t){var n,r,i,s;this.origin=t,this.angle+=e,this.angle%=360,this.accumA+=e,this.accumA%=360,s=[this.tl,this.tr,this.br,this.bl,this.tc,this.rc,this.bc,this.lc];for(r=0,i=s.length;r<i;r++)n=s[r],n.rotate(e,this.origin);return this},setup:function(){return this.resetAccum(),this.reps={tl:Gt("#trfm-tl"),tr:Gt("#trfm-tr"),br:Gt("#trfm-br"),bl:Gt("#trfm-bl"),tc:Gt("#trfm-tc"),rc:Gt("#trfm-rc"),bc:Gt("#trfm-bc"),lc:Gt("#trfm-lc"),c:Gt("#trfm-c"),outline:Gt("#trfm-outline")}},tl:new J(0,0),tr:new J(0,0),br:new J(0,0),bl:new J(0,0),tc:new J(0,0),rc:new J(0,0),bc:new J(0,0),lc:new J(0,0),onRotatingMode:function(){return $(this.reps.c).hide()},offRotatingMode:function(){if(ui.selection.elements.all.length===0)return;return $(this.reps.c).show()}},nn.push(function(){return ui.transformer.setup()}),ui.hotkeys={sets:{root:{context:ui,down:{"cmd-S":function(e){return e.preventDefault(),this.file.save()},"cmd-N":function(e){return e.preventDefault(),console.log("new")},"cmd-O":function(e){e.preventDefault();if(this.file.service!=null)return this.file.service.open()}},up:{}},app:{context:ui,ignoreAllOthers:!1,down:{V:function(e){return this.switchToTool(tools.cursor)},P:function(e){return this.switchToTool(tools.pen)},C:function(e){return this.switchToTool(tools.crayon)},"\\":function(e){return this.switchToTool(tools.line)},L:function(e){return this.switchToTool(tools.ellipse)},T:function(e){return this.switchToTool(tools.type)},M:function(e){return this.switchToTool(tools.rectangle)},R:function(e){return this.switchToTool(tools.rotate)},Z:function(e){return this.switchToTool(tools.zoom)},I:function(e){return this.switchToTool(tools.eyedropper)},space:function(e){return e.preventDefault(),this.switchToTool(tools.paw)},"shift-X":function(){var e;return e=ui.fill.clone(),ui.fill.absorb(ui.stroke),ui.stroke.absorb(e)},"cmd-.":function(e){return e.preventDefault(),ui.selection.elements.ofType("text").map(function(e){return e.data["font-size"]+=1,e.commit()}),ui.transformer.refresh()},"cmd-shift-.":function(e){return e.preventDefault(),ui.selection.elements.ofType("text").map(function(e){return e.data["font-size"]+=10,e.commit()}),ui.transformer.refresh()},"cmd-,":function(e){return e.preventDefault(),ui.selection.elements.ofType("text").map(function(e){return e.data["font-size"]-=1,e.commit()}),ui.transformer.refresh()},"cmd-shift-,":function(e){return e.preventDefault(),ui.selection.elements.ofType("text").map(function(e){return e.data["font-size"]-=10,e.commit()}),ui.transformer.refresh()},"cmd-F":function(e){return e.preventDefault()},U:function(e){return e.preventDefault(),Kt.merge(this.selection.elements.all)},"cmd-D":function(e){return e.preventDefault()},"cmd-S":function(e){return e.preventDefault(),ui.file.save()},"ctrl-L":function(){return ui.annotations.clear()},leftArrow:function(){return this.selection.nudge(-1,0)},rightArrow:function(){return this.selection.nudge(1,0)},upArrow:function(){return this.selection.nudge(0,1)},downArrow:function(){return this.selection.nudge(0,-1)},"shift-leftArrow":function(){return this.selection.nudge(-10,0)},"shift-rightArrow":function(){return this.selection.nudge(10,0)},"shift-upArrow":function(){return this.selection.nudge(0,10)},"shift-downArrow":function(){return this.selection.nudge(0,-10)}},up:{space:function(){return this.switchToLastTool()},"+":function(){return this.refreshAfterZoom()},"-":function(){return this.refreshAfterZoom()}}}},use:function(e){var t,n,r;typeof e=="string"?this.using=this.sets[e]:typeof e=="object"&&(this.using=e),r=this.sets.root.down;for(t in r){if(!ln.call(r,t))continue;n=r[t],this.using.down[t]==null&&(this.using.down[t]=n)}return this.enable()},reset:function(){return this.lastKeystroke="",this.modifiersDown=[],this.keysDown=[]},disable:function(){return this.using===this.sets.app&&(this.disabled=!0),this},enable:function(){return this.disabled=!1,this.cmdDown=!1,this},modifiersDown:[],registerModifier:function(e){if(!this.modifiersDown.has(e))return this.modifiersDown.push(e),ui.uistate.get("tool").activateModifier(e)},registerModifierUp:function(e){if(this.modifiersDown.has(e))return this.modifiersDown=this.modifiersDown.remove(e),ui.uistate.get("tool").deactivateModifier(e)},keysDown:[],cmdDown:!1,simulatedKeypressInterval:null,beginSimulatedKeypressTimeout:null,keypressIntervals:[],lastKeystroke:"",lastEvent:{},setup:function(){var e=this;return this.use("app"),ui.window.on("focus",function(){return e.modifiersDown=[],e.keysDown=[]}),$(document).on("keydown",function(t){var n,r,i,s,o,u,a,f,l,c,h,p,d;if(Dt(t.target)&&!t.target.hasAttribute("h"))return!0;ui.afk.reset();if(e.disabled)return!0;o=e.parseKeystroke(t);if(o===null)return!1;e.lastEvent=t,t.metaKey?e.registerModifier("cmd"):(e.cmdDown=!1,e.registerModifierUp("cmd"));if(o==="cmd"){e.cmdDown||(e.cmdDown=!0,e.registerModifier("cmd"));return}if(o==="shift"||o==="alt"||o==="ctrl"){e.registerModifier(o),l=e.keysDown;for(a=0,f=l.length;a<f;a++)s=l[a],(c=e.using.up)!=null&&(h=c[e.fullKeystroke(s,"")])!=null&&h.call(e.using.context,t);return}e.keysDown.has(o)?u=!1:(u=!0,e.keysDown.push(o)),e.using==null&&e.use("app"),i=e.fullKeystroke(o),i==="cmd-O"&&t.preventDefault();if(((p=e.using.down)!=null?p[i]:void 0)!=null||((d=e.using.up)!=null?d[i]:void 0)!=null){if(e.keypressIntervals.length===0){e.simulatedKeypress(),e.keypressIntervals=[];if(e.cmdDown)return;return e.keypressIntervals=[0],e.beginSimulatedKeypressTimeout!=null&&clearTimeout(e.beginSimulatedKeypressTimeout),e.beginSimulatedKeypressTimeout=setTimeout(function(){return e.keypressIntervals.push(setInterval(function(){return e.simulatedKeypress()},100))},350)}return e.keypressIntervals.length>0?(u&&e.simulatedKeypress(),!1):!1}if(e.using.ignoreAllOthers)return!1;if(e.using.blacklist!=null&&e.using.blacklist!==null)return r=e.using.blacklist,n=i,n.match(r)?(e.using.inheritFromApp.has(n)&&(e.sets.app.down[n].call(ui),e.using.context.$rep.blur(),e.use("app")),!1):!0}).on("keyup",function(t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g;if(e.disabled)return!0;s=e.parseKeystroke(t),e.keysDown.length===1&&e.clearAllIntervals();if(s===null)return!1;(c=e.using.up)!=null&&(h=c[s])!=null&&h.call(e.using.context,t),e.modifiersDown.length>0&&(p=e.using.up)!=null&&(d=p[e.fullKeystroke(s)])!=null&&d.call(e.using.context,t);if(e.isModifier(s)){v=e.keysDown;for(o=0,u=v.length;o<u;o++)i=v[o],(m=e.using.up)!=null&&(g=m[e.fullKeystroke(i,s)])!=null&&g.call(e.using.context,t)}(a=e.using.up)!=null&&(f=a.always)!=null&&f.call(e.using.context,e.lastEvent);if(s==="cmd"){e.modifiersDown=e.modifiersDown.remove("cmd"),ui.uistate.get("tool").deactivateModifier("cmd"),e.keysDown=[],e.cmdDown=!1,l=e.using.up;for(r in l){if(!ln.call(l,r))continue;n=l[r],r.mentions("cmd")&&n.call(e.using.context,t)}return e.lastKeystroke="",e.maintainInterval()}return s==="shift"||s==="alt"||s==="ctrl"?(e.modifiersDown=e.modifiersDown.remove(s),ui.uistate.get("tool").deactivateModifier(s),e.maintainInterval()):(e.keysDown=e.keysDown.remove(s),e.maintainInterval())})},clearAllIntervals:function(){var e,t,n,r;r=this.keypressIntervals;for(t=0,n=r.length;t<n;t++)e=r[t],clearInterval(e);return this.keypressIntervals=[]},simulatedKeypress:function(){var e,t,n,r,i,s,o,u,a,f;this.maintainInterval();if(this.keysDown.length===0)return;i=this.keysDown,f=[];for(n=0,r=i.length;n<r;n++)t=i[n],e=this.fullKeystroke(t),this.cmdDown&&this.lastKeystroke===e&&4,((s=this.using.down)!=null?s[e]:void 0)!=null&&((o=this.using.down)!=null&&o[e].call(this.using.context,this.lastEvent),this.lastKeystroke=e),f.push((u=this.using.down)!=null?(a=u.always)!=null?a.call(this.using.context,this.lastEvent):void 0:void 0);return f},maintainInterval:function(){if(this.keysDown.length===0)return this.clearAllIntervals()},isModifier:function(e){switch(e){case"shift":case"cmd":case"alt":return!0;default:return!1}},parseKeystroke:function(e){var t,n,r,i;return r={8:"backspace",16:"shift",17:"ctrl",18:"alt",91:"cmd",92:"cmd",224:"cmd"},r[e.which]!=null?r[e.which]:(t=[new K(9,9),new K(13,13),new K(65,90),new K(32,32),new K(37,40),new K(48,57),new K(187,190),new K(219,222)],t.map(function(t){return t.containsInclusive(e.which)}).filter(function(e){return e===!0}).length===0?null:(i={13:"enter",32:"space",37:"leftArrow",38:"upArrow",39:"rightArrow",40:"downArrow",187:"+",188:",",189:"-",190:".",219:"[",220:"\\",221:"]",222:"'"},n=i[e.which]||String.fromCharCode(e.which),n))},fullKeystroke:function(e,t){return t==null&&(t=this.modifiersPrefix()),""+t+(t.length>0?"-":"")+e},modifiersPrefix:function(){var e;return e=this.modifiersDown.sort().join("-"),/Win/.test(navigator.platform)&&(e=e.replace("ctrl","cmd")),e}},nn.push(function(){return ui.hotkeys.setup()}),ui.gallery={service:void 0,open:function(e){var t,n,r=this;return this.service=e,ui.changeTo("gallery"),$(".service-logo").attr("class","service-logo "+this.service.name.toLowerCase()),$(".file-listing").css("opacity","1.0"),$("#service-search-input").attr("placeholder","Search for files"),$("#cancel-open-file").one("click",function(){return ui.clear(),ui.file.load(),ui.changeTo("draw")}),t=Ct.$serviceGallery.find(".loading"),n=ui.account.services.map(function(e){return services[e].name}),t.text("Connecting to "+n.join(", ")+"...").show(),Ct.$serviceGalleryThumbs.empty(),St(function(){var n,i,s,o;s=ui.account.services,o=[];for(n=0,i=s.length;n<i;n++)e=s[n],o.push(services[e].getSVGs(function(e){t.hide(),Ct.$currentService.find("input:text").val("").focus(),$("#service-file-gallery-message").text(""+e.length+" SVG files found");if(e.length>0)return r.draw(e)}));return o})},choose:function(e){var t,n,r,i,s,o,u,a,f,l;s=e.attr("path"),i=e.attr("name"),r=e.attr("key"),o=e.attr("service"),ui.clear(),(new S).fromService(services[o])(r).use(!0),ui.changeTo("draw"),f=$(".file-listing"),l=[];for(u=0,a=f.length;u<a;u++)n=f[u],t=$(n),t.attr("name")!==i||t.attr("path")!==s?l.push(t.css("opacity",.2).unbind("click")):l.push(void 0);return l},draw:function(e){var t,n,r,i;ui.canvas.setZoom(1);for(r=0,i=e.length;r<i;r++)n=e[r],t=this.fileListing(n),Ct.$serviceGalleryThumbs.append(t),t.one("click",function(){return ui.gallery.choose($(this))});return this.drawThumbnails(e[0],e.slice(1))},drawThumbnails:function(e,t){var n,r,s=this;n=$('.file-listing[key="'+e.key+'"] .file-thumbnail-img'),e.thumbnail!=null?(r=new Image,r.onload=function(){return s.appendThumbnail(e.thumbnail,n)},r.src=e.thumbnail):e.service.get(""+e.path+e.name,function(t){var r,o,u,a,f;o=t.contents,f=Ct.$main.children().length,r=Mt.getBounds(o),u=r.fitTo(new i(0,0,260,260)),a=Mt.makePNGURI(o,260);if(Ct.$main.children().length!==f)debugger;s.appendThumbnail(a,n,u);if(e.service!==services.local)return $.ajax({url:""+Z.MEOWSET.ENDPOINT+"/files/thumbnails/put",type:"POST",data:{session_token:ui.account.session_token,full_path:""+e.path+e.name,last_modified:""+e.modified,content:a}})});if(t.length>0)return this.drawThumbnails(t[0],t.slice(1))},fileListing:function(e){var t;return t=$('<div class="file-listing" service="'+e.service.name.toLowerCase()+'" path="'+e.path+'" name="'+e.name+'" key="'+e.key+'" quarantine>\n  <div class="file-thumbnail">\n    <div class="file-thumbnail-img"></div>\n  </div>\n  <div class="file-name">'+e.name+'</div>\n  <div class="file-path">in '+e.displayLocation+"</div>\n</div>")},appendThumbnail:function(e,t,n){var r;return r=new Image,r.onload=function(){var e;return t.append(this),e=$(r),r.style.margin=""+(300-e.height())/2+"px "+(300-e.width())/2+"px"},r.src=e}},nn.push(function(){return $("#service-search-input").on("keyup.gs",function(e){var t,n;return t=$(this),n=t.val().toLowerCase(),n===""?$(".file-listing").show():$(".file-listing").each(function(){var e,t,r,i;return e=$(this),i=e.attr("path"),r=e.attr("name"),t=e.attr("key"),r.toLowerCase().indexOf(n)>-1?e.show():e.hide()})})}),ui.browser={service:void 0,saveToPath:"/",open:function(e){var t,n,r,i,s,o=this;this.service=e,this.saveToPath="/",n=Ct.$serviceBrowser.find("#service-options"),n.empty(),this.removeDirectoryColumnsAfter(1),s=ui.account.services;for(r=0,i=s.length;r<i;r++)e=s[r],n.append(this.serviceButton(e));ui.changeTo("browser"),$("#current-file-saving-name-input").val(ui.file.name.replace(".svg","")).fitToVal(20),$("#service-search-input").attr("placeholder","Search for folder"),$("#cancel-save-file").unbind("click").on("click",function(){return ui.changeTo("draw")}),$("#confirm-save-file").unbind("click").on("click",function(){return o.save()}),t=Ct.$serviceBrowser.find(".loading"),t.hide();if(this.service!=null)return n.addClass("has-selection"),n.find("."+this.service.name).addClass("selected"),$(".service-logo").attr("class","service-logo "+this.service.name.toLowerCase()),t.text("Conecting to "+this.service.name+"...").show(),this.addDirectoryColumn("/",1,function(){return t.hide()})},save:function(){var e,t=this;return e=""+$("#current-file-saving-name-input").val()+".svg",ui.changeTo("draw"),this.service.put(""+this.saveToPath+e,Mt.makeFile(),function(n){debugger;return(new S).fromService(t.service)(e).use()})},addDirectoryColumn:function(e,t,n){var r=this;return n==null&&(n=function(){}),this.removeDirectoryColumnsAfter(t),this.service.getSaveLocations(e,function(e,i){return n(),$("#browser-directory").append(r.directoryColumn(e,i,t))})},recursivePreload:function(e){var t=this;return this.service.getSaveLocations(e[0].path,function(){if(e.length>1)return t.recursivePreload(e.slice(1))})},removeDirectoryColumnsAfter:function(e){return $(".scrollbar-screen-directory-col").each(function(){var t;t=$(this);if(parseInt(t.attr("index"),10)>=e)return t.remove()})},directoryColumn:function(e,t,n){var r,i,s,o,u,a,f,l;i=$('<div class="scrollbar-screen-directory-col" index="'+n+'">\n  <div class="directory-col"></div>\n</div>').css({left:""+201*n+"px"}),r=i.find(".directory-col");if(e.length>0){r.append($("<div folders></div>"));for(u=0,f=e.length;u<f;u++)s=e[u],r.find("[folders]").append(this.directoryButton(s.path,s.path.match(/\/[^\/]*$/)[0].substring(1),n))}if(t.length>0){r.append($("<div files></div>"));for(a=0,l=t.length;a<l;a++)o=t[a],r.find("[files]").append(this.fileButton(o.path,o.path.match(/\/[^\/]*$/
)[0].substring(1),n))}return i},directoryButton:function(e,t,n){return $('<div class="directory-button">'+t+"</div>").on("click",function(){var t;return t=$(this),t.hasClass("selected")?(t.removeClass("selected").parent().parent().removeClass("has-selection"),ui.browser.removeDirectoryColumnsAfter(n+1)):(ui.browser.saveToPath=""+e+"/",ui.browser.addDirectoryColumn(""+e,n+1),$("#current-file-saving-directory-path").text(""+e+"/"),t.parent().parent().find(".directory-button").removeClass("selected"),t.addClass("selected").parent().parent().addClass("has-selection"))})},fileButton:function(e,t,n){return $('<div class="file-button">'+t+"</div>").on("click",function(){return $("#current-file-saving-name-input").val(t.replace(".svg","")).trigger("keyup")})},serviceButton:function(e){var t=this;return $('<div class="service-button '+e+'">'+(e[0].toUpperCase()+e.substring(1))+" </div>").on("click",function(){return t.open(services[e])})}},f=function(){function e(e){var t,n,r=this;for(t in e)n=e[t],this[t]=n;this,this.$rep=$(this.rep),this.$rep.bind("focus",function(){return r.focus()}),this.$rep.bind("blur",function(){return r.blur()}),this.$rep.bind("read",function(e){return e(r.read())}),this.$rep.bind("set",function(e){return r.set(e)}),this.commitFunc=e.commit,this.commit=function(){return this.commitFunc(this.read())}}return e.prototype.focused=!1,e.prototype.value=null,e.prototype.valueWhenFocused=void 0,e.prototype.appendTo=function(e){return Gt(e).appendChild(this.rep)},e.prototype.focus=function(){var e;return(e=ui.controlFocused)!=null&&e.blur(),this.valueWhenFocused=this.read(),this.focused=!0,ui.controlFocused=this,ui.hotkeys.use(this.hotkeys)},e.prototype.blur=function(){ui.controlFocused=void 0,this.focused=!1;if(this.read()!==this.valueWhenFocused)return this.commit()},e.prototype.update=function(){return this.rep.setAttribute("value",this.value)},e.prototype.commit=function(){},e.prototype.build=function(){},e.prototype.read=function(){},e.prototype.write=function(e){},e.prototype.set=function(e){return this.value=e,this.write(this.value),this.update()},e.prototype.hotkeys={},e}(),v=function(e){function t(e){var n=this;t.__super__.constructor.call(this,e),this.$chosen=this.$rep.find(".dropdown-chosen"),this.$list=this.$rep.find(".dropdown-list"),this.options.map(function(e){return n.$list.append(e.$rep)}),e["default"]!=null&&this.$chosen.empty().append(),this.select(this.options[0]),this.close(),this.$chosen.click(function(){return n.toggle()})}return cn(t,e),t.prototype.select=function(e){return this.selected=e,this.$chosen.children().first().appendTo(this.$list),this.$chosen.append(this.selected.$rep),this.refreshListeners(),this.callback(this.selected.val)},t.prototype.opened=!1,t.prototype.open=function(){return this.$list.find("div").tsort(),this.opened=!0,this.$list.show(),this.refreshListeners()},t.prototype.close=function(){return this.opened=!1,this.$list.hide()},t.prototype.refreshListeners=function(){var e=this;return this.$list.find("div").off("click"),this.$list.find("div").on("click",function(t){return e.select(e.getOption(t.target.innerHTML)),e.close()})},t.prototype.toggle=function(){return this.opened?this.close():this.open()},t.prototype.getOption=function(e){return this.options.filter(function(t){return t.val===e})[0]},t}(f),g=function(){function e(e){this.val=e,this.$rep=$('<div class="dropdown-item">'+this.val+"</div>")}return e}(),T=function(e){function t(e){this.name=e,t.__super__.constructor.apply(this,arguments),this.$rep.css({"font-family":this.name,"font-size":"14px"})}return cn(t,e),t}(g),B=function(e){function t(e){t.__super__.constructor.call(this,e),e.addVal!=null?this.addVal=e.addVal:this.addVal=this._addVal,this.rep.setAttribute("h",""),this.hotkeys=$.extend({context:this,down:{always:function(e){return typeof this.onDown=="function"?this.onDown(e,this.read()):void 0},enter:function(e){return this.write(this.read()),this.commit(),typeof this.onDone=="function"?this.onDone(e,this.read()):void 0},upArrow:function(e){return this.addVal(e,1)},downArrow:function(e){return this.addVal(e,-1)},"shift-upArrow":function(e){return this.addVal(e,10)},"shift-downArrow":function(e){return this.addVal(e,-10)},"alt-upArrow":function(e){return this.addVal(e,.1)},"alt-downArrow":function(e){return this.addVal(e,-0.1)}},up:{upArrow:function(e){return typeof this.onDone=="function"?this.onDone(e,this.read()):void 0},downArrow:function(e){return typeof this.onDone=="function"?this.onDone(e,this.read()):void 0},"shift-upArrow":function(e){return typeof this.onDone=="function"?this.onDone(e,this.read()):void 0},"shift-downArrow":function(e){return typeof this.onDone=="function"?this.onDone(e,this.read()):void 0},"alt-upArrow":function(e){return typeof this.onDone=="function"?this.onDone(e,this.read()):void 0},"alt-downArrow":function(e){return typeof this.onDone=="function"?this.onDone(e,this.read()):void 0},always:function(e){return typeof this.onUp=="function"?this.onUp(e,this.read()):void 0}},blacklist:/^[A-Z]$/gi,inheritFromApp:["V","P","M","L","\\","O","R"]},e.hotkeys)}return cn(t,e),t.prototype.read=function(){return parseFloat(this.$rep.val())},t.prototype.write=function(e){return this.value=e,this.places!=null&&(this.value=parseFloat(this.value).places(this.places)),this.max!=null&&(this.value=Math.min(this.max,this.value)),this.min!=null&&(this.value=Math.max(this.min,this.value)),this.$rep.val(this.value)},t.prototype._addVal=function(e,t){var n,r;return e.preventDefault(),r=this.read(),r==null&&(r=0),n=this.read()+t,this.write(n),this.commit()},t}(f),window.NumberBox=B,ft=function(e){function t(e){t.__super__.constructor.call(this,e),this.rep.setAttribute("h",""),e.maxLength!=null&&this.rep.setAttribute("maxLength",e.maxLength),this.hotkeys=$.extend({context:this,down:{always:function(e){return typeof this.onDown=="function"?this.onDown(e,this.read()):void 0},enter:function(e){return this.write(this.read()),this.commit(),typeof this.onDone=="function"?this.onDone(e,this.read()):void 0}},up:{always:function(e){return typeof this.onUp=="function"?this.onUp(e,this.read()):void 0}},blacklist:null,inheritFromApp:["V","P","M","L","\\","O","R"]},e.hotkeys)}return cn(t,e),t.prototype.read=function(){return this.$rep.val()},t.prototype.write=function(e){return this.value=e,this.$rep.val(this.value)},t}(f),window.TextBox=ft,it=function(e){function t(e){var n=this;t.__super__.constructor.call(this,e),this.hotkeys={},this.$knob=this.$rep.find(".knob"),this.$track=this.$rep.find(".track"),this.valueTipFormatter!=null&&this.$knob.append(this.$tip=$('<div class="slider tip"></div>')),this.knobWidth=this.$knob.width(),this.trackMin=parseFloat(this.$track.css("left")),this.trackWidth=parseFloat(this.$track.css("width"))-this.knobWidth,this.trackMax=this.trackMin+this.trackWidth,this.$knob.on("nudge",function(){var e;return n.commit(),(e=n.$tip)!=null?e.show().text(n.valueTipFormatter(n.read())):void 0}).on("stopDrag",function(){var e;return typeof n.onRelease=="function"&&n.onRelease(n.read()),(e=n.$tip)!=null?e.hide():void 0}).attr("drag-x",""+this.trackMin+" "+this.trackMax),this.set(0),this.$iconLeft=this.$rep.find(".left-icon"),this.$iconRight=this.$rep.find(".right-icon"),this.$knob.on("click",function(e){return e.stopPropagation()}),this.$iconLeft.on("click",function(e){return e.stopPropagation(),n.set(0),n.commit()}),this.$iconRight.on("click",function(e){return e.stopPropagation(),n.set(1),n.commit()}),this.$track=this.$rep.find(".track"),this.$rep.on("release",function(){return typeof n.onRelease=="function"?n.onRelease(n.read()):void 0})}return cn(t,e),t.prototype.read=function(){return this.leftCSSToFloat(parseFloat(this.$knob.css("left")))},t.prototype.write=function(e){return this.$knob.css("left",this.floatToLeftCSS(e))},t.prototype.floatToLeftCSS=function(e){var t;return e=Math.min(1,Math.max(0,e)),this.inverse&&(e=1-e),t=(this.trackWidth*e+this.trackMin).px()},t.prototype.leftCSSToFloat=function(e){var t;return t=(parseFloat(e)-this.trackMin)/this.trackWidth,this.inverse?1-t:t},t}(f),ui.menu={menus:{},items:{},menu:function(e){return $t(this.menus).filter(function(t){return t.itemid===e})[0]},item:function(e){return $t(this.items).filter(function(t){return t.itemid===e})[0]},closeAllDropdowns:function(){var e,t,n,r;n=this.menus,r=[];for(t in n){if(!ln.call(n,t))continue;e=n[t],r.push(e.closeDropdown())}return r},refresh:function(){var e,t,n,r;n=this.menus,r=[];for(e in n){if(!ln.call(n,e))continue;t=n[e],r.push(t.refresh())}return r}},_=function(){function e(e){var t,n;for(t in e)n=e[t],this[t]=n;this.$rep=$("#"+this.itemid),this.rep=this.$rep[0],this.$dropdown=$("#"+this.itemid+"-dropdown"),this.dropdown=this.$dropdown[0],this.dropdownSetup()}return e.prototype.refresh=function(){return this.items().map(function(){return this._refresh()})},e.prototype.refreshEnabledItems=function(){return this.items().map(function(){if(this.enableWhen!=null)return this.enableWhen()?this.enable():this.disable()})},e.prototype.refreshAfterVisible=function(){return this.items().map(function(){return typeof this.refreshAfterVisible=="function"?this.refreshAfterVisible():void 0})},e.prototype.items=function(){return this.$rep.find(".menu-item").map(function(){return ui.menu.item(this.id)})},e.prototype.disabled=!1,e.prototype.dropdownOpen=!1,e.prototype.text=function(e){return this.$rep.find("> [buttontext]").text(e),this},e.prototype._click=function(){return this.toggleDropdown(),ui.refreshUtilities(),typeof this.click=="function"?this.click():void 0},e.prototype.openDropdown=function(){var e=this;if(this.dropdownOpen)return;return ui.menu.closeAllDropdowns(),this.$rep.attr("selected",""),this.refresh(),this.$dropdown.show(),this.dropdownOpen=!0,sn("Menu "+this.itemid,"Action (click)"),St(function(){return e.refreshAfterVisible()}),this},e.prototype.closeDropdown=function(){if(!this.dropdownOpen)return;return this.$rep.removeAttr("selected"),this.$rep.find("input:focus").blur(),this.$dropdown.hide(),this.dropdownOpen=!1,typeof this.onClose=="function"&&this.onClose(),this},e.prototype.toggleDropdown=function(){return this.dropdownOpen?this.closeDropdown():this.openDropdown()},e.prototype.show=function(){var e;return(e=this.rep)!=null&&(e.style.display="block"),this},e.prototype.hide=function(){var e;return(e=this.rep)!=null&&(e.style.display="none"),this},e.prototype.dropdownSetup=function(){},e.prototype.group=function(){return this.$rep.closest(".menu-group")},e.prototype.groupHide=function(){var e;return(e=this.group())!=null?e.hide():void 0},e.prototype.groupShow=function(){var e;return(e=this.group())!=null?e.css("display","inline-block"):void 0},e}(),D=function(){function e(e){var t,n,r=this;for(t in e)n=e[t],this[t]=n;this.$rep=$("#"+this.itemid),this.rep=this.$rep[0];if(this.hotkey!=null){ui.hotkeys.sets.app.down[this.hotkey]=function(e){var t,n;e.preventDefault(),r._refresh();if(r.disabled)return;r.action(e),sn("Menu item "+r.itemid,"Action (hotkey)"),(t=r.owner())!=null&&t.refresh(),r.$rep.addClass("down"),(n=r.owner())!=null&&n.$rep.addClass("down");if(r.hotkey.mentions("cmd"))return setTimeout(function(){var e;return r.$rep.removeClass("down"),(e=r.owner())!=null&&e.$rep.removeClass("down"),r._refresh()},50)};if(!this.hotkey.mentions("cmd")){if(this.disabled)return;ui.hotkeys.sets.app.up[this.hotkey]=function(e){var t;return r.$rep.removeClass("down"),(t=r.owner())!=null&&t.$rep.removeClass("down"),typeof r.after=="function"&&r.after(),r._refresh()}}}}return e.prototype._click=function(e){var t,n,r;this._refresh();if(this.disabled)return;return this.closeOnClick&&(t=this.owner())!=null&&t.closeDropdown(),(n=this.owner())!=null&&n.$rep.find("[selected]").removeAttr("selected"),typeof this.action=="function"&&this.action(e),(r=this.owner())!=null&&r.refreshEnabledItems(),sn("Menu item "+this.itemid,"Action (click)")},e.prototype.closeOnClick=!0,e.prototype.save=function(){},e.prototype._refresh=function(){typeof this.refresh=="function"&&this.refresh();if(this.enableWhen!=null)return this.enableWhen()?this.enable():this.disable()},e.prototype.refresh=function(){},e.prototype.owner=function(){return ui.menu.menu(this.$rep.closest(".menu").attr("id"))},e.prototype.show=function(){return this.$rep.show(),$('.separator[visiblewith="'+this.itemid+'"]').show(),this},e.prototype.hide=function(){return this.$rep.hide(),$('.separator[visiblewith="'+this.itemid+'"]').hide(),this},e.prototype.disable=function(){return this.disabled=!0,this.$rep.addClass("disabled"),this},e.prototype.enable=function(){return this.disabled=!1,this.$rep.removeClass("disabled"),this},e.prototype.text=function(e){return this.$rep.find("[buttontext]").text(e)},e.prototype.group=function(){return this.$rep.closest(".menu-group")},e.prototype.groupHide=function(){var e;return(e=this.group())!=null?e.hide():void 0},e.prototype.groupShow=function(){var e;return(e=this.group())!=null?e.css("display","inline-block"):void 0},e}(),nn.push(function(){return ui.menu.menus.file=new _({itemid:"file-menu"})}),nn.push(function(){return ui.menu.menus.edit=new _({itemid:"edit-menu"}),ui.menu.items.undo=new D({itemid:"undo-item",action:function(e){return e.preventDefault(),archive.undo()},hotkey:"cmd-Z",closeOnClick:!1,enableWhen:function(){return!archive.currentlyAtBeginning()}}),ui.menu.items.redo=new D({itemid:"redo-item",action:function(e){return e.preventDefault(),archive.redo()},hotkey:"cmd-shift-Z",closeOnClick:!1,enableWhen:function(){return!archive.currentlyAtEnd()}}),ui.menu.items.visualHistory=new D({itemid:"visual-history",action:function(e){return ui.utilities.history.toggle()},hotkey:"0",closeOnClick:!1,enableWhen:function(){return archive.events.length>0}}),ui.menu.items.selectAll=new D({itemid:"select-all-item",action:function(e){return e.preventDefault(),ui.selection.elements.selectAll()},hotkey:"cmd-A",closeOnClick:!1,enableWhen:function(){return ui.elements.length>0}}),ui.menu.items.cut=new D({itemid:"cut-item",action:function(e){return e.preventDefault(),ui.clipboard.cut()},hotkey:"cmd-X",closeOnClick:!1,enableWhen:function(){return ui.selection.elements.all.length>0}}),ui.menu.items.copy=new D({itemid:"copy-item",action:function(e){return e.preventDefault(),ui.clipboard.copy()},hotkey:"cmd-C",closeOnClick:!1,enableWhen:function(){return ui.selection.elements.all.length>0}}),ui.menu.items.paste=new D({itemid:"paste-item",action:function(e){return e.preventDefault(),ui.clipboard.paste()},hotkey:"cmd-V",closeOnClick:!1,enableWhen:function(){return ui.clipboard.data!=null}}),ui.menu.items["delete"]=new D({itemid:"delete-item",action:function(e){return e.preventDefault(),archive.addExistenceEvent(ui.selection.elements.all.map(function(e){return e.zIndex()})),ui.selection["delete"](),ui.selection.elements.validate()},hotkey:"backspace",closeOnClick:!1,enableWhen:function(){return ui.selection.elements.all.length>0}})}),nn.push(function(){return ui.menu.menus.view=new _({itemid:"view-menu"}),ui.menu.items.zoomOut=new D({itemid:"zoom-out-item",action:function(e){return e.preventDefault(),ui.canvas.zoomOut(),!1},after:function(){return ui.refreshAfterZoom()},hotkey:"-",closeOnClick:!1}),ui.menu.items.zoomIn=new D({itemid:"zoom-in-item",action:function(e){return e.preventDefault(),ui.canvas.zoomIn(),!1},after:function(){return ui.refreshAfterZoom()},hotkey:"+",closeOnClick:!1}),ui.menu.items.zoom100=new D({itemid:"zoom-100-item",action:function(e){return e.preventDefault(),ui.canvas.zoom100(),!1},after:function(){return ui.refreshAfterZoom()},hotkey:"1",closeOnClick:!1}),ui.menu.items.grid=new D({itemid:"show-grid-item",hotkey:"shift-'",action:function(){return ui.grid.toggle()},closeOnClick:!1})}),nn.push(function(){return ui.menu.menus.login=new _({itemid:"login-menu",refreshAfterVisible:function(){return $("#login-email-input").focus()},submit:function(e){var t,n;return t=$("#login-email-input").val(),n=$("#login-passwd-input").val(),t===""?e.error("email required"):n===""?e.error("password required"):ui.account.login(t,n)}}),$("#submit-login").click(function(){return ui.menu.menus.login.submit($(this))}),$("#login-passwd-input").hotkeys({down:{enter:function(){return ui.menu.menus.login.submit()}}})}),nn.push(function(){return ui.menu.menus.register=new _({itemid:"register-menu",refreshAfterVisible:function(){return $("#register-name").focus()},submit:function(){var e,t,n;return t=$("#register-name").val(),e=$("#register-email").val(),n=$("#register-passwd").val(),ui.account.create(t,e,n,function(e){})}}),$("#submit-registration").click(function(){return ui.menu.menus.register.submit()}),$("#register-passwd").hotkeys({down:{enter:function(){return ui.menu.menus.register.submit()}}})}),nn.push(function(){return ui.menu.menus.geometry=new _({itemid:"geometry-menu"})}),nn.push(function(){return ui.menu.menus.account=new _({itemid:"account-menu",showAndFillIn:function(e){return this.group().style.display="inline-block",this.$rep.find("span#logged-in-email").text(e)},onClose:function(){return this.$dropdown.attr("mode","normal")}})}),nn.push(function(){return ui.menu.menus.share=new _({itemid:"share-menu"}),ui.menu.items.shareAsLink=new D({itemid:"share-permalink-item",action:function(){return services.permalink.put()}})}),nn.push(function(){return ui.menu.menus.embed=new _({itemid:"embed-menu",template:function(){var e;return e=ui.canvas.height/ui.canvas.width*this.width+31,e=Math.ceil(e),'<iframe width="'+this.width+'" height="'+e+'" frameborder="0" src="'+Z.EMBED.ENDPOINT+"/files/permalinks/"+ui.file.key+'/embed"></iframe>'},refreshAfterVisible:function(){var e=this;return ui.file.constructor===I?(this.generateCode(),this.$textarea.select()):(this.$textarea.val("Saving, please wait..."),this.$textarea.disable(),services.permalink.put(void 0,Mt.makeFile(),function(){return e.generateCode(),e.$textarea.enable(),e.$textarea.select()}))},dropdownSetup:function(){var e=this;return this.width=500,this.$textarea=this.$rep.find("textarea"),this.widthControl=new B({rep:this.$rep.find("input")[0],value:this.width,min:100,max:1600,places:0,hotkeys:{up:{always:function(){return this.commit()}}},commit:function(t){return e.width=t,e.generateCode()}})},generateCode:function(){return this.$textarea.val(this.template())}})}),nn.push(function(){return ui.menu.items.filename=new D({itemid:"filename-item",refresh:function(e,t,n){return this.$rep.find("#file-name-with-extension").text(ui.file.name),this.$rep.find("#service-logo-for-filename").show().attr("class","service-logo-small "+ui.file.service.name),this.$rep.find("#service-path-for-filename").html(ui.file.path)},action:function(e){return e.stopPropagation()}})}),nn.push(function(){return ui.menu.items.save=new D({itemid:"save-item",action:function(e){var t=this;return e!=null&&e.preventDefault(),ui.file.save(function(){return t.enable(),t.text("Save")}),sn("Local files","Save"),this.disable(),this.text("Saving...")},hotkey:"cmd-S",refresh:function(){return ui.file.readonly?(this.disable(),this.text("This file is read-only")):ui.file.hasChanges()?(this.enable(),this.text("Save")):(this.disable(),this.text("All changes saved"))}}),ui.menu.items.saveAs=new D({itemid:"save-as-item",action:function(e){return e!=null&&e.preventDefault(),ui.browser.open()},hotkey:"cmd-shift-S",refresh:function(){return this.enable()}})}),nn.push(function(){return ui.menu.items["new"]=new D({itemid:"new-item",action:function(e){var t;ui["new"](1e3,750,new J(0,0),1);switch(ui.file.service){case services.permalink:case services.local:return t=(new O(services.local.nextDefaultName())).use(),ui.file.save(),archive.setup();case services.dropbox:return services.dropbox.defaultName(ui.file.path,function(e){return(new d(""+ui.file.path+e)).use()})}},hotkey:"N"})}),nn.push(function(){return ui.menu.items.logout=new D({itemid:"logout-item",action:function(){return ui.account.logout()}})}),nn.push(function(){return ui.menu.items.open=new D({itemid:"open-item",action:function(){return ui.file.service.open()}}),ui.menu.items.openHD=new D({itemid:"open-from-hd-item",action:function(){},refresh:function(){var e,t,n,r=this;return e=$("#hd-file-loader"),n=new FileReader,t=null,n.onload=function(e){return(new O(t)).set(e.target.result).use(!0).save(),r.owner().closeDropdown()},e.change(function(){var e;this.setAttribute("value",""),e=this.files[0];if(e==null)return;return t=e.name,n.readAsText(e),sn("Local files","Open from HD")})}}),ui.menu.items.openURL=new D({itemid:"open-from-url-item",action:function(){return this.inputMode(),setTimeout(function(){return ui.cursor.reset()},1)},openURL:function(e){var t;return t=e.match(/[^\/]*\.svg$/gi),t=t?t[0]:services.local.nextDefaultName(),$.ajax({url:""+Z.BONITA.ENDPOINT+"/curl/?url="+e,type:"GET",data:{},success:function(e){var n;return e=(new XMLSerializer).serializeToString(e),n=(new O(t)).set(e).use(!0),sn("Local files","Open from URL")},error:function(e){return console.log("error")}})},clickMeMode:function(){return this.$rep.find("input").blur(),this.$rep.removeClass("input-mode"),this.$rep.removeAttr("selected")},inputMode:function(){var e,t=this;return e=this,this.$rep.addClass("input-mode"),this.$rep.attr("selected",""),this.$rep.find("input").val("").focus().on("paste",function(e){return setTimeout(function(){return t.openURL($(e.target).val()),t.clickMeMode(),t.owner().closeDropdown()},10)})},closeOnClick:!1,refresh:function(){return this.clickMeMode()}})}),nn.push(function(){return ui.menu.items.dropboxConnect=new D({itemid:"connect-to-dropbox-item",refresh:function(){return ui.account.session_token?(this.enable(),this.rep.parentNode.setAttribute("href",""+Z.MEOWSET.ENDPOINT+"/poletto/connect-to-dropbox?session_token="+ui.account.session_token),this.$rep.parent().off("click").on("click",function(){return ui.window.one("focus",function(){return ui.menu.menus.file.closeDropdown(),ui.account.checkServices(),sn("Dropbox","Connect Account")})})):(this.disable(),this.$rep.parent().click(function(e){return e.preventDefault()}))}})}),nn.push(function(){return ui.menu.items.downloadSVG=new D({itemid:"download-as-SVG-item",refreshAfterVisible:function(){var e;return e=Gt("#download-svg-link"),this.disabled?(e.removeAttribute("href"),e.removeAttribute("download")):(e.setAttribute("href",Mt.makeBase64URI()),e.setAttribute("download",ui.file.name)),$(e).one("click",function(){return sn("Download","SVG",ui.file.name)})}}),ui.menu.items.downloadPNG=new D({itemid:"download-as-PNG-item",refreshAfterVisible:function(){var e;return e=Gt("#download-png-link"),this.disabled?(e.removeAttribute("href"),e.removeAttribute("download")):(e.setAttribute("href",Mt.makePNGURI()),e.setAttribute("download",ui.file.name.replace("svg","png"))),$(e).one("click",function(){return sn("Download","PNG",ui.file.name)})}})}),nn.push(function(){return ui.menu.items.moveBack=new D({itemid:"move-back-item",hotkey:"[",action:function(){var e;return e=ui.selection.elements.zIndexes(),ui.selection.elements.all.map(function(e){return e.moveBack()}),archive.addZIndexEvent(e,ui.selection.elements.zIndexes(),"mb")},enableWhen:function(){return ui.selection.elements.all.length>0},closeOnClick:!1}),ui.menu.items.moveForward=new D({itemid:"move-forward-item",hotkey:"]",action:function(){var e;return e=ui.selection.elements.zIndexes(),ui.selection.elements.all.map(function(e){return e.moveForward()}),archive.addZIndexEvent(e,ui.selection.elements.zIndexes(),"mf")},enableWhen:function(){return ui.selection.elements.all.length>0},closeOnClick:!1}),ui.menu.items.sendToBack=new D({itemid:"send-to-back-item",hotkey:"shift-[",action:function(){var e;return e=ui.selection.elements.zIndexes(),ui.selection.elements.all.map(function(e){return e.sendToBack()}),archive.addZIndexEvent(e,ui.selection.elements.zIndexes(),"mbb")},enableWhen:function(){return ui.selection.elements.all.length>0},closeOnClick:!1}),ui.menu.items.bringToFront=new D({itemid:"bring-to-front-item",hotkey:"shift-]",action:function(){var e;return e=ui.selection.elements.zIndexes(),ui.selection.elements.all.map(function(e){return e.bringToFront()}),archive.addZIndexEvent(e,ui.selection.elements.zIndexes(),"mff")},enableWhen:function(){return ui.selection.elements.all.length>0},closeOnClick:!1})}),ui.utilities={},mt=function(){function e(e){var t,n,r=this;for(t in e){if(!ln.call(e,t))continue;n=e[t],this[t]=n}this.setup!=null&&nn.push(function(){return r.setup()}),this.$rep=$(this.root),nn.push(function(){return r.shouldBeOpen()?r.show():r.hide()})}return e.prototype.shouldBeOpen=function(){},e.prototype.show=function(){var e;if(ui.canvas.petrified)return;return this.visible=!0,(e=this.rep)!=null&&(e.style.display="block"),typeof this.onshow=="function"&&this.onshow(),this},e.prototype.hide=function(){var e;return this.visible=!1,this.$rep.find("input").blur(),(e=this.rep)!=null&&(e.style.display="none"),this},e.prototype.toggle=function(){return this.visible?this.hide():this.show()},e.prototype.position=function(e,t){var n,r;return this.x=e,this.y=t,(n=this.rep)!=null&&(n.style.left=e.px()),(r=this.rep)!=null&&(r.style.top=t.px()),this},e.prototype.saveOffset=function(){return this.offset=new J($(this.rep).offset()),this},e}(),ui.utilities.color=new mt({setup:function(){var e=this;return this.rep=Gt("#color-picker-ut"),this.poolContainer=Gt("#pool-container"),this.poolContext=Gt("#color-picker-ut canvas#color-pool").getContext("2d"),this.saturationSliderContainer=Gt("#saturation-slider"),this.currentIndicator1=Gt("#color-marker1"),this.currentIndicator2=Gt("#color-marker2"),this.inputs={r:Gt("#color-r"),g:Gt("#color-g"),b:Gt("#color-b"),hex:Gt("#color-hex")},this.hide(),this.drawPool(),this.poolContainer.onscroll=function(e){this.scrollTop===0?this.scrollTop=1530:this.scrollTop===2800&&(this.scrollTop=1270);if(ui.cursor.down)return ui.utilities.color.selectColor(ui.cursor.lastEvent)},this.saturationSlider=new it({rep:this.saturationSliderContainer,commit:function(t){return e.drawPool(t),e.set(e.getColorAt(e.selected)),e.center}}),this.rControl=new B({rep:this.inputs.r,min:0,max:255,value:0,commit:function(t){return e.alterVal("r",t)}}),this.gControl=new B({rep:this.inputs.g,min:0,max:255,value:0,commit:function(t){return e.alterVal("g",t)}}),this.gControl=new B({rep:this.inputs.b,min:0,max:255,value:0,commit:function(t){return e.alterVal("b",t)}}),this.hexControl=new ft({rep:this.inputs.hex,value:0,commit:function(t){return e.set(new u(t)),e.refresh(),e.selectedColor.updateHex(),e.hexControl.write(e.selectedColor.hex)},hotkeys:{blacklist:null},maxLength:6})},alterVal:function(e,t){return this.selectedColor[e]=t,this.selectedColor.recalculateHex(),this.set(this.selectedColor),this.refresh()},refresh:function(){return this.drawPool(this.selectedColor.saturation()),this.saturationSlider.write(this.selectedColor.saturation()),this.selected=this.getPositionOf(this.selectedColor),this.updateIndicator().centerOnIndicator()},shouldBeOpen:function(){return!1},onshow:function(){return this.poolContainer.scrollTop=600,this.selectedColor=new u(this.setting.getAttribute("val")),this.selected=this.getPositionOf(this.selectedColor),this.saturationSlider.set(this.selectedColor.saturation()),this.drawPool(this.selectedColor.saturation()),this.updateIndicator(),this.centerOnIndicator(),sn("Color","Open picker")},ensureVisibility:function(){return this.rep.style.top=""+Math.min(ui.window.height()-360,parseFloat(this.rep.style.top))+"px",this.saveOffset()},centerOnIndicator:function(){return this.poolContainer.scrollTop=parseFloat(this.currentIndicator1.style.top)-130,this},setting:null,set:function(e){return this.selectedColor=e,$(this.setting).trigger("set",[e]),$(this.inputs.r).val(e.r),$(this.inputs.g).val(e.g),$(this.inputs.b).val(e.b),$(this.inputs.hex).val(e.hex)},selectColor:function(e){var t;return this.selected=(new J(e)).subtract(this.offset).subtract(new J(10,12)),this.selected.y+=this.poolContainer.scrollTop,t=this.getColorAt(this.selected),this.set(t),this.updateIndicator()},updateIndicator:function(){return this.selectedColor.toString()==="none"?(this.hideIndicator(this.currentIndicator1),this.hideIndicator(this.currentIndicator2)):(this.showIndicator(this.currentIndicator1),this.showIndicator(this.currentIndicator2),this.positionIndicator(this.currentIndicator1,this.selected),this.selected.y=(this.selected.y+1530)%3060,this.positionIndicator(this.currentIndicator2,this.selected),this)},showIndicator:function(e){return e.style.display="block"},hideIndicator:function(e){return e.style.display="none"},getColorAt:function(e){var t;return t=this.poolContext.getImageData(e.x,e.y,1,1),new u(t.data[0],t.data[1],t.data[2])},getPositionOf:function(e){var t,n,r,i,s;t=e.max(),n=e.mid(),r=e.min();switch(t){case e.r:s=0;switch(n){case e.g:s+=n;break;case e.b:s-=n}break;case e.g:s=510;switch(n){case e.b:s+=n;break;case e.r:s-=n}break;case e.b:s=1020;switch(n){case e.r:s+=n;break;case e.g:s-=n}}return s<0&&(s+=1530),s%=1530,i=260-e.lightness()*260,new J(i,s)},positionIndicator:function(e,t){return e.className=t.x<130?"indicator black":"indicator white",e.style.left=t.x.px(),e.style.top=t.y.px()},sample:function(e){return this.setting=ui.fill.rep,this.set(e.data.fill!=null?e.data.fill:ui.colors["null"]),this.setting=ui.stroke.rep,this.set(e.data.stroke!=null?e.data.stroke:ui.colors["null"])},drawPool:function(e){var t,n,r,i,s;e==null&&(e=1),n=this.poolContext.createLinearGradient(0,0,0,3060),t=[ui.colors.red,ui.colors.yellow,ui.colors.green,ui.colors.teal,ui.colors.blue,ui.colors.pink];for(r=s=0;s<=12;r=++s)n.addColorStop(1/12*r,t[r%6].clone().desaturate(1-e).toHexString());return this.poolContext.fillStyle=n,this.poolContext.fillRect(0,0,260,3060),i=this.poolContext.createLinearGradient(0,0,260,0),i.addColorStop(.02,"#FFFFFF"),i.addColorStop(.5,"rgba(255, 255, 255, 0.0)"),i.addColorStop(.5,"rgba(0, 0, 0, 0.0)"),i.addColorStop(.98,"#000000"),this.poolContext.fillStyle=i,this.poolContext.fillRect(0,0,260,3060)}}),ui.utilities.currentSwatches=new mt({setup:function(){var e=this;return this.$rep=$("#current-swatches-ut"),this.rep=this.$rep[0],ui.selection.elements.on("change",function(){e.generateSwatches();if(ui.selection.elements.empty())return e.clear();if(ui.selection.elements.all.length===1)return ui.utilities.color.sample(ui.selection.elements.all[0])})},shouldBeOpen:function(){return ui.selection.elements.all.length>0},clear:function(){return this.rep.innerHTML=""},generateSwatches:function(){var e,t,n,r,i;this.clear(),this.getSelectedSwatches();if(this.swatches.length===1)return ui.utilities.color.sample(ui.selection.elements.all[0]),this.clear();r=this.swatches,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],e.fill.equal(ui.fill)&&e.stroke.equal(ui.stroke)?i.push(this.$rep.prepend(e.rep)):i.push(this.$rep.append(e.rep));return i},getSelectedSwatches:function(){var e,t,n,r,i,s,o,u,a,f=this;this.swatches=[],this.swatchMap={},t=function(e,t){return f.swatchMap[e]!=null?f.swatchMap[e].push(t):f.swatchMap[e]=[t]},u=ui.selection.elements.all,a=[];for(s=0,o=u.length;s<o;s++)n=u[s],i=new ut(n),r=i.toString(),this.swatchMap[r]==null&&this.swatches.push(i),t(r,n),e=i.$rep,a.push(e.click(function(){return ui.selection.elements.select(ui.utilities.currentSwatches.swatchMap[this.getAttribute("key")])}).mouseover(function(e){var t,r,i,s;e.stopPropagation(),i=ui.utilities.currentSwatches.swatchMap[this.getAttribute("key")],s=[];for(t=0,r=i.length;t<r;t++)n=i[t],s.push(n.showPoints());return s}).mouseout(function(e){var t,r,i,s;i=ui.utilities.currentSwatches.swatchMap[this.getAttribute("key")],s=[];for(t=0,r=i.length;t<r;t++)n=i[t],s.push(n.removePoints().hidePoints());return s}));return a}}),ui.utilities.transform=new mt({setup:function(){var e=this;return this.rep=Gt("#transform-ut"),this.canvas=Gt("#transform-ut canvas#preview-canvas"),this.$canvas=$(this.canvas),this.origin=Gt("#transform-ut #origin-icon"),this.$origin=$(this.origin),this.widthBracket=Gt("#transform-ut #width-bracket"),this.$widthBracket=$(this.widthBracket),this.heightBracket=Gt("#transform-ut #height-bracket"),this.$heightBracket=$(this.heightBracket),this.outline=Gt("#transform-ut #subtle-blue-outline"),this.$outline=$(this.outline),this.inputs={originX:Gt("#transform-ut #origin-x-val"),originY:Gt("#transform-ut #origin-y-val"),width:Gt("#transform-ut #width-val"),height:Gt("#transform-ut #height-val")},this.context=this.canvas.getContext("2d"),this.widthControl=new B({rep:this.inputs.width,value:0,min:1e-5,places:5,commit:function(t){return e.alterVal("width",t)}}),this.heightControl=new B({rep:this.inputs.height,value:0,min:1e-5,places:5,commit:function(t){return e.alterVal("height",t)}}),this.originXControl=new B({rep:this.inputs.originX,value:0,commit:function(t){return e.alterVal("origin-x",t)}}),this.originYControl=new B({rep:this.inputs.originY,value:0,commit
:function(t){return e.alterVal("origin-y",t)}}),this.hide()},shouldBeOpen:function(){return ui.selection.elements.all.length>0},trueVals:{x:0,y:0,width:0,height:0},alterVal:function(e,t){var n,r,i;n=ui.transformer.tl;switch(e){case"width":return i=t/this.trueVals.width,i=i.ensureRealNumber(),ui.transformer.scale(i,1,n).redraw(),ui.selection.scale(i,1,n),archive.addMapEvent("scale",ui.selection.elements.zIndexes(),{x:i,y:1,origin:n}),this.trueVals.width=t;case"height":return i=t/this.trueVals.height,i=i.ensureRealNumber(),ui.transformer.scale(1,i,n).redraw(),ui.selection.scale(1,i,n),archive.addMapEvent("scale",ui.selection.elements.zIndexes(),{x:1,y:i,origin:n}),this.trueVals.height=t;case"origin-x":return r=t-this.trueVals.x,ui.selection.nudge(r,0),archive.addMapEvent("nudge",ui.selection.elements.zIndexes(),{x:r,y:0}),this.trueVals.x=t;case"origin-y":return r=t-this.trueVals.y,ui.selection.nudge(0,-r),archive.addMapEvent("nudge",ui.selection.elements.zIndexes(),{x:0,y:-r}),this.trueVals.y=t}},refresh:function(){var e;if(ui.selection.elements.empty())return;return e=ui.selection.elements.exportAsPNG({trim:!0}),this.drawPreview(e.maxDimension(105).exportAsDataURI()),e.destroy()},refreshValues:function(){if(!this.visible)return;return this.trueVals.x=ui.transformer.tl.x,this.trueVals.y=ui.transformer.tl.y,this.trueVals.width=ui.transformer.width,this.trueVals.height=ui.transformer.height,$(this.inputs.originX).val(this.trueVals.x.places(4)),$(this.inputs.originY).val(this.trueVals.y.places(4)),$(this.inputs.width).val(this.trueVals.width.places(4)),$(this.inputs.height).val(this.trueVals.height.places(4))},onshow:function(){return this.refreshValues()},clearPreview:function(){return this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.origin.style.display="none",this.widthBracket.style.display="none",this.heightBracket.style.display="none"},drawPreview:function(e,t){var n,r,i,s,o,u,a=this;return this.clearPreview(),e==="data:image/svg+xml;base64,"?this.hide():(this.show(),n=new Image,n.onload=function(){return a.context.drawImage(n,0,0)},n.src=e,u=ui.transformer.width+2,s=ui.transformer.height+2,this.refreshValues(),i=Math.min(105/u,105/s),o=(125-s*i)/2,r=(125-u*i)/2,this.$canvas.css({top:""+o+"px",left:""+r+"px"}).attr({height:s*i+2,width:u*i+2}),this.$origin.show().css({top:""+(Math.round(o)-3)+"px",left:""+(Math.round(r)-3)+"px"}),this.$widthBracket.show().css({left:""+Math.round(r)+"px",width:""+(u*i-2)+"px"}),this.$heightBracket.show().css({top:""+Math.round(o)+"px",height:""+(s*i-2)+"px"}),this.$outline.show().css({top:""+Math.round(o)+"px",left:""+Math.round(r)+"px",height:s*i-2,width:u*i-2}))}}),ui.utilities.strokeWidth=new mt({setup:function(){var e=this;return this.$rep=$("#stroke-width-ut"),this.rep=this.$rep[0],this.$preview=this.$rep.find("#stroke-width-preview"),this.$noStroke=this.$rep.find("#no-stroke-width-hint"),this.strokeControl=new B({rep:this.$rep.find("input")[0],value:1,min:0,max:100,places:2,commit:function(t){return e.alterVal(t),e.drawPreview()},onDone:function(){return archive.addAttrEvent(ui.selection.elements.zIndexes(),"stroke-width")}})},alterVal:function(e){var t,n,r,i;if(isNaN(e))return;e=Math.max(e,0).places(2),i=ui.selection.elements.all;for(n=0,r=i.length;n<r;n++){t=i[n],t.data["stroke-width"]=e;if(t.data.stroke==null||t.data.stroke.hex==="none")t.data.stroke=ui.colors.black;t.commit()}return this.drawPreview(),ui.uistate.set("strokeWidth",parseInt(e,10))},drawPreview:function(){var e;return e=Math.min(20,Math.max(0,this.strokeControl.value)),this.$preview.css({opacity:Math.min(e,1),height:""+Math.max(1,e)+"px",top:""+Math.ceil(30-Math.round(e/2))+"px"}),this.strokeControl.value===0?this.$noStroke.css("opacity","0.4"):this.$noStroke.css("opacity","0.0")},onshow:function(){return this.refresh()},refresh:function(){var e;return ui.selection.elements.all.length===1?(e=ui.selection.elements.all[0].data["stroke-width"],ui.uistate.set("strokeWidth",parseInt(e,10))):e=ui.uistate.get("strokeWidth"),e!=null?this.strokeControl.set(e):this.strokeControl.set(0),this.drawPreview()},shouldBeOpen:function(){return ui.selection.elements.all.length>0||[tools.pen,tools.line,tools.ellipse,tools.rectangle,tools.crayon,tools.type].has(ui.uistate.get("tool"))}}),nn.push(function(){return ui.utilities.strokeWidth.alterVal(1)}),ui.utilities.typography=new mt({setup:function(){var e=this;return this.$rep=$("#typography-ut"),this.rep=this.$rep[0],this.$faces=this.$rep.find("#font-faces-dropdown"),this.$size=this.$rep.find("#font-size-val"),this.sizeControl=new B({rep:this.$size[0],value:24,min:1,max:1e3,places:2,commit:function(t){return e.setSize(t)}}),this.faceControl=new v({options:this.faces,rep:this.$faces[0],callback:function(t){return e.setFace(t)}})},faces:function(){var e,t,n,r;n=["Arial","Arial Black","Cooper Black","Georgia","Monaco","Verdana","Impact","Gill Sans"],r=[];for(e=0,t=n.length;e<t;e++)Lt=n[e],r.push(new T(Lt));return r}(),setFace:function(e){return ui.selection.elements.ofType("text").map(function(t){return t.setFace(e),t.commit()}),ui.transformer.refresh()},setSize:function(e){return ui.selection.elements.ofType("text").map(function(t){return t.setSize(e),t.commit()}),ui.transformer.refresh()},refresh:function(){var e;return e=[],ui.selection.elements.ofType("text").map(function(t){var n;n=t.data["font-size"];if(!e.has(n))return e.push(n)}),e.length===1&&this.sizeControl.write(e[0]),this.faceControl.close()},onshow:function(){return this.refresh()},shouldBeOpen:function(){return ui.selection.elements.ofType("text").length>0||ui.uistate.get("tool")===tools.type}}),ui.utilities.history=new mt({setup:function(){var e=this;return this.$rep=$("#archive-ut"),this.rep=this.$rep[0],this.$container=$("#archive-thumbs"),this.container=this.$container[0],this.$controls=$("#archive-controls"),this.controls=this.$controls[0],this.stepsSlider=new it({rep:$("#archive-steps-slider")[0],commit:function(e){},valueTipFormatter:function(t){return""+(Math.round(e.maxSteps*t)+1)},onRelease:function(t){return e.build(Math.round(e.maxSteps*t)+1)},inverse:!0})},thumbsCache:{},deleteThumbsCached:function(e){var t,n,r,i,s,o;r=[],o=this.thumbsCache;for(t in o){if(!ln.call(o,t))continue;n=o[t],parseInt(t,10)>e&&r.push(t)}for(i=0,s=r.length;i<s;i++)t=r[i],delete this.thumbsCache[t];return this},shouldBeOpen:function(){return!1},open:function(){var e=this;return this.show(),this.shouldBeOpen=function(){return!0},St(function(){return e.build()})},close:function(){return this.$container.empty(),this.shouldBeOpen=function(){return!1},this.hide()},toggle:function(){return this.visible?this.close():this.open()},build:function(e){var t=this;return this.every=e,archive.events.length<3?(this.$controls.hide(),this.every=1,this.$container.html("<div empty>Make changes to this file to get a visual history of it.</div>")):(this.$controls.show(),this.maxSteps=Math.round(archive.events.length/4),this.every==null&&(this.every=Math.round(this.maxSteps/2),this.stepsSlider.write(.5)),this.$container.html("<div empty>Processing <br> file history... <br> <span percentage></span></div>"),St(function(){return t.buildThumbs(t.every)}))},buildThumbs:function(e,t){var n,r,i=this;return this.every=e,t==null&&(t=0),t<2&&this.$container.empty(),n=archive.currentPosition(),r=ui.selection.elements.zIndexes(),ui.canvas.petrify(),archive.simulating=!0,archive.goToEvent(t),this.thumbs=[],this._buildRecursive(archive.currentPosition(),this.every,function(){var e,s,o;archive.goToEvent(n),archive.simulating=!1,ui.canvas.depetrify(),ui.selection.elements.deselectAll();for(s=0,o=r.length;s<o;s++)e=r[s],ui.selection.elements.selectMore(en(e));return t===0&&i.$container.empty(),i.thumbs.map(function(e){return i.$container.prepend(e)}),i.refreshThumbs(archive.currentPosition())})},_buildRecursive:function(e,t,n){var r,i,s,o,u,a=this;return this.every=t,o=Math.min(Math.round(e/archive.events.length*100),100),this.$container.find("[percentage]").text(""+o+"%"),archive.goToEvent(e),this.thumbsCache[e]!=null?u=this.thumbsCache[e]:(i=Mt.makeFile(),u=Mt.makePNGURI(ui.elements,150),this.thumbsCache[e]=u),s=new Image,s.src=u,r=$('<div class="archive-thumb" position="'+e+'"></div>'),r.prepend(s),r.off("click").on("click",function(){var t;return t=$(this),e=parseInt(t.attr("position"),10),archive.goToEvent(e),ui.utilities.history.refreshThumbs.call(r,e)}),this.thumbs.push(r),St(function(){return e<archive.events.length-1?a._buildRecursive(Math.min(e+a.every,archive.events.length-1),a.every,n):n()})},refreshThumbs:function(e){return $(".archive-thumb").removeClass("future"),$(".archive-thumb").each(function(){var t;t=$(this);if(parseInt(t.attr("position"),10)>e)return t.addClass("future")})}}),window.tools={},ct=function(){function e(e){var t,n;for(t in e)n=e[t],this[t]=n}return e.prototype.tearDown=function(){},e.prototype.setup=function(){},e.prototype.activateModifier=function(e){},e.prototype.deactivateModifier=function(e){},e.prototype.followingAngle=!1,e.prototype.typeOf=function(e){return It(e)?"elem":_t(e)?"antlerPoint":jt(e)?"point":Ut(e)?"transformerHandle":Ht(e)?"hoverTarget":"background"},e.prototype.buildEvent=function(e){e.clientPosn=new J(e.clientX,e.clientY),e.canvasX=e.clientX-ui.canvas.normal.x,e.canvasY=e.clientY-ui.canvas.normal.y,e.canvasPosn=new J(e.canvasX,e.canvasY),e.canvasPosnZoomed=e.canvasPosn.clone().multiplyBy(1/ui.canvas.zoom),e.canvasX/=ui.canvas.zoom,e.canvasY/=ui.canvas.zoom,ui.grid.visible()&&(e=ui.snap.supplementForGrid(e)),ui.snap.supplementEvent!=null&&(e=ui.snap.supplementEvent(e)),e.modifierKeys=e.shiftKey||e.metaKey||e.ctrlKey||e.altKey,ui.cursor.lastPosn!=null&&(e.changeX=e.clientX-ui.cursor.lastPosn.x,e.changeY=-(e.clientY-ui.cursor.lastPosn.y),e.changeX/=ui.canvas.zoom,e.changeY/=ui.canvas.zoom,e.changeXSnapped=e.changeX+ui.cursor.snapChangeAccum.x,e.changeYSnapped=e.changeY+ui.cursor.snapChangeAccum.y),e.typeOfTarget=this.typeOf(e.target);switch(e.typeOfTarget){case"elem":e.elem=ui.queryElement(e.target);break;case"point":e.elem=Zt(e.target.getAttribute("owner")),e.point=e.elem.points.at(e.target.getAttribute("at"));break;case"antlerPoint":e.elem=Zt(e.target.getAttribute("owner")),e.point=e.elem.queryAntlerPoint(e.target);break;case"hoverTarget":e.elem=Zt(e.target.getAttribute("owner")),e.pointA=e.elem.points.at(parseInt(e.target.getAttribute("a"))),e.pointB=e.elem.points.at(parseInt(e.target.getAttribute("b"))),e.hoverTarget=e.pointB.hoverTarget}return e},e.prototype.dispatch=function(e,t){var n,r,i,s,o,u,a,f,l;e=this.buildEvent(e),n=[e];if(t==="startDrag"){a=ui.hotkeys.modifiersDown;for(o=0,u=a.length;o<u;o++)i=a[o],this.activateModifier(i);this.draggingType=e.typeOfTarget}t==="doubleclick"&&this.ignoreDoubleclick&&(t="click");if(this[t]!=null){if(this[t][e.typeOfTarget]!=null)return(f=this[t][e.typeOfTarget])!=null?f.apply(this,n):void 0;l=this[t];for(r in l){if(!ln.call(l,r))continue;s=l[r];if(r.mentions(e.typeOfTarget))return s.apply(this,n)}if(this[t].all!=null)return this[t].all.apply(this,n)}},e.prototype.recalculateLastDrag=function(){if(ui.cursor.dragging)return ui.cursor._mousemove(ui.cursor.lastEvent)},e}(),Vt={background:function(e){},elem:function(e){},point:function(e){},antlerPoint:function(e){},toolPlaceholder:function(e){},hoverTarget:function(e){}},ct.prototype.hover=Vt,ct.prototype.unhover=Vt,ct.prototype.click=Vt,ct.prototype.mousedown=Vt,ct.prototype.mouseup=Vt,ct.prototype.startDrag=Vt,ct.prototype.continueDrag=Vt,ct.prototype.stopDrag=Vt,tools.cursor=new ct({offsetX:1,offsetY:1,cssid:"cursor",id:"cursor",tearDown:function(){var e,t,n,r,i;r=ui.elements,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],ui.selection.elements.all.has(e)?i.push(void 0):i.push(e.hidePoints());return i},initialDragPosn:void 0,activateModifier:function(e){var t;switch(e){case"shift":switch(this.draggingType){case"elem":case"hoverTarget":case"point":return t=this.initialDragPosn,t!=null&&ui.snap.presets.every45(t),this.recalculateLastDrag()}break;case"alt":switch(this.draggingType){case"elem":return 3}}},deactivateModifier:function(e){switch(e){case"shift":switch(this.draggingType){case"elem":case"hoverTarget":return ui.snap.toNothing(),this.recalculateLastDrag()}break;case"alt":switch(this.draggingType){case"elem":return 3}}},hover:{background:function(e){var t,n,r,i;i=ui.elements;for(n=0,r=i.length;n<r;n++)t=i[n],typeof t.hidePoints=="function"&&t.hidePoints();return ui.unhighlightHoverTargets()},elem:function(e){return e.elem.hover()},point:function(e){if(!ui.selection.elements.all.has(e.elem))return e.elem.unhoverPoints(),e.elem.showPoints(),ui.unhighlightHoverTargets()},antlerPoint:function(e){},hoverTarget:function(e){if(!ui.selection.elements.all.has(e.elem))return e.elem.unhoverPoints(),e.elem.showPoints(),e.hoverTarget.highlight()}},unhover:{background:function(e){},elem:function(e){return e.elem.unhover()},point:function(e){return e.elem.hidePoints()},antlerPoint:function(e){},hoverTarget:function(e){return e.currentHover!==e.elem.rep&&(e.elem.unhoverPoints(),e.elem.hidePoints()),e.hoverTarget.unhighlight()}},click:{background:function(e){return e.modifierKeys||ui.selection.elements.deselectAll(),ui.selection.points.deselectAll()},elem:function(e){var t,n;return t=e.elem,n=ui.selection.elements.all.has(t),ui.selection.points.deselectAll(),e.shiftKey?n?(ui.selection.elements.deselect(t),t.showPoints(),t.hover()):t.group!=null?ui.selectMore(t.group.elements):(ui.selection.elements.selectMore(t),t.unhover(),t.removePoints()):n||(t.group!=null?(ui.selection.elements.select(t.group.elements),t.group.map(function(e){return e.removePoints()})):(ui.selection.elements.select(t),t.unhover(),t.removePoints())),ui.unhighlightHoverTargets()},point:function(e){return e.shiftKey?ui.selection.points.selectMore(e.point):ui.selection.points.select(e.point)},antlerPoint:function(e){},hoverTarget:function(e){return ui.selection.points.selectMore(e.hoverTarget.a),ui.selection.points.selectMore(e.hoverTarget.b)}},doubleclick:{elem:function(e){sn("Text","Doubleclick edit");if(e.elem instanceof at)return e.elem.selectAll()}},startDrag:{background:function(e){return ui.dragSelection.start(new J(e))},elem:function(e){var t,n,r,i;e.elem.unhover(),ui.selection.points.deselectAll(),ui.unhighlightHoverTargets(),ui.selection.elements.all.has(e.elem)||(e.elem.group!=null?ui.selection.elements.select(e.elem.group.elements):ui.selection.elements.select(e.elem)),i=ui.selection.elements.all;for(n=0,r=i.length;n<r;n++)t=i[n],t.removePoints();return ui.selection.elements.all.map(function(e){return e.commit()}),this.guidePointA=ui.transformer.center()},antlerPoint:function(e){},point:function(e){var t;(t=e.point.antlers)!=null&&t.show(),e.point.owner.removeHoverTargets(),ui.selection.points.select(e.point);if(ui.selection.elements.all.has(e.elem&&ui.hotkeys.modifiersDown.has("alt")))return e.elem.clone().appendTo("#main")},transformerHandle:function(e){},hoverTarget:function(e){if(!ui.selection.elements.all.has(e.elem))return e.hoverTarget.active(),ui.selection.elements.deselectAll(),ui.selection.points.deselectAll(),this.guidePointA=ui.transformer.center()}},snapChange:{x:0,y:0},changeAccum:{x:0,y:0},continueDrag:{background:function(e){return ui.dragSelection.move(new J(e.clientX,e.clientY))},elem:function(e){var t,n,r;e.elem.removePoints(),t=this.snapChange,t.x!==0&&t.y!==0&&ui.selection.nudge(-t.x,-t.y),ui.selection.nudge(e.changeX+this.changeAccum.x,e.changeY+this.changeAccum.y,!1);if(ui.grid.visible())return n=ui.transformer.bl,r=ui.snap.snapPointToGrid(n.clone()),this.snapChange={x:r.x-n.x,y:n.y-r.y},this.snapChange.x===-e.changeX?this.changeAccum.x+=e.changeX:this.changeAccum.x=0,this.snapChange.y===-e.changeY?this.changeAccum.y+=e.changeY:this.changeAccum.y=0,ui.selection.nudge(this.snapChange.x,this.snapChange.y,!1)},point:function(e){var t;return ui.selection.elements.all.has(e.elem)?this.continueDrag.elem(e):(e.point.nudge(e.changeX,e.changeY),(t=e.point.antlers)!=null&&t.refresh(),e.elem.woohoo(),e.elem.commit())},antlerPoint:function(e){return e.point.nudge(e.changeX,e.changeY),e.elem.commit()},transformerHandle:function(e){return ui.transformer.drag(e)},hoverTarget:function(e){return ui.selection.elements.all.has(e.elem)?this.continueDrag.elem.call(tools.cursor,e):e.hoverTarget.nudge(e.changeX,e.changeY)}},stopDrag:{background:function(e){return ui.dragSelection.end(function(e){return ui.selection.elements.selectWithinBounds(e)})},elem:function(e){var t,n,r,i,s;s=ui.selection.elements.all;for(r=0,i=s.length;r<i;r++)t=s[r],t.redrawHoverTargets(),t.commit();return n=(new J(e)).subtract(ui.cursor.lastDown),n.setZoom(ui.canvas.zoom),this.duping?archive.addExistenceEvent(this.duping.rep):archive.addMapEvent("nudge",ui.selection.elements.zIndexes(),{x:n.x,y:-n.y}),this.changeAccum={x:0,y:0}},point:function(e){var t;return e.elem.redrawHoverTargets(),e.elem.clearCachedObjects(),t=(new J(e)).subtract(ui.cursor.lastDown),t.setZoom(ui.canvas.zoom),archive.addMapEvent("nudge",ui.selection.points.zIndexes(),{x:t.x,y:-t.y})},antlerPoint:function(e){var t;return e.elem.redrawHoverTargets(),t=(new J(e)).subtract(ui.cursor.lastDown),t.setZoom(ui.canvas.zoom),archive.addMapEvent("nudge",ui.selection.points.zIndexes(),{x:t.x,y:-t.y,antler:e.point.role===-1?"p3":"p2"})},transformerHandle:function(e){var t,n,r,i;ui.utilities.transform.refresh(),i=ui.selection.elements.all;for(n=0,r=i.length;n<r;n++)t=i[n],t.redrawHoverTargets();return archive.addMapEvent("scale",ui.selection.elements.zIndexes(),{x:ui.transformer.accumX,y:ui.transformer.accumY,origin:ui.transformer.origin}),ui.transformer.resetAccum()},hoverTarget:function(e){var t,n,r;return e.elem.redrawHoverTargets(),e.elem.clearCachedObjects(),ui.selection.points.selectMore(e.hoverTarget.a),ui.selection.points.selectMore(e.hoverTarget.b),n=(new J(e)).subtract(ui.cursor.lastDown),t={},r=e.elem.zIndex(),t[r]=[],t[r].push(e.hoverTarget.a.at,e.hoverTarget.b.at),archive.addMapEvent("nudge",t,{x:n.x,y:-n.y})}}}),tools.paw=new ct({offsetX:8,offsetY:8,id:"paw",cssid:"paw",setup:function(){isNaN(ui.canvas.normal.x)&&(ui.canvas.normal.x=0);if(isNaN(ui.canvas.normal.y))return ui.canvas.normal.y=0},tearDown:function(){},continueDrag:{all:function(e){return ui.canvas.nudge(e.changeX*ui.canvas.zoom,e.changeY*ui.canvas.zoom)}},mousedown:{all:function(){return Ct.toolCursorPlaceholder.setAttribute("tool","paw-clutch")}},mouseup:{all:function(){return Ct.toolCursorPlaceholder.setAttribute("tool","paw")}}}),tools.pen=new ct({offsetX:5,offsetY:0,cssid:"pen",id:"pen",ignoreDoubleclick:!0,tearDown:function(){return this.drawing&&(ui.selection.elements.select(this.drawing),this.drawing.redrawHoverTargets(),this.drawing.points.map(function(e){return typeof e.hideHandles=="function"&&e.hideHandles(),e.hide()}),this.drawing=!1),this.clearPoints()},drawing:!1,firstPoint:null,lastPoint:null,currentPoint:null,clearPoints:function(){return this.firstPoint=null,this.currentPoint=null,this.lastPoint=null},beginNewShape:function(e){var t;return ui.uistate.get("strokeWidth")>0&&ui.stroke.toString()==="none"&&ui.stroke.absorb(ui.colors.black),t=new F({stroke:ui.stroke,fill:ui.fill,"stroke-width":ui.uistate.get("strokeWidth"),d:"M"+e.canvasX+","+e.canvasY}),t.appendTo("#main"),t.commit().showPoints(),archive.addExistenceEvent(t.rep),this.drawing=t,this.firstPoint=t.points.first,this.currentPoint=this.firstPoint},endShape:function(){return this.drawing.points.close().hide(),this.drawing.commit(),this.drawing.redrawHoverTargets(),this.drawing.points.first.antlers.basep3=null,this.drawing=!1,this.clearPoints()},addStraightPoint:function(e,t){var n,r,i,s;return n=this.drawing.points.last,i=n.antlers.succp2,((s=this.drawing.points.last.antlers)!=null?s.succp2:void 0)!=null?n instanceof c&&i.x!==n.x&&i.y!==n.y?r=new st(e,t,e,t,this.drawing,n):r=new h(n.antlers.succp2.x,n.antlers.succp2.y,e,t,e,t,this.drawing,n):r=new A(e,t,this.drawing),this.drawing.points.push(r),typeof n.hideHandles=="function"&&n.hideHandles(),this.drawing.hidePoints(),r.draw(),archive.addPointExistenceEvent(this.drawing.zIndex(),r),this.drawing.commit().showPoints(),this.currentPoint=r},addCurvePoint:function(e,t){var n,r,i,s,o;return i=e,s=t,n=this.drawing.points.last,typeof n.hideHandles=="function"&&n.hideHandles(),r=new h(n.x,n.y,e,t,e,t,this.drawing,this.drawing.points.last),this.drawing.points.push(r),((o=n.antlers)!=null?o.succp2:void 0)!=null&&(r.x2=r.prec.antlers.succp2.x,r.y2=r.prec.antlers.succp2.y),typeof n.hideHandles=="function"&&n.hideHandles(),this.drawing.hidePoints(),r.draw(),archive.addPointExistenceEvent(this.drawing.zIndex(),r),this.drawing.commit().showPoints(),this.currentPoint=r},updateCurvePoint:function(e){return this.currentPoint.antlers.importNewSuccp2(new J(e.canvasX,e.canvasY)),this.drawing.points.closed&&(this.currentPoint.antlers.show(),this.currentPoint.antlers.succp.persist()),this.currentPoint.antlers.lockAngle=!0,this.currentPoint.antlers.show(),this.currentPoint.antlers.refresh(),this.drawing.commit()},leaveShape:function(e){return this.drawing=!1},hover:{point:function(e){var t,n=this;if(this.drawing)switch(e.point){case this.lastPoint:return e.point.actionHint(),t=e.point.antlers.hideTemp(2),this.unhover.point=function(){return t(),e.point.hideActionHint(),n.unhover.point=function(){}};case this.firstPoint:return e.point.actionHint(),this.unhover.point=function(){return e.point.hideActionHint(),n.unhover.point=function(){}}}}},unhover:{},click:{background_elem:function(e){return this.drawing?this.addStraightPoint(e.canvasX,e.canvasY):this.beginNewShape(e)},point:function(e){switch(e.point){case this.lastPoint:return e.point.antlers.killSuccp2();case this.firstPoint:return this.drawing.points.close(),this.addStraightPoint(e.point.x,e.point.y),this.drawing.points.last.antlers.importNewSuccp2(this.drawing.points.first.antlers.succp2),this.drawing.points.last.antlers.lockAngle=!0,this.endShape();default:return this.click.background_elem.call(this,e)}}},mousedown:{all:function(){if(this.currentPoint!=null&&this.snapTo45)return ui.snap.presets.every45(this.currentPoint!=null?this.currentPoint:this.lastPoint,"canvas")}},activateModifier:function(e){switch(e){case"shift":this.snapTo45=!0;if(this.currentPoint!=null||this.lastPoint!=null)return ui.snap.presets.every45(this.currentPoint!=null?this.currentPoint:this.lastPoint,"canvas")}},deactivateModifier:function(e){switch(e){case"shift":return this.snapTo45=!1,ui.snap.toNothing()}},snapTo45:!1,startDrag:{point:function(e){return e.point===this.firstPoint?(this.drawing.points.close(),this.addCurvePoint(e.point.x,e.point.y)):this.startDrag.all(e)},all:function(e){return this.drawing?this.addCurvePoint(e.canvasX,e.canvasY):this.beginNewShape(e)}},continueDrag:{all:function(e,t){if(this.drawing)return this.updateCurvePoint(e)}},stopDrag:{all:function(e){return this.drawing.points.closed&&(this.currentPoint.deselect().hide(),this.endShape()),this.lastPoint=this.currentPoint,this.currentPoint=null}}}),tools.crayon=new ct({offsetX:5,offsetY:0,cssid:"crayon",id:"crayon",drawing:!1,setup:function(){},tearDown:function(){},frequency:0,eventCounter:0,alternatingCounter:2,beginNewLine:function(e){var t;return t=new F({stroke:ui.stroke,fill:ui.fill,"stroke-width":ui.uistate.get("strokeWidth"),d:"M"+e.canvasX+","+e.canvasY}),t.appendTo("#main"),t.commit().showPoints(),this.line=t,this.currentPoint=this.line.points.first},determineControlPoint:function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d;switch(e){case"p2":p=[this.lastPoint,this.currentPoint,this.stashed33],r=p[0],i=p[1],h=p[2];break;case"p3":d=[this.currentPoint,this.lastPoint,this.stashed66],r=d[0],i=d[1],h=d[2]}return f=new L(r,i),a=new L(r,h),u=f.angle360(),o=a.angle360(),t=o-u,n=u+t*2,l=f.length,c=l/3,s=new J(r),s.nudge(0,-c),s.rotate(n+180,r),isNaN(s.x)&&(s.x=i.x),isNaN(s.y)&&(s.y=i.y),s},stashedBaseP3:void 0,addPoint:function(e){switch(this.alternatingCounter){case 1:this.lastPoint=this.currentPoint,e!=null&&(this.currentPoint=new h(e.canvasX,e.canvasY,e.canvasX,e.canvasY,e.canvasX,e.canvasY,this.line)),this.alternatingCounter=2;if(this.stashed33==null)return;return this.lastPoint.antlers.succp2=this.determineControlPoint("p2"),this.currentPoint.antlers.basep3=this.determineControlPoint("p3"),this.lastPoint.succ=this.currentPoint,this.lastPoint.antlers.flatten(),this.lastPoint.antlers.commit(),this.currentPoint.antlers.commit(),this.line.points.push(this.currentPoint),this.currentPoint.draw(),this.line.points.hide(),this.line.commit();case 2:return this.stashed33=e.canvasPosnZoomed,this.alternatingCounter=3;case 3:return this.stashed66=e.canvasPosnZoomed,this.alternatingCounter=1}},click:{all:function(){}},startDrag:{all:function(e){return this.beginNewLine(e)}},continueDrag:{all:function(e){return this.eventCounter===this.frequency?(this.addPoint(e),this.eventCounter=0):this.eventCounter+=1}},stopDrag:{all:function(){return this.line.redrawHoverTargets(),archive.addExistenceEvent(this.line.rep),this.line=void 0}}}),tools.line=new ct({drawing:!1,cssid:"crosshair",id:"line",offsetX:7,offsetY:7,activateModifier:function(e){var t;switch(e){case"shift":t=this.initialDragPosn;if(t!=null)return ui.snap.presets.every45(t,"canvas")}},deactivateModifier:function(e){switch(e){case"shift":return ui.snap.toNothing()}},tearDown:function(){return this.drawing=!1},startDrag:{all:function(e){return this.beginNewLine(e),this.initialDragPosn=e.canvasPosnZoomed}},beginNewLine:function(e){var t;return t=e.canvasPosnZoomed,this.drawing=new F({stroke:ui.stroke,fill:ui.fill,"stroke-width":ui.uistate.get("strokeWidth"),d:"M"+e.canvasX+","+e.canvasY+" L"+e.canvasX+","+e.canvasY}),this.drawing.appendTo("#main"),this.drawing.commit()},continueDrag:{all:function(e){var t;return t=e.canvasPosnZoomed,this.drawing.points.last.x=t.x,this.drawing.points.last.y=t.y,this.drawing.commit()}},stopDrag:{all:function(){return this.drawing.redrawHoverTargets(),this.drawing.commit(),ui.selection.elements.select(this.drawing)}}}),n=function(e){function t(e){t.__super__.constructor.call(this,e)}return cn(t,e),t.prototype.drawing=!1,t.prototype.cssid="crosshair",t.prototype.offsetX=7,t.prototype.offsetY=7,t.prototype.ignoreDoubleclick=!0,t.prototype.started=null,t.prototype.template=null,t.prototype.tearDown=function(){return this.drawing=!1},t.prototype.startDrag={all:function(e){return this.started=e.canvasPosnZoomed,this.drawing=new F({stroke:ui.stroke.clone(),fill:ui.fill.clone(),"stroke-width":ui.uistate.get("strokeWidth"),d:this.template}),this.drawing.virgin=this.virgin(),this.drawing.hide(),this.drawing.appendTo("#main"),this.drawing.commit()}},t.prototype.continueDrag={all:function(e){var t;return t=new i(e.canvasPosnZoomed,this.started),e.shiftKey&&(t=new i(this.started,e.canvasPosnZoomed.squareUpAgainst(this.started))),e.altKey&&(t.centerOn(this.started),t.scale(2,2,this.started)),this.drawing.show(),this.drawing.fitToBounds(t),this.drawing.commit()}},t.prototype.stopDrag={all:function(){return this.drawing.cleanUpPoints(),archive.addExistenceEvent(this.drawing.rep),this.drawing.redrawHoverTargets(),ui.selection.elements.select(this.drawing),this.drawing=!1}},t}(ct),tools.ellipse=new n({id:"ellipse",template:"M0-0.1c0.055228,0,0.1,0.045,0.1,0.1S0.055,0.1,0,0.1S-0.1,0.055-0.1,0S-0.055-0.1,0-0.1z",virgin:function(){return new y({cx:0,cy:0,rx:.1,ry:.1})}}),tools.rectangle=new n({id:"rectangle",template:"M-0.1,-0.1 L0.1,-0.1 L0.1,0.1 L-0.1,0.1 L-0.1,-0.1z",virgin:function(){return new G({x:-0.1,y:-0.1,width:.2,height:.2})}}),tools.type=new ct({cssid:"type",id:"type",typingInto:void 0,tearDown:function(){return this.typingInto=void 0},addNode:function(e){return this.typingInto!=null?(this.typingInto.displayMode(),archive.addExistenceEvent(this.typingInto.rep),this.typingInto=void 0):(ui.selection.elements.deselectAll(),this.typingInto=new at({x:e.canvasPosnZoomed.x,y:e.canvasPosnZoomed.y,fill:ui.fill,stroke:ui.stroke}),this.typingInto.appendTo("#main"),this.typingInto.selectAll())},click:{elem:function(e){return e.elem.type==="text"?(e.elem.editableMode(),e.elem.textEditable.focus()):this.click.all.call(tools.type,e)},all:function(e){return this.addNode(e)}},startDrag:{elem:function(e){console.log(e.elem);if(e.elem.type==="text")return e.elem.editableMode(),e.elem.textEditable.focus()}},stopDrag:{all:function(e){var t;if(((t=e.elem)!=null?t.type:void 0)!=="text")return this.addNode(e)}}}),tools.rotate=new ct({cssid:"crosshair",id:"rotate",offsetX:7,offsetY:7,setup:function(){var e=this;return this.$rndo=$("#r-nd-o"),ui.transformer.onRotatingMode(),this.setCenter(ui.transformer.center()),ui.selection.elements.on("changed",function(){return e.$rndo.hide()})},tearDown:function(){return this.setCenter(void 0),ui.transformer.offRotatingMode()},lastAngle:void 0,setCenter:function(e){this.center=e;if(ui.selection.elements.all.length===0)return;return this.center!=null?this.$rndo.show().css({left:(this.center.x-6).px(),top:(this.center.y-6).px()}):this.$rndo.hide()},click:{all:function(e){return this.setCenter(new J(e.canvasX,e.canvasY))}},startDrag:{all:function(e){return this.center===void 0&&this.setCenter(ui.transformer.center()),this.lastAngle=new J(e.canvasX,e.canvasY)}},continueDrag:{all:function(e){var t,n;return n=(new J(e.canvasX,e.canvasY)).angle360(this.center),t=n-this.lastAngle,isNaN(t)||ui.selection.rotate(t,this.center),this.lastAngle=n}},stopDrag:{all:function(e){return this.lastAngle=void 0,ui.selection.elements.all.map(function(e){return e.redrawHoverTargets()}),archive.addMapEvent("rotate",ui.selection.elements.zIndexes(),{angle:ui.transformer.accumA,origin:ui.transformer.origin}),ui.transformer.resetAccum()}}}),tools.zoom=new ct({offsetX:5,offsetY:5,cssid:"zoom",id:"zoom",ignoreDoubleclick:!0,click:{all:function(e){return ui.hotkeys.modifiersDown.has("alt")?ui.canvas.zoomOut():ui.canvas.zoomIn(),ui.window.centerOn(new J(e.canvasX,e.canvasY)),ui.refreshAfterZoom()}},startDrag:{all:function(e){return ui.dragSelection.start(new J(e))}},continueDrag:{all:function(e){return ui.dragSelection.move(new J(e))}},stopDrag:{all:function(){var e,t,n,r,i;ui.dragSelection.end(function(e){return ui.canvas.zoomToFit(e)}),r=ui.elements,i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(e.refreshUI());return i}}}),tools.eyedropper=new ct({offsetX:1,offsetY:15,cssid:"eyedropper",id:"eyedropper",click:{elem_hoverTarget_point:function(e){var t,n,r,i,s;ui.utilities.color.sample(e.elem),i=ui.selection.elements.all,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],s.push(t.eyedropper(e.elem));return s},background:function(e){var t,n,r,i,s;i=ui.selection.elements.all,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],t.data.fill=ui.colors.white,t.data.stroke=ui.colors["null"],s.push(t.commit());return s}}}),window.services={},nt=function(){function e(e){var t,n,r=this;for(t in e){if(!ln.call(e,t))continue;n=e[t],this[t]=n}this.setup!=null&&nn.push(function(){return r.setup()})}return e.prototype.fileSystem={contents:{},is_dir:!0,path:"/"},e.prototype.open=function(){return ui.gallery.open(this)},e.prototype.getSVGs=function(e){var t=this;return $.ajax({url:""+Z.MEOWSET.ENDPOINT+"/"+this.module+"/svgs",type:"GET",dataType:"json",data:{session_token:ui.account.session_token},success:function(n){return e(n.map(function(e){var n;return n=(new S).fromService(t)(e.key),n.modified=e.last_modified,n.thumbnail=e.thumbnail,n}))}})},e.prototype.getSaveLocations=function(e,t){var n,r,i,s,o,u,a,f;o=e.split("/").slice(1),u=this.fileSystem.contents;if(o[0]!=="")for(a=0,f=o.length;a<f;a++){r=o[a],r=o[0];if(u[r]!=null){u=u[r].contents;if(Object.keys(u).length===0)break;o=o.slice(1)}}return o.length===0?(u.empty?(s=[],i=[]):(n=$t(u),s=n.filter(function(e){return e.is_dir}),i=n.filter(function(e){return!e.is_dir})),t(s,i)):$.ajax({url:""+Z.MEOWSET.ENDPOINT+"/"+this.module+"/metadata",type:"GET",dataType:"json",data:{session_token:ui.account.session_token,path:e,pluck:"save_locations",contentsonly:!0},success:function(e){var n,r,o,a,f,l;s=e.filter(function(e){return e.is_dir}),i=e.filter(function(e){return!e.is_dir});if(s.length+i.length===0)u.empty=!0;else for(o=0,f=s.length;o<f;o++)r=s[o],u[r.path.match(/\/[^\/]*$/)[0].substring(1)]={contents:{},is_dir:!0,path:""+r.path};for(a=0,l=i.length;a<l;a++)n=i[a],u[n.path.match(/\/[^\/]*$/)[0].substring(1)]={is_dir:!1,path:""+n.path};return t(s,i)}})},e.prototype.get=function(e,t){return $.ajax({url:""+Z.MEOWSET.ENDPOINT+"/"+this.module+"/get",type:"GET",dataType:"json",data:{session_token:ui.account.session_token,path:e},success:function(e){return t(e)}})},e.prototype.put=function(e,t,n){return n==null&&(n=function(){}),$.ajax({url:""+Z.MEOWSET.ENDPOINT+"/"+this.module+"/put",type:"POST",dataType:"json",data:{contents:t,session_token:ui.account.session_token,fn:e},success:function(e){return n(e)}})},e.prototype.contents=
function(e,t){return t==null&&(t=function(){}),$.ajax({url:""+Z.MEOWSET.ENDPOINT+"/"+this.module+"/metadata",type:"GET",dataType:"json",data:{contentsonly:!0,session_token:ui.account.session_token,path:e},success:function(e){return t(e)}})},e.prototype.defaultName=function(e,t){return t==null&&(t=function(){}),$.ajax({url:""+Z.MEOWSET.ENDPOINT+"/"+this.module+"/default-name",type:"GET",dataType:"json",data:{session_token:ui.account.session_token,path:e},success:function(e){return t(e.name)}})},e.prototype.putHistory=function(e,t,n){return n==null&&(n=function(){}),$.ajax({url:""+Z.MEOWSET.ENDPOINT+"/"+this.module+"/put-history",type:"POST",dataType:"json",data:{contents:t,session_token:ui.account.session_token,fn:e},success:function(e){return n(e)}})},e}(),services.local=new nt({name:"local",setup:function(){var e,t,n,r;if(localStorage.getItem("local-files")===null){localStorage.setItem("local-files","[]"),localStorage.removeItem("file-content"),localStorage.removeItem("file-metadata"),r=[];for(n in Nt)e=Nt[n],r.push(t=(new O(""+n+".svg")).set(e).put());return r}},activate:function(){},lastKey:void 0,getSVGs:function(e){var t,n,r,i,s;e==null&&(e=function(){}),t=[],s=this.files();for(r=0,i=s.length;r<i;r++)n=s[r],t.push(new O(n));return e(t)},getSaveLocations:function(e,t){return t==null&&(t=function(){}),t({},this.files().map(function(e){return{path:"/"+e}}))},get:function(e,t){var n,r;r=localStorage.getItem("local-"+e),n=localStorage.getItem("local-"+e+"-archive");if(r!==null)return t({contents:r,archive:n})},put:function(e,t,n){var r;return e==null&&(e=ui.file.name),t==null&&(t=Mt.makeFile()),n==null&&(n=function(){}),e=e.replace(/^\//gi,""),localStorage.setItem("local-"+e,t),localStorage.setItem("local-"+e+"-archive",archive.toString()),r=this.files(),r.has(e)||r.push(e),this.files(r),n()},"delete":function(e){var t;return localStorage.removeItem("local-"+e),localStorage.removeItem("local-"+e+"-archive"),t=this.files(),t=t.remove(e),this.files(t)},deleteAll:function(){var e=this;return this.files().map(function(t){return e["delete"](t)})},files:function(e){return e!=null?(localStorage.setItem("local-files",JSON.stringify(e)),e):JSON.parse(localStorage.getItem("local-files"))},nextDefaultName:function(){var e,t,n,r;e=this.files(),n=e.filter(function(e){return e.substring(0,9)==="untitled-"}),t=n.map(function(e){return e.match(/\d+/gi)[0]}).map(function(e){return parseInt(e,10)});if(n.length===0&&!e.has("untitled.svg"))return"untitled.svg";r=1;for(;;){if(!t.has(r))return"untitled-"+r+".svg";r+=1}},clearAllLocalHistory:function(){var e,t,n,r,i;r=this.files(),i=[];for(t=0,n=r.length;t<n;t++)e=r[t],i.push(localStorage.removeItem("local-"+e+"-archive"));return i}}),nn.push(function(){return services.local.setup()}),services.permalink=new nt({name:"permalink",open:function(){return services.local.open()},get:function(e,t){return $.getJSON(""+Z.MEOWSET.ENDPOINT+"/files/permalinks/get",{public_key:e},function(n){return t({contents:n.content,file_name:n.file_name,readonly:n.readonly}),sn("Permalinks","Open",e)})},put:function(e,t,n,r){var i,s;return e==null&&(e=void 0),t==null&&(t=Mt.makeFile()),n==null&&(n=function(){}),r==null&&(r=""),s=Mt.makePNGURI(ui.elements,400),i={file_name:ui.file.name,svg:t,thumb:s,emails:r},e!=null&&(i.public_key=e),ui.account.session_token!=null&&(i.session_token=ui.account.session_token),$.ajax({url:""+Z.MEOWSET.ENDPOINT+"/files/permalinks/put",type:"POST",dataType:"json",data:i,success:function(t){if(e==null){(new I(t.public_key)).use();switch(e){case"":sn("Permalinks","Create",t.public_key);break;default:sn("Permalinks","Save",t.public_key)}}else console.log("saved");return typeof n=="function"?n():void 0}})}}),services.dropbox=new nt({name:"Dropbox",module:"poletto",tease:function(){return ui.menu.items.dropboxConnect.show()},activate:function(){ui.menu.items.dropboxConnect.hide();if(!ui.account.services.has("dropbox"))return ui.account.services.push("dropbox")},disable:function(){return ui.menu.items.dropboxConnect.disable()},enable:function(){return ui.menu.items.dropboxConnect.enable()}}),wt={uiMainColor:"#4982E0",drawLine:function(e,t,n){var r;n==null&&(n=this.uiMainColor);if(!Ct.main)return;return r=new k({x1:e.x,y1:e.y,x2:t.x,y2:t.y,fill:"none",stroke:n}),r.commit(),r.appendTo("svg#annotations",!1),r},drawDot:function(e,t,n){var r;t==null&&(t=this.uiMainColor),n==null&&(n=3);if(!Ct.main)return;return r=new o({cx:e.x,cy:e.y,r:n,fill:t,stroke:"none"}),r.commit(),r.appendTo("svg#annotations",!1),r},drawDots:function(e,t,n){var r=this;return e.forEach(function(e){return r.drawDot(e,t,n)})},clear:function(){return $("#annotations").empty()}},ui.annotations=wt,At={frequency:{x:20,y:20},dots:[],posns:[],visible:function(){return this.dots.length},toggle:function(){return this.visible()?this.clear():this.draw()},clear:function(){return Ct.$grid.empty(),this.dots=null,this.dots=[]},draw:function(){var e,t,n,r,i,s,o,u,a,f,l,c=this;this.clear(),a=[ui.canvas.width,ui.canvas.height],r=a[0],t=a[1];for(s=o=0,f=t/this.frequency.y;0<=f?o<=f:o>=f;s=0<=f?++o:--o)for(i=u=0,l=r/this.frequency.x;0<=l?u<=l:u>=l;i=0<=l?++u:--u)n=new J(i*this.frequency.x,s*this.frequency.y),e=this.dot(n),e.appendTo("svg#grid",!1),this.dots.push(e),this.posns.push(n);return St(function(){return c.refreshRadii()})},dot:function(e){return new o({cx:e.x,cy:e.y,r:1,dontTrack:!0,fill:new u(0,0,0,.6),stroke:"none"})},refreshRadii:function(){if(!this.visible())return;return Ct.$grid.hide(),this.dots.map(function(e){return e.attr({r:1/ui.canvas.zoom}),e.commit()}),Ct.$grid.show()}},ui.grid=At,ui.account={email:"",session_token:"",services:["local"],valueOf:function(){return this.email||"anon"},uiAnonymous:function(){return services.dropbox.tease().disable(),ui.menu.items.shareAsLink.enable(),ui.menu.items.downloadSVG.enable(),ui.menu.menus.login.show(),ui.menu.menus.register.show()},uiLoggedIn:function(){return services.dropbox.tease().enable(),ui.menu.items.shareAsLink.enable(),ui.menu.items.downloadSVG.enable(),ui.menu.menus.login.groupHide(),ui.menu.menus.account.text(this.email).groupShow()},checkSession:function(){var e=this;return this.session_token=localStorage.getItem("session_token"),this.session_token?$.ajax({url:""+Z.MEOWSET.ENDPOINT+"/user/persist-session",type:"POST",dataType:"json",data:{session_token:this.session_token},success:function(t){return t.anon!=null?e.uiAnonymous():e.processLogin(t),sn("User","Persist session")},error:function(){return e.uiAnonymous()}}):this.uiAnonymous()},login:function(e,t){var n=this;return $("#login-mg input").each(function(){return $(this).disable()}),$.ajax({url:""+Z.MEOWSET.ENDPOINT+"/user/login",type:"POST",dataType:"json",data:{email:e,passwd:t},success:function(e){return n.processLogin(e),(e.trial_remaining!=null)>0&&ui.menu.menus.account.openDropdown(),$("#login-mg input").each(function(){return $(this).enable()}),sn("User","Login")},error:function(e){return e=JSON.parse(e.responseText),$("#submit-login").error(e.error),sn("User","Login error",e.error)},complete:function(){return $("#login-mg input").each(function(){return $(this).enable()})}})},processLogin:function(e){var t,n,r,i,s;$.extend(this,e),localStorage.setItem("session_token",this.session_token),ui.menu.menus.login.groupHide(),ui.menu.menus.register.groupHide(),ui.menu.menus.account.show().text(this.email),ui.menu.closeAllDropdowns(),this.uiLoggedIn();if(e.services!=null){i=e.services,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],s.push(services[t].activate());return s}return services.dropbox.tease()},logout:function(){var e=this;return $.ajax({url:""+Z.MEOWSET.ENDPOINT+"/user/logout",type:"POST",dataType:"json",data:{session_token:this.session_token},success:function(t){return e.session_token=void 0,localStorage.removeItem("session_token"),sn("User","Logout"),e.uiAnonymous(),ui.menu.menus.account.groupHide(),ui.menu.menus.login.groupShow(),ui.menu.menus.register.groupShow()}})},checkServices:function(){return $.getJSON(""+Z.MEOWSET.ENDPOINT+"/user/check-services",{session_token:this.session_token},function(e){if(e.dropbox)return services.dropbox.activate()})},create:function(e,t,n){var r=this;return $.ajax({url:""+Z.MEOWSET.ENDPOINT+"/user/register",type:"POST",dataType:"json",data:{name:e,email:t,passwd:n},success:function(i){return sn("User","Create","("+e+" , "+t+")"),r.login(t,n),ui.menu.closeAllDropdowns()},error:function(e){return e=JSON.parse(e.responseText),$("#submit-registration").error(e.error)}})}},nn.push(function(){return ui.account.checkSession(),ui.refreshUtilities()}),on={actions:{p:function(e){return ui.canvas.hide(),services.permalink.get(e,function(t){var n;return ui.canvas.show(),Mt.parseAndAppend(t.contents),n=new I(e),n.use(),n.readonly=t.readonly,ui.canvas.centerOn(ui.window.center())})},url:function(e){return ui.menu.items.openURL.openURL(e)}},parse:function(){var e,t,n,r,i,s,o,u,a;r=document.location.search.replace(/\/$/,""),n=r.substring(1).split("&"),a=[];for(o=0,u=n.length;o<u;o++)t=n[o],t=t.split("="),e=t[0],i=t[1],a.push(typeof (s=this.actions)[e]=="function"?s[e](i):void 0);return a}},nn.push(function(){return on.parse()}),ui.browserFile={save:function(e){e==null&&(e=!1);if(ui.afk.active&&!e)return;ui.file==null&&(new O(services.local.nextDefaultName())).use();if(ui.file.service===services.permalink)return;return localStorage.setItem("file-metadata",ui.file.toString()),localStorage.setItem("file-content",Mt.makeFile()),localStorage.setItem("file-archive",archive.toString())},load:function(){var e,t,n,r;t=localStorage.getItem("file-content"),e=localStorage.getItem("file-archive");if(t==null)return(new O(services.local.nextDefaultName())).use(),ui.file.save();Mt.parseAndAppend(localStorage.getItem("file-content")),n=JSON.parse(localStorage.getItem("file-metadata"))||{},n.name==null&&(n.name="untitled.svg"),r=n.service.toLowerCase(),(new S).fromService(services[r])(n.key).use();if(e!=null)return archive.loadFromString(e,!1)}},nn.push(function(){return ui.file==null&&ui.browserFile.load(),setInterval(function(){return ui.browserFile.save()},1e3)})}).call(this);